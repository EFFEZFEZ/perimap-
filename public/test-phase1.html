<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 1 - Test EventBus, StateManager, Logger</title>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #ddd; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #333; }
        .pass { background: #1a3a1a; border-color: #22c55e; color: #22c55e; }
        .fail { background: #3a1a1a; border-color: #ef4444; color: #ef4444; }
        .info { background: #1a2a3a; border-color: #0ea5e9; color: #0ea5e9; }
        pre { overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Phase 1 - Tests des fichiers core</h1>
    <div id="results"></div>

    <script type="module">
        import { EventBus, eventBus } from './js/EventBus.js';
        import { StateManager, stateManager } from './js/StateManager.js';
        import { Logger, logger } from './js/Logger.js';

        const results = document.getElementById('results');
        let testsPassed = 0;
        let testsFailed = 0;

        function addTest(name, passed, details = '') {
            const test = document.createElement('div');
            test.className = `test ${passed ? 'pass' : 'fail'}`;
            const symbol = passed ? 'âœ…' : 'âŒ';
            test.innerHTML = `${symbol} <strong>${name}</strong>${details ? '<pre>' + details + '</pre>' : ''}`;
            results.appendChild(test);
            if (passed) testsPassed++;
            else testsFailed++;
        }

        try {
            // === Tests EventBus ===
            console.log('Testing EventBus...');
            
            const bus = new EventBus();
            let eventFired = false;
            let eventData = null;

            bus.on('test-event', (data) => {
                eventFired = true;
                eventData = data;
            });

            bus.emit('test-event', { message: 'Hello' });
            addTest('EventBus - emit/on', eventFired && eventData.message === 'Hello');

            // Test once
            let onceCount = 0;
            bus.once('once-event', () => { onceCount++; });
            bus.emit('once-event');
            bus.emit('once-event');
            addTest('EventBus - once', onceCount === 1);

            // Test off
            const handler = () => {};
            bus.on('remove-test', handler);
            bus.off('remove-test', handler);
            addTest('EventBus - off', bus.listenerCount('remove-test') === 0);

            // === Tests StateManager ===
            console.log('Testing StateManager...');

            const state = new StateManager({ counter: 0, user: { name: 'Test' } });
            
            addTest('StateManager - getState', state.getState().counter === 0);
            
            state.setState({ counter: 5 });
            addTest('StateManager - setState', state.getState().counter === 5);

            // Test subscriber
            let subscribed = false;
            state.subscribe((change) => {
                subscribed = true;
            });
            state.setState({ counter: 10 });
            addTest('StateManager - subscribe', subscribed);

            // Test getStateValue
            const value = state.getStateValue('user.name');
            addTest('StateManager - getStateValue', value === 'Test');

            // Test undo/redo
            state.setState({ counter: 20 });
            state.undo();
            addTest('StateManager - undo', state.getState().counter === 10);
            state.redo();
            addTest('StateManager - redo', state.getState().counter === 20);

            // === Tests Logger ===
            console.log('Testing Logger...');

            const log = new Logger({ isDev: true });
            
            log.info('Test info');
            const logs = log.getLogs('INFO');
            addTest('Logger - info', logs.length > 0 && logs[logs.length - 1].level === 'INFO');

            log.error('Test error', new Error('Test'));
            const errorLogs = log.getLogs('ERROR');
            addTest('Logger - error', errorLogs.length > 0 && errorLogs[errorLogs.length - 1].level === 'ERROR');

            // === Exports globaux ===
            console.log('Testing global instances...');
            
            addTest('eventBus global', typeof eventBus !== 'undefined');
            addTest('stateManager global', typeof stateManager !== 'undefined');
            addTest('logger global', typeof logger !== 'undefined');

            // === RÃ©sumÃ© ===
            const summary = document.createElement('div');
            summary.className = 'test info';
            summary.innerHTML = `<strong>ğŸ“Š RÃ©sumÃ©</strong><br>
                RÃ©ussis: <strong style="color: #22c55e">${testsPassed}</strong><br>
                Ã‰chouÃ©s: <strong style="color: #ef4444">${testsFailed}</strong><br>
                Total: ${testsPassed + testsFailed}`;
            results.appendChild(summary);

            if (testsFailed === 0) {
                console.log('âœ… Tous les tests sont passÃ©s!');
                addTest('ğŸ‰ PHASE 1 COMPLÃˆTE', true, 'EventBus, StateManager et Logger fonctionnent correctement');
            } else {
                console.error('âŒ Certains tests ont Ã©chouÃ©');
            }

        } catch (error) {
            console.error('Error during testing:', error);
            addTest('Erreur gÃ©nÃ©rale', false, error.message + '\n' + error.stack);
        }
    </script>
</body>
</html>
