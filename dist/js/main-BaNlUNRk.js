import"./chunks/modulepreload-polyfill-YP0FEG5d.js";/* empty css                     */const e=[{url:"/views/hall.html",target:"#app-view-root"},{url:"/views/horaires.html",target:"#dashboard-content-view .content-cards"},{url:"/views/trafic.html",target:"#dashboard-content-view .content-cards"},{url:"/views/carte.html",target:"#app-view-root"},{url:"/views/itineraire.html",target:"#app-view-root"}];async function t({url:e,target:t,position:o="beforeend"}){const r=await fetch(e,{credentials:"same-origin"});if(!r.ok)throw new Error(`Impossible de charger le fragment ${e} (${r.status})`);const s=document.querySelector(t);if(!s)throw new Error(`Impossible de trouver la cible ${t} pour le fragment ${e}`);const n=await r.text();s.insertAdjacentHTML(o,n.trim())}async function o(){try{for(const o of e)await t(o)}catch(o){console.error("[viewLoader] Chargement de layout impossible",o);const e=document.querySelector("#app-view-root");throw e&&(e.innerHTML=`\n                <section class="card error-card">\n                    <h3>Chargement impossible</h3>\n                    <p>Un probleme empeche l'interface de se charger. Merci de recharger la page.</p>\n                    <pre>${o.message}</pre>\n                </section>\n            `),o}}const r={},s=function(e,t,o){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const e=document.querySelector("meta[property=csp-nonce]"),o=(null==e?void 0:e.nonce)||(null==e?void 0:e.getAttribute("nonce"));s=Promise.allSettled(t.map(e=>{if((e=function(e){return"/"+e}(e))in r)return;r[e]=!0;const t=e.endsWith(".css"),s=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${s}`))return;const n=document.createElement("link");return n.rel=t?"stylesheet":"modulepreload",t||(n.as="script"),n.crossOrigin="",n.href=e,o&&n.setAttribute("nonce",o),document.head.appendChild(n),t?new Promise((t,o)=>{n.addEventListener("load",t),n.addEventListener("error",()=>o(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function n(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return s.then(t=>{for(const e of t||[])"rejected"===e.status&&n(e.reason);return e().catch(n)})},n={routes:[],trips:[],stopTimes:[],stops:[],calendar:[],calendarDates:[],shapes:[],geoJson:null};function a(e={}){const t={};return Object.keys(e).forEach(o=>{var r;t[o]="string"!=typeof(r=e[o])?r:r.replace(/^["']|["']$/g,"").trim()}),t}function i(e={}){const t={},o={},r={},s={},n={},a={},i={},l={},c=e.routes||[],d=e.trips||[],u=e.stopTimes||[],p=e.stops||[],h=e.shapes||[];c.forEach(e=>{t[e.route_id]=e,e.route_short_name&&(o[e.route_short_name]=e)}),p.forEach(e=>{r[e.stop_id]=e;const t=function(e){if(!e)return"";return e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]/g,"").trim()}(e.stop_name);s[t]||(s[t]=[]),s[t].push(e)}),u.forEach(e=>{i[e.trip_id]||(i[e.trip_id]=[]),i[e.trip_id].push(e)}),Object.keys(i).forEach(e=>{i[e].sort((e,t)=>parseInt(e.stop_sequence,10)-parseInt(t.stop_sequence,10))}),d.forEach(e=>{a[e.trip_id]=e,n[e.route_id]||(n[e.route_id]=[]),n[e.route_id].push(e)});const{masterStops:m,groupedStopMap:g}=function(e=[]){const t=[],o={},r=new Set;return e.forEach(e=>{e.parent_station&&""!==e.parent_station.trim()&&r.add(e.stop_id)}),e.forEach(e=>{if("1"===e.location_type)t.push(e),o[e.stop_id]||(o[e.stop_id]=[]),o[e.stop_id].push(e.stop_id);else if(e.parent_station&&""!==e.parent_station.trim()){const t=e.parent_station;o[t]||(o[t]=[]),o[t].push(e.stop_id)}else"1"===e.location_type||r.has(e.stop_id)||e.parent_station&&""!==e.parent_station.trim()||(t.push(e),o[e.stop_id]=[e.stop_id])}),{masterStops:t,groupedStopMap:o}}(p),f=function(e=[]){const t={};return e.forEach(e=>{t[e.stop_id]||(t[e.stop_id]=[]),t[e.stop_id].push(e)}),t}(u);return h.forEach(e=>{if(!e||!e.shape_id)return;const t=e.shape_id;l[t]||(l[t]=[]);const o=parseInt(e.shape_pt_sequence,10)||0,r=parseFloat(e.shape_pt_lat),s=parseFloat(e.shape_pt_lon);Number.isNaN(r)||Number.isNaN(s)||l[t].push({seq:o,coord:[s,r]})}),Object.keys(l).forEach(e=>{l[e].sort((e,t)=>e.seq-t.seq),l[e]=l[e].map(e=>e.coord)}),{routesById:t,routesByShortName:o,stopsById:r,stopsByName:s,tripsByRoute:n,tripsByTripId:a,stopTimesByTrip:i,stopTimesByStop:f,groupedStopMap:g,masterStops:m,shapesById:l}}const l="stopTimesByTrip";class c{constructor(e=300){this.maxCacheEntries=e,this.cache=new Map,this.dbPromise=null}hasIndexedDb(){return"undefined"!=typeof indexedDB}async getDb(){return this.dbPromise?this.dbPromise:this.hasIndexedDb()?(this.dbPromise=new Promise((e,t)=>{const o=indexedDB.open("peribus_stop_times_store",1);o.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(l)||t.createObjectStore(l)},o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)}).catch(e=>(console.warn("StopTimesStore: IndexedDB indisponible",e),null)),this.dbPromise):(this.dbPromise=Promise.resolve(null),this.dbPromise)}async seedFromTripMap(e={}){const t=Object.entries(e);if(!t.length)return;const o=await this.getDb();o?(await new Promise((e,r)=>{const s=o.transaction(l,"readwrite"),n=s.objectStore(l);t.forEach(([e,t])=>{n.put(t,e)}),s.oncomplete=()=>e(),s.onerror=()=>r(s.error)}).catch(e=>{console.warn("StopTimesStore: √©criture IndexedDB impossible",e)}),this.cacheFromEntries(t)):this.cacheFromEntries(t)}cacheFromEntries(e){Array.isArray(e)&&e.slice(0,this.maxCacheEntries).forEach(([e,t])=>{this.setCache(e,t)})}setCache(e,t){if(this.cache.has(e))this.cache.delete(e);else if(this.cache.size>=this.maxCacheEntries){const e=this.cache.keys().next().value;e&&this.cache.delete(e)}this.cache.set(e,t)}touch(e){if(!this.cache.has(e))return;const t=this.cache.get(e);this.cache.delete(e),this.cache.set(e,t)}getCached(e){const t=this.cache.get(e);return t&&this.touch(e),t||null}async get(e){const t=this.getCached(e);if(t)return t;const o=await this.getDb();if(!o)return null;const r=await new Promise((t,r)=>{const s=o.transaction(l,"readonly").objectStore(l).get(e);s.onsuccess=()=>t(s.result||null),s.onerror=()=>r(s.error)}).catch(e=>(console.warn("StopTimesStore: lecture IndexedDB impossible",e),null));return r&&this.setCache(e,r),r}}function d(e){if(null==e)return!1;const t=String(e).trim();return!!t&&("--:--"!==t&&"~"!==t)}function u(e,t){if(!Array.isArray(e)||0===e.length)return!1;if(!t)return!1;const o=e[e.length-1];return Boolean(o&&o.stop_id===t)}const p="datasets",h="undefined"!=typeof requestIdleCallback?requestIdleCallback:e=>setTimeout(e,1);class m{constructor(){this.routes=[],this.trips=[],this.stopTimes=[],this.stops=[],this.geoJson=null,this.isLoaded=!1,this.calendar=[],this.calendarDates=[],this.shapes=[],this.routeGeometriesById={},this._shapesIndexPromise=null,this.remoteGtfsBaseUrl="https://raw.githubusercontent.com/EFFEZFEZ/p-rimap-sans-api-/main/public/data/gtfs",this.masterStops=[],this.groupedStopMap={},this.stopTimesByStop={},this.tripsByTripId={},this.stopTimesByTrip={},this.shapesById={},this.routesById={},this.stopsById={},this.routesByShortName={},this.stopsByName={},this.tripsByRoute={},this.cacheKey="peribus_gtfs_cache_v6",this.cacheVersion="6.0.0",this.cacheTtlMs=432e5,this.cacheMetaKey="peribus_gtfs_cache_meta",this.cacheDbPromise=null,this.stopTimesStore=null}async loadAllData(e){const t=performance.now();try{const r=await this.restoreCache();if(r){const e=performance.now()-t;return console.log(`‚ö° GTFS cache utilis√© en ${e.toFixed(0)}ms`),this.applyLoadedData(r),this.isLoaded=!0,!0}if("undefined"!=typeof Worker)try{const o=await this.loadViaWorker(e);this.applyLoadedData(o),h(()=>this.saveCache(o)),this.isLoaded=!0;const r=performance.now()-t;return console.log(`‚úÖ GTFS charg√© via Worker en ${r.toFixed(0)}ms`),!0}catch(o){console.warn("GTFS worker indisponible, fallback inline.",o)}const s=await this.loadInline(e);this.applyLoadedData(s),h(()=>this.saveCache(s)),this.isLoaded=!0}catch(r){console.error("‚ùå Erreur fatale:",r),this.showError("Erreur de chargement","V√©rifiez les fichiers GTFS dans /public/data/gtfs/"),this.isLoaded=!1}return this.isLoaded}async loadViaWorker(e){return new Promise((t,o)=>{const r=new URL("/assets/gtfsWorker-BJf9fHa9.js",import.meta.url),s=new Worker(r,{type:"module"});s.onmessage=r=>{const{type:n,payload:a,message:i,error:l}=r.data||{};"progress"===n?this.reportProgress(e,i||"Chargement des donn√©es GTFS..."):"loaded"===n?(s.terminate(),t(a)):"error"===n&&(s.terminate(),o(new Error(l||"GTFS worker error")))},s.onerror=e=>{s.terminate(),o(e.error||new Error("GTFS worker crashed"))},s.postMessage({type:"load"})})}async loadInline(e){this.reportProgress(e,"Chargement des fichiers GTFS...");const[t,o,r,s,l,c,d,u]=await Promise.all([this.loadGTFSFile("routes.txt"),this.loadGTFSFile("trips.txt"),this.loadGTFSFile("stop_times.txt"),this.loadGTFSFile("stops.txt"),this.loadGTFSFile("calendar.txt"),this.loadGTFSFile("calendar_dates.txt"),this.loadGTFSFile("shapes.txt"),this.loadGeoJSON()]);this.reportProgress(e,"Nettoyage des fichiers...");const p=function(e={}){const t={...n,...e};return{routes:(t.routes||[]).map(a),trips:(t.trips||[]).map(a),stopTimes:(t.stopTimes||[]).map(a),stops:(t.stops||[]).map(a),calendar:(t.calendar||[]).map(a),calendarDates:(t.calendarDates||[]).map(a),shapes:(t.shapes||[]).map(a),geoJson:t.geoJson||null}}({routes:t,trips:o,stopTimes:r,stops:s,calendar:l,calendarDates:c,shapes:d,geoJson:u});this.reportProgress(e,"Construction des index...");return{dataset:p,indexes:i(p),source:"inline"}}reportProgress(e,t){"function"==typeof e&&t&&e(t)}applyLoadedData(e){const t=(null==e?void 0:e.dataset)||e||{},o=(null==e?void 0:e.indexes)||i(t);this.routes=t.routes||[],this.trips=t.trips||[],this.stopTimes=t.stopTimes||[],this.stops=t.stops||[],this.calendar=t.calendar||[],this.calendarDates=t.calendarDates||[],this.geoJson=t.geoJson||null,this.shapes=t.shapes||[],this._shapesIndexPromise=null,this.buildRouteGeometryIndex(),this.applyIndexes(o),console.log("üõ†Ô∏è  Index GTFS pr√™ts."),console.log("‚úÖ Donn√©es charg√©es:"),console.log(`  - ${this.routes.length} routes`),console.log(`  - ${this.trips.length} trips`),console.log(`  - ${this.stopTimes.length} stop_times`),console.log(`  - ${this.stops.length} stops`),console.log(`  - ${this.calendar.length} calendriers`),console.log(`  - ${this.calendarDates.length} exceptions`),console.log(`  - ${this.shapes.length} points de shapes`)}applyIndexes(e={}){this.routesById=e.routesById||{},this.routesByShortName=e.routesByShortName||{},this.stopsById=e.stopsById||{},this.stopsByName=e.stopsByName||{},this.tripsByRoute=e.tripsByRoute||{},this.tripsByTripId=e.tripsByTripId||{},this.stopTimesByTrip=e.stopTimesByTrip||{},this.stopTimesByStop=e.stopTimesByStop||{},this.groupedStopMap=e.groupedStopMap||{},this.masterStops=e.masterStops||[],this.shapesById=e.shapesById||{},console.log(`üìç ${this.masterStops.length} arr√™ts ma√Ætres`);const t=Object.keys(this.stopTimesByStop);console.log(`üìä stopTimesByStop: ${t.length} arr√™ts index√©s`),t.length>0?console.log(`   Exemples: ${t.slice(0,3).join(", ")}`):console.warn("‚ö†Ô∏è stopTimesByStop est VIDE - les recherches de correspondances ne fonctionneront pas!")}hasShapeData(){return this.shapesById&&Object.keys(this.shapesById).length>0}async ensureShapesIndexLoaded(){return!!this.hasShapeData()||(this._shapesIndexPromise||(this._shapesIndexPromise=(async()=>{try{console.log("üîÅ Recharge des shapes GTFS √† partir de shapes.txt (cache incomplet)‚Ä¶");let o=null,r=null;try{o=await this.loadGTFSFile("shapes.txt")}catch(e){r=e,console.warn("ensureShapesIndexLoaded: shapes.txt introuvable localement, tentative via GitHub brut‚Ä¶")}if(!o)try{const e=`${this.remoteGtfsBaseUrl}/shapes.txt`;o=await this.loadGTFSFile("shapes.txt",e),console.log("ensureShapesIndexLoaded: shapes charg√©s depuis GitHub brut.")}catch(t){throw r||t}if(!Array.isArray(o)||0===o.length)return console.warn("ensureShapesIndexLoaded: shapes.txt vide ou introuvable."),!1;const s={},n=e=>null==e?"":"number"==typeof e?e:String(e).replace(/^['"]|['"]$/g,"").trim();return o.forEach(e=>{const t=n(e.shape_id);if(!t)return;const o=parseInt(n(e.shape_pt_sequence),10),r=parseFloat(n(e.shape_pt_lat)),a=parseFloat(n(e.shape_pt_lon));!Number.isFinite(o)||Number.isNaN(r)||Number.isNaN(a)||(s[t]||(s[t]=[]),s[t].push({seq:o,coord:[a,r]}))}),Object.keys(s).forEach(e=>{s[e].sort((e,t)=>e.seq-t.seq),s[e]=s[e].map(e=>e.coord)}),this.shapesById=s,this.shapes=o,console.log(`‚úÖ Shapes recharg√©s (${Object.keys(s).length} shape_id, ${o.length} points).`),!0}catch(e){return console.warn("ensureShapesIndexLoaded: √©chec du rechargement",e),!1}finally{this._shapesIndexPromise=null}})()),this._shapesIndexPromise)}buildRouteGeometryIndex(){const e={};this.geoJson&&Array.isArray(this.geoJson.features)&&this.geoJson.features.forEach(t=>{var o;const r=null==(o=null==t?void 0:t.properties)?void 0:o.route_id;if(!r||e[r])return;const s=this.normalizeRouteGeometry(t.geometry);s&&(e[r]=s)}),this.routeGeometriesById=e}normalizeRouteGeometry(e){if(!e||!e.type||!e.coordinates)return null;const t=e=>{if(!Array.isArray(e)||e.length<2)return null;const t=Number(e[0]),o=Number(e[1]);return Number.isNaN(t)||Number.isNaN(o)?null:[t,o]};if("LineString"===e.type){const o=e.coordinates.map(t).filter(Boolean);return o.length?{type:"LineString",coordinates:o}:null}if("MultiLineString"===e.type){const o=e.coordinates.flat().map(t).filter(Boolean);return o.length?{type:"LineString",coordinates:o}:null}return null}createRoutingSnapshot(){return{dataset:{routes:this.routes,trips:this.trips,stopTimes:this.stopTimes,stops:this.stops,calendar:this.calendar,calendarDates:this.calendarDates,geoJson:this.geoJson,shapes:this.shapes},indexes:{routesById:this.routesById,routesByShortName:this.routesByShortName,stopsById:this.stopsById,stopsByName:this.stopsByName,tripsByRoute:this.tripsByRoute,tripsByTripId:this.tripsByTripId,stopTimesByTrip:this.stopTimesByTrip,stopTimesByStop:this.stopTimesByStop,groupedStopMap:this.groupedStopMap,masterStops:this.masterStops,shapesById:this.shapesById}}}async optimizeStopTimesStorage(){try{this.stopTimesStore||(this.stopTimesStore=new c),await this.stopTimesStore.seedFromTripMap(this.stopTimesByTrip),Array.isArray(this.stopTimes)&&(this.stopTimes.length=0),console.log("üíæ StopTimes stock√©s dans IndexedDB et rel√¢ch√©s de la RAM.")}catch(e){console.warn("optimizeStopTimesStorage failed",e)}}async restoreCache(){try{const e=this.getCacheMeta();if(!e)return null;if(e.version!==this.cacheVersion)return console.info("GTFS cache version mismatch, purge."),h(()=>this.clearCacheStorage()),null;if(Date.now()-e.timestamp>this.cacheTtlMs)return console.info("GTFS cache expir√©, purge."),h(()=>this.clearCacheStorage()),null;const t=await this.readCacheFromIndexedDb();return t||(h(()=>this.clearCacheStorage()),null)}catch(e){return console.warn("restoreCache failed",e),h(()=>this.clearCacheStorage()),null}}async saveCache(e){try{await this.writeCacheToIndexedDb(e),this.setCacheMeta({version:this.cacheVersion,timestamp:Date.now()}),console.log("üíæ GTFS mis en cache pour les prochaines sessions.")}catch(t){console.warn("Impossible de mettre les donn√©es GTFS en cache (IndexedDB ?)",t),await this.clearCacheStorage()}}getCacheMeta(){try{const e=localStorage.getItem(this.cacheMetaKey);return e?JSON.parse(e):null}catch(e){return console.warn("getCacheMeta failed",e),null}}setCacheMeta(e){try{localStorage.setItem(this.cacheMetaKey,JSON.stringify(e))}catch(t){console.warn("setCacheMeta failed",t)}}clearCacheMeta(){try{localStorage.removeItem(this.cacheMetaKey)}catch(e){console.warn("clearCacheMeta failed",e)}}async clearCacheStorage(){await this.clearCacheFromIndexedDb(),this.clearCacheMeta(),this.clearLegacyLocalCache()}clearLegacyLocalCache(){try{localStorage.removeItem(this.cacheKey)}catch(e){console.warn("clearLegacyLocalCache failed",e)}}async ensureCacheDb(){return this.cacheDbPromise?this.cacheDbPromise:"undefined"==typeof indexedDB?(this.cacheDbPromise=Promise.resolve(null),this.cacheDbPromise):(this.cacheDbPromise=new Promise((e,t)=>{try{const o=indexedDB.open("peribus_gtfs_cache_db",1);o.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(p)||t.createObjectStore(p)},o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)}catch(o){t(o)}}).catch(e=>(console.warn("ensureCacheDb failed",e),null)),this.cacheDbPromise)}async readCacheFromIndexedDb(){const e=await this.ensureCacheDb();return e?new Promise((t,o)=>{const r=e.transaction(p,"readonly").objectStore(p).get(this.cacheKey);r.onsuccess=()=>t(r.result||null),r.onerror=()=>o(r.error)}).then(e=>e&&e.data?e.data:null).catch(e=>(console.warn("readCacheFromIndexedDb failed",e),null)):null}async writeCacheToIndexedDb(e){const t=await this.ensureCacheDb();if(t)return new Promise((o,r)=>{const s=t.transaction(p,"readwrite").objectStore(p).put({data:e},this.cacheKey);s.onsuccess=()=>o(!0),s.onerror=()=>r(s.error)})}async clearCacheFromIndexedDb(){const e=await this.ensureCacheDb();if(e)return new Promise((t,o)=>{const r=e.transaction(p,"readwrite").objectStore(p).delete(this.cacheKey);r.onsuccess=()=>t(!0),r.onerror=()=>o(r.error)}).catch(e=>{console.warn("clearCacheFromIndexedDb failed",e)})}async loadGTFSFile(e,t=null){const o=t||`/data/gtfs/${e}`,r=await fetch(o);if(!r.ok)throw new Error(`Impossible de charger ${e}: ${r.statusText}`);const s=await r.text();return new Promise(e=>{Papa.parse(s,{header:!0,skipEmptyLines:!0,worker:!0,complete:t=>{e(t.data)}})})}async loadGeoJSON(){const e=await fetch("/data/map.geojson?v="+Date.now());return e.ok?await e.json():(console.warn("‚ö†Ô∏è  map.geojson non trouv√©"),null)}showError(e,t){const o=document.getElementById("instructions");if(o){o.classList.remove("hidden"),o.querySelector("h3").textContent=e;o.querySelector("ol").innerHTML=`<li>${t}</li>`;o.querySelectorAll("ol li:not(:first-child)").forEach(e=>e.style.display="none")}}getServiceIds(e){const t=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][e.getDay()],o=e.getFullYear()+String(e.getMonth()+1).padStart(2,"0")+String(e.getDate()).padStart(2,"0"),r=new Set,s=new Set;if(this.calendarDates.forEach(e=>{e.date===o&&"2"===e.exception_type&&s.add(e.service_id)}),this.calendar.forEach(e=>{const n="1"===e[t]||1===e[t],a=e.start_date<=o&&e.end_date>=o,i=!s.has(e.service_id);n&&a&&i&&r.add(e.service_id)}),this.calendarDates.forEach(e=>{e.date===o&&"1"===e.exception_type&&r.add(e.service_id)}),0===r.size){console.warn(`‚ö†Ô∏è  AUCUN SERVICE ACTIF pour le ${o} (${t})`),console.warn(`üîÑ Activation du fallback: recherche des services pour ${t} dans la p√©riode la plus r√©cente`);let e=null;this.calendar.forEach(o=>{("1"===o[t]||1===o[t])&&o.end_date&&(!e||o.end_date>e)&&(e=o.end_date)}),e?(console.log(`üìÖ P√©riode la plus r√©cente trouv√©e: jusqu'au ${e}`),this.calendar.forEach(e=>{const o="1"===e[t]||1===e[t],n=!s.has(e.service_id);o&&n&&r.add(e.service_id)}),r.size>0&&console.log(`‚úÖ Fallback r√©ussi: ${r.size} service(s) activ√©(s) pour ${t}`)):console.error(`‚ùå Aucun service trouv√© pour ${t} dans calendar.txt`)}return r}serviceIdsMatch(e,t){if(!e||!t)return!1;if(e===t)return!0;const[o]=e.split(":",4);return o===t}getUpcomingDepartures(e,t,o,r=5){const s=this.getServiceIds(o);if(0===s.size)return console.warn("‚ö†Ô∏è  Aucun service actif"),[];let n=[];return e.forEach(e=>{(this.stopTimesByStop[e]||[]).forEach(o=>{const r=this.tripsByTripId[o.trip_id];if(!r)return;if(Array.from(s).some(e=>this.serviceIdsMatch(r.service_id,e))){if(!d(o.departure_time))return;if(u(this.stopTimesByTrip[o.trip_id],o.stop_id))return;const r=this.timeToSeconds(o.departure_time);r>=t&&n.push({tripId:o.trip_id,stopId:e,time:o.departure_time,departureSeconds:r})}})}),n.sort((e,t)=>e.departureSeconds-t.departureSeconds),n=n.slice(0,r),n.map(e=>{const t=this.tripsByTripId[e.tripId],o=this.routesById[t.route_id],r=this.stopTimesByTrip[e.tripId],s=this.getTripDestination(r);return{...e,routeShortName:o.route_short_name,routeColor:o.route_color,routeTextColor:o.route_text_color,destination:s}})}getDeparturesForOneHour(e,t,o){const r=this.getServiceIds(o);if(console.log(`üîç getDeparturesForOneHour: ${e.length} stopIds, heure=${Math.floor(t/3600)}:${String(Math.floor(t%3600/60)).padStart(2,"0")}`),console.log("üìÖ Services actifs:",Array.from(r)),0===r.size)return console.warn("‚ö†Ô∏è  Aucun service actif pour cette date"),{departuresByLine:{},isNextDayDepartures:!1,firstDepartureTime:null};const s=t+3600,n=[];e.forEach(e=>{(this.stopTimesByStop[e]||[]).forEach(e=>{const o=this.tripsByTripId[e.trip_id];if(!o)return;if(Array.from(r).some(e=>this.serviceIdsMatch(o.service_id,e))){if(!d(e.departure_time))return;const r=this.stopTimesByTrip[e.trip_id];if(u(r,e.stop_id))return;const s=this.timeToSeconds(e.departure_time);if(s>=t){const t=this.routesById[o.route_id];if(!t)return;const a=this.getTripDestination(r);n.push({departureSeconds:s,time:e.departure_time,route:t,destination:a})}}})}),n.sort((e,t)=>e.departureSeconds-t.departureSeconds);let a=n,i=!1,l=null;n.length>0&&n[0].departureSeconds>s&&(i=!0,l=n[0].time,console.log(`üåÖ Premiers d√©parts √† partir de ${l}`));const c={};return a.forEach(e=>{const t=`${e.route.route_short_name}_${e.destination}`;c[t]||(c[t]={routeId:e.route.route_id,routeShortName:e.route.route_short_name,routeColor:e.route.route_color,routeTextColor:e.route.route_text_color,destination:e.destination,departures:[]}),c[t].departures.length<4&&c[t].departures.push({time:e.time,departureSeconds:e.departureSeconds})}),console.log(`üìä Stats: ${n.length} d√©parts futurs, isNextDay=${i}`),{departuresByLine:c,isNextDayDepartures:i,firstDepartureTime:l}}getActiveTrips(e,t){const o=this.getServiceIds(t);if(0===o.size)return[];const r=[];return this.trips.forEach(t=>{if(Array.from(o).some(e=>this.serviceIdsMatch(t.service_id,e))){const o=this.stopTimesByTrip[t.trip_id];if(!o||o.length<2)return;const s=o[0],n=o[o.length-1],a=this.timeToSeconds(s.arrival_time),i=this.timeToSeconds(n.arrival_time);e>=a&&e<=i&&r.push({tripId:t.trip_id,trip:t,stopTimes:o,route:this.routesById[t.route_id]})}}),r}getRoute(e){return this.routesById[e]||null}getStop(e){return this.stopsById[e]||null}getStopTimes(e){return this.stopTimesByTrip[e]||[]}getRouteGeometry(e){if(!e)return null;if(this.routeGeometriesById&&this.routeGeometriesById[e])return this.routeGeometriesById[e];if(!this.geoJson||!Array.isArray(this.geoJson.features))return null;const t=this.geoJson.features.find(t=>{var o;return(null==(o=null==t?void 0:t.properties)?void 0:o.route_id)===e});if(!t)return null;const o=this.normalizeRouteGeometry(t.geometry);return o?(this.routeGeometriesById[e]=o,o):null}timeToSeconds(e){const[t,o,r]=e.split(":").map(Number);return 3600*t+60*o+r}formatTime(e,t=!1){if(null==e)return"--:--";const o=Number(e);if(Number.isNaN(o))return"--:--";const r=(Math.floor(o)%86400+86400)%86400,s=Math.floor(r/3600),n=Math.floor(r%3600/60),a=e=>String(e).padStart(2,"0");if(!t)return`${a(s)}:${a(n)}`;const i=r%60;return`${a(s)}:${a(n)}:${a(i)}`}toRad(e){return e*Math.PI/180}calculateDistance(e,t,o,r){const s=this.toRad(e),n=this.toRad(o),a=this.toRad(o-e),i=this.toRad(r-t),l=Math.sin(a/2)*Math.sin(a/2)+Math.cos(s)*Math.cos(n)*Math.sin(i/2)*Math.sin(i/2);return 6371e3*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))}findNearestPointOnRoute(e,t,o){let r=1/0,s=null;return e.forEach(([e,n],a)=>{const i=this.calculateDistance(t,o,n,e);i<r&&(r=i,s=a)}),r>500?null:s}getTripDestination(e){if(!e||0===e.length)return"Destination inconnue";const t=e[e.length-1],o=this.getStop(t.stop_id);return o?o.stop_name:"Destination inconnue"}getDailyServiceBounds(){let e=1/0,t=-1/0;return Object.values(this.stopTimesByTrip).forEach(o=>{if(o.length<2)return;const r=o[0],s=o[o.length-1],n=this.timeToSeconds(r.departure_time||r.arrival_time),a=this.timeToSeconds(s.arrival_time||s.departure_time);n<e&&(e=n),a>t&&(t=a)}),e===1/0&&(e=0),t===-1/0&&(t=86400),{earliestStart:e,latestEnd:t}}findFirstActiveSecond(){return this.getDailyServiceBounds().earliestStart}findNextActiveSecond(e){let t=1/0;return Object.values(this.stopTimesByTrip).forEach(o=>{if(o.length<2)return;const r=o[0],s=this.timeToSeconds(r.departure_time||r.arrival_time);s>e&&s<t&&(t=s)}),t===1/0?this.findFirstActiveSecond():t}formatDuration(e){const t=Math.floor(e/3600),o=Math.floor(e%3600/60);let r="";return t>0&&(r+=`${t} h `),(o>0||0===t)&&(r+=`${o} min`),r.trim()}getIntermediateStops(e,t,o,r){const s=this.routesByShortName[e];if(!s)return console.warn(`[GTFS Match] Route "${e}" non trouv√©e.`),null;const n=e=>e?e.toLowerCase().replace(/[√†√°√¢√£√§√•]/g,"a").replace(/[√®√©√™√´]/g,"e").replace(/[√¨√≠√Æ√Ø]/g,"i").replace(/[√≤√≥√¥√µ√∂]/g,"o").replace(/[√π√∫√ª√º]/g,"u").replace(/[√ß]/g,"c").replace(/[^a-z0-9]/g,"").trim():"",a=e=>{const t=n(e),o=this.stopsByName[t];return o||this.stops.filter(e=>{const o=n(e.stop_name);return o===t||o.includes(t)||t.includes(o)})},i=a(o),l=a(r);if(0===i.length||0===l.length)return console.warn(`[GTFS Match] Arr√™t non trouv√©: "${o}" (${i.length} r√©sultats) -> "${r}" (${l.length} r√©sultats)`),null;const c=new Set(i.map(e=>e.stop_id)),d=new Set(l.map(e=>e.stop_id)),u=this.tripsByRoute[s.route_id]||[],p=n(t||"");let h=u.filter(e=>{const t=n(e.trip_headsign||"");return t.includes(p)||p.includes(t)});0===h.length&&(console.warn(`[GTFS Match] Aucun trip trouv√© pour ${e} direction "${t}". Essai sans headsign.`),h=u);for(const m of h){const e=this.stopTimesByTrip[m.trip_id];if(!e)continue;const t=e.findIndex(e=>c.has(e.stop_id)),o=e.findIndex(e=>d.has(e.stop_id));if(-1!==t&&-1!==o&&t<o){const r=e.slice(t+1,o);return console.log(`[GTFS Match] ‚úÖ SUCC√àS: Trip ${m.trip_id} trouv√© (${r.length} arr√™ts interm√©diaires)`),r.map(e=>this.stopsById[e.stop_id].stop_name)}}return console.warn(`[GTFS Match] Aucun pattern de trip trouv√© pour ${o} -> ${r}.`),null}getNearestStops(e,t=1e3,o=10){if(!e||"number"!=typeof e.lat||"number"!=typeof e.lon)return[];const r=this.stops.map(t=>({stop:t,distance:this.calculateDistance(e.lat,e.lon,parseFloat(t.stop_lat),parseFloat(t.stop_lon))})).filter(e=>!isNaN(e.distance)&&e.distance<=t);return r.sort((e,t)=>e.distance-t.distance),r.slice(0,o).map(e=>e.stop)}getTripsBetweenStops(e,t,o,r=0,s=86400,n="partir"){const a=new Set(Array.isArray(e)?e:Array.from(e||[])),i=new Set(Array.isArray(t)?t:Array.from(t||[])),l=e=>{const t=[];e.forEach(e=>{const o=this.groupedStopMap[e];Array.isArray(o)&&o.forEach(e=>t.push(e));const r=this.stopsById[e];r&&"1"===r.location_type&&Object.values(this.stopsById).forEach(o=>{o.parent_station===e&&t.push(o.stop_id)})}),t.forEach(t=>e.add(t))};l(a),l(i);const c=(Date,new Date(o)),d=new Date(c);d.setDate(c.getDate()-1);const u=new Date(c);u.setDate(c.getDate()+1);const p=this.getServiceIds(c),h=this.getServiceIds(d),m=this.getServiceIds(u),g=r,f=s,v=[];if((g<0||g<18e3)&&h.size&&v.push({label:"prev",offset:-86400,serviceSet:h}),p.size&&v.push({label:"current",offset:0,serviceSet:p}),f>86400&&m.size&&v.push({label:"next",offset:86400,serviceSet:m}),!globalThis._gtfsDebugLogged){globalThis._gtfsDebugLogged=!0;const e=new Set;Object.values(this.stopTimesByTrip).forEach(t=>{t.forEach(t=>e.add(t.stop_id))});const t=Array.from(a).filter(t=>e.has(t)),o=Array.from(i).filter(t=>e.has(t));console.log("üî¨ Recherche GTFS directe:"),console.log(`   D√©part: ${t.length}/${a.size} IDs valides`,t.slice(0,2)),console.log(`   Arriv√©e: ${o.length}/${i.size} IDs valides`,o.slice(0,2));const r=e=>e.toLocaleDateString("fr-CA");console.log(`   Services veille (${r(d)}):`,Array.from(h)),console.log(`   Services jour J (${r(c)}):`,Array.from(p)),console.log(`   Services lendemain (${r(u)}):`,Array.from(m)),console.log(`   Fen√™tre brute: ${g}s ‚Üí ${f}s`),globalThis._validEndIds=o}const y=[],S={serviceRejected:0,noStopTimes:0,noBoardingFound:0,noAlightFound:0,wrongOrder:0,outOfWindow:0,accepted:0};for(const w of this.trips){const e=this.stopTimesByTrip[w.trip_id];if(!e||e.length<2){S.noStopTimes++;continue}let t=-1,o=-1;for(let n=0;n<e.length;n++){const r=e[n];if(-1===t&&a.has(r.stop_id)&&(t=n),-1===o&&i.has(r.stop_id)&&(o=n),-1!==t&&-1!==o)break}if(-1===t){S.noBoardingFound++;continue}if(-1===o){S.noAlightFound++;continue}if(t>=o){S.wrongOrder++;continue}const r=e[t],s=e[o],l=this.timeToSeconds(r.departure_time||r.arrival_time),c=this.timeToSeconds(s.arrival_time||s.departure_time);let d=!1,u=!1;for(const a of v){if(!Array.from(a.serviceSet).some(e=>this.serviceIdsMatch(w.service_id,e)))continue;d=!0;const i=l+a.offset,p=c+a.offset;if("arriver"===n?p>=g&&p<=f:i>=g&&i<=f){u=!0,S.accepted++,y.push({tripId:w.trip_id,routeId:w.route_id,shapeId:w.shape_id||null,boardingStopId:r.stop_id,alightingStopId:s.stop_id,departureSeconds:i,arrivalSeconds:p,stopTimes:e.slice(t,o+1),trip:w,route:this.getRoute(w.route_id)});break}S.outOfWindow++}d?u||S.outOfWindow++:S.serviceRejected++}return y.sort((e,t)=>e.departureSeconds-t.departureSeconds),globalThis._gtfsStatsLogged||0!==y.length||(globalThis._gtfsStatsLogged=!0,console.log("üìä getTripsBetweenStops STATS:",JSON.stringify(S)),S.noBoardingFound>0&&S.noAlightFound>0&&0===S.accepted&&(console.log("‚ö†Ô∏è AUCUN trajet DIRECT: les arr√™ts d√©part/arriv√©e ne sont pas sur la m√™me ligne."),console.log("üí° Une correspondance sera n√©cessaire."))),globalThis._gtfsStatsLogged&&!globalThis._secondLegStatsLogged&&(globalThis._secondLegCallCount=(globalThis._secondLegCallCount||0)+1,globalThis._secondLegCallCount<=3&&0===y.length&&(console.log(`üîç Second leg #${globalThis._secondLegCallCount} STATS:`,JSON.stringify(S)),console.log(`   StartIds (${a.size}):`,Array.from(a).slice(0,3)),console.log(`   EndIds (${i.size}):`,Array.from(i).slice(0,3)),console.log(`   Window: ${Math.floor(r/3600)}:${String(Math.floor(r%3600/60)).padStart(2,"0")} - ${Math.floor(s/3600)}:${String(Math.floor(s%3600/60)).padStart(2,"0")}`)),3===globalThis._secondLegCallCount&&(globalThis._secondLegStatsLogged=!0)),y}findStopsByName(e,t=10){if(!e||"string"!=typeof e)return[];const o=e=>e?e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]/g,"").trim():"",r=o(e);if(!r)return[];const s=new Map,n=e=>{e&&!s.has(e.stop_id)&&s.set(e.stop_id,e)},a=this.stopsByName[r];if(a&&a.length&&a.forEach(n),s.size<t)for(const i of this.stops)if(i&&i.stop_name&&o(i.stop_name).includes(r)&&(n(i),s.size>=t))break;return Array.from(s.values()).slice(0,t)}getShapeLatLngs(e){if(!e||!this.shapesById)return null;const t=this.shapesById[e];return t&&t.length?t.map(([e,t])=>[t,e]):null}getShapeGeoJSON(e,t=null){if(e&&this.shapesById&&this.shapesById[e]&&this.shapesById[e].length)return{type:"LineString",coordinates:this.shapesById[e]};if(t&&this.tripsByRoute&&this.tripsByRoute[t]){const e=this.tripsByRoute[t].find(e=>e.shape_id&&this.shapesById[e.shape_id]);if(e)return{type:"LineString",coordinates:this.shapesById[e.shape_id]}}if(!this.geoJson||!this.geoJson.features)return null;if(e){const t=this.geoJson.features.find(t=>t.properties&&(t.properties.shape_id===e||t.properties.shapeid===e));if(t&&t.geometry)return t.geometry}if(t){const e=this.geoJson.features.find(e=>e.properties&&e.properties.route_id===t);if(e&&e.geometry)return e.geometry}return null}generateGeoJsonFromShapes(){if(!this.shapesById||0===Object.keys(this.shapesById).length)return console.warn("‚ùå Pas de shapes disponibles pour g√©n√©rer le GeoJSON"),null;const e=[],t=new Set;return this.trips.forEach(o=>{const r=o.shape_id,s=o.route_id;if(!r||!this.shapesById[r])return;const n=`${s}_${o.direction_id||0}`;if(t.has(n))return;t.add(n);const a=this.routesById[s];if(!a)return;const i=this.shapesById[r];!i||i.length<2||e.push({type:"Feature",geometry:{type:"LineString",coordinates:i},properties:{route_id:s,shape_id:r,route_short_name:a.route_short_name,route_long_name:a.route_long_name,route_color:a.route_color,route_text_color:a.route_text_color,direction_id:o.direction_id||0}})}),console.log(`‚úÖ GeoJSON g√©n√©r√©: ${e.length} trac√©s √† partir des shapes GTFS`),{type:"FeatureCollection",features:e}}}class g{constructor(){this.isRunning=!1,this.listeners=[],this.mode="real",this.simulatedSeconds=null,this.lastTickTime=null,this.currentDate=new Date}getRealTime(){this.currentDate=new Date;const e=this.currentDate;return 3600*e.getHours()+60*e.getMinutes()+e.getSeconds()+e.getMilliseconds()/1e3}setMode(e){"real"===e||"simulated"===e?(this.mode=e,console.log(`üîß Mode chang√©: ${e}`),this.currentDate=new Date,this.notifyListeners()):console.error('Mode invalide. Utilisez "real" ou "simulated"')}setTime(e){this.simulatedSeconds=e,this.lastTickTime=Date.now(),this.currentDate=new Date,console.log(`‚è∞ Heure simul√©e d√©finie: ${this.formatTime(e)}`),this.notifyListeners()}play(){this.isRunning||(this.isRunning=!0,this.lastTickTime=Date.now(),this.currentDate=new Date,this.tick(),console.log(`‚ñ∂Ô∏è Mode ${"simulated"===this.mode?"simulation":"temps r√©el"} d√©marr√©`))}pause(){this.isRunning=!1,console.log("‚è∏Ô∏è Pause")}reset(){console.log("üîÑ Rechargement"),this.lastTickTime=Date.now(),this.currentDate=new Date,this.notifyListeners()}tick(){if(!this.isRunning)return;const e=Date.now();if("simulated"===this.mode&&null!==this.simulatedSeconds&&null!==this.lastTickTime){const t=(e-this.lastTickTime)/1e3;this.simulatedSeconds+=t,this.simulatedSeconds>=86400&&(this.simulatedSeconds=0)}else this.currentDate=new Date;this.lastTickTime=e,this.notifyListeners(),requestAnimationFrame(()=>this.tick())}addListener(e){this.listeners.push(e)}notifyListeners(){const e=this.getCurrentSeconds(),t={seconds:e,timeString:this.formatTime(e),isRunning:this.isRunning,mode:this.mode,date:this.currentDate};this.listeners.forEach(e=>{e(t)})}formatTime(e){const t=Math.floor(e/3600)%24,o=Math.floor(e%3600/60);return`${String(t).padStart(2,"0")}:${String(o).padStart(2,"0")}`}getCurrentSeconds(){return"simulated"===this.mode&&null!==this.simulatedSeconds?this.simulatedSeconds:this.getRealTime()}getCurrentDate(){return this.isRunning||"real"!==this.mode||(this.currentDate=new Date),this.currentDate}getCurrentTimeString(){return this.formatTime(this.getCurrentSeconds())}getIsRunning(){return this.isRunning}getIsSimulated(){return"simulated"===this.mode}}class f{constructor(e){this.dataManager=e}getActiveTrips(e,t){if(!this.dataManager.isLoaded)return[];const o=this.dataManager.getActiveTrips(e,t),r=[];return o.forEach(({tripId:t,trip:o,stopTimes:s,route:n})=>{const a=this.findCurrentState(s,e);a&&r.push({tripId:t,trip:o,route:n,segment:a,position:null,currentSeconds:e})}),r}findCurrentState(e,t){if(!e||e.length<2)return null;for(let a=1;a<e.length;a++){const o=e[a],r=e[a-1],s=this.dataManager.timeToSeconds(r.departure_time),n=this.dataManager.timeToSeconds(o.departure_time);if(t>=s&&t<n){const e=this.dataManager.getStop(r.stop_id),a=this.dataManager.getStop(o.stop_id);return e&&a?{type:"moving",fromStopInfo:e,toStopInfo:a,departureTime:s,arrivalTime:n,progress:this.calculateProgress(s,n,t)}:null}}const o=e[e.length-1],r=e[e.length-2],s=this.dataManager.timeToSeconds(r.departure_time),n=this.dataManager.timeToSeconds(o.arrival_time);if(t>=s&&t<=n){const e=this.dataManager.getStop(r.stop_id),a=this.dataManager.getStop(o.stop_id);return e&&a?{type:"moving",fromStopInfo:e,toStopInfo:a,departureTime:s,arrivalTime:n,progress:this.calculateProgress(s,n,t)}:null}return null}calculateProgress(e,t,o){const r=t-e;if(r<=0)return 0;const s=o-e;return Math.max(0,Math.min(1,s/r))}getNextStopETA(e,t){if(!e)return null;const o=e.arrivalTime-t,r=Math.max(0,Math.floor(o/60)),s=Math.max(0,Math.floor(o%60));return 1===e.progress?{seconds:0,formatted:"Terminus"}:{seconds:o,formatted:`${r}m ${s}s`}}getTripDestination(e){if(!e||0===e.length)return"Destination inconnue";const t=e[e.length-1],o=this.dataManager.getStop(t.stop_id);return o?o.stop_name:t.stop_id}}class v{constructor(e,t=null){this.dataManager=e,this.realtimeManager=t,this.segmentCache=new Map,this.rtAdjustmentCache=new Map,this.rtCacheMaxAge=3e4}setRealtimeManager(e){this.realtimeManager=e}calculatePosition(e,t=null,o=null,r=null){if(!e||!e.fromStopInfo||!e.toStopInfo)return null;const s=parseFloat(e.fromStopInfo.stop_lat),n=parseFloat(e.fromStopInfo.stop_lon),a=parseFloat(e.toStopInfo.stop_lat),i=parseFloat(e.toStopInfo.stop_lon);if(isNaN(s)||isNaN(n)||isNaN(a)||isNaN(i))return null;let l=e.progress,c=null;if(o&&r&&this.realtimeManager&&(c=this.getRealtimeAdjustedProgress(o,r,e.toStopInfo.stop_id,e.toStopInfo.stop_code,e.departureTime,e.arrivalTime),c&&null!==c.adjustedProgress&&(l=c.adjustedProgress)),t){const o=this.dataManager.getRouteGeometry(t),r=this.extractRouteCoordinates(o);if(r&&r.length>0){const o=this.interpolateAlongRouteCached(t,e.fromStopInfo.stop_id,e.toStopInfo.stop_id,r,s,n,a,i,l);if(o)return o.rtInfo=c,o}}return{lat:s+(a-s)*l,lon:n+(i-n)*l,progress:l,bearing:this.calculateLinearBearing(s,n,a,i),rtInfo:c}}getRealtimeAdjustedProgress(e,t,o,r,s,n){var a;if(!this.realtimeManager)return null;const i=`${e}_${o}`,l=this.rtAdjustmentCache.get(i);if(l&&Date.now()-l.fetchedAt<this.rtCacheMaxAge)return l;if(!this.realtimeManager.hasRealtimeDataForStop(o,r))return null;const c=this.realtimeManager.cache?Array.from(this.realtimeManager.cache.keys()).find(e=>e.includes(r||o)):null;if(!c)return null;const d=this.realtimeManager.cache.get(c);if(!d||!d.data||!d.data.departures)return null;const u=(null==(a=null==t?void 0:t.toUpperCase)?void 0:a.call(t))||"",p=d.data.departures.find(e=>{var t;return(null==(t=e.line)?void 0:t.toUpperCase())===u});if(!p)return null;const h=this.realtimeManager.parseTemps(p.time);if(null===h||h>=999)return null;const m=n-s;if(m<=0)return null;let g=1-60*h/m;g=Math.max(0,Math.min(1,g));const f={rtMinutes:h,adjustedProgress:g,isRealtime:!1!==p.realtime,fetchedAt:Date.now()};return this.rtAdjustmentCache.set(i,f),f}interpolateAlongRouteCached(e,t,o,r,s,n,a,i,l){const c=`${e}_${t}_${o}`;let d=this.segmentCache.get(c);if(!d){if(d=this.computeSegmentGeometry(r,s,n,a,i),!d)return this.segmentCache.set(c,{invalid:!0}),null;this.segmentCache.set(c,d)}if(d.invalid)return null;const u=d.totalDistance*l,p=d.distances,h=d.path;for(let g=0;g<p.length-1;g++)if(u>=p[g]&&u<=p[g+1]){const e=p[g],t=p[g+1]-e,o=t>0?(u-e)/t:0,[r,s]=h[g],[n,a]=h[g+1];return{lat:s+(a-s)*o,lon:r+(n-r)*o,progress:l}}const m=h[h.length-1];return{lat:m[1],lon:m[0],progress:l}}computeSegmentGeometry(e,t,o,r,s){const n=this.dataManager.findNearestPointOnRoute(e,t,o),a=this.dataManager.findNearestPointOnRoute(e,r,s);if(null===n||null===a||n===a)return null;let i;if(i=n<a?e.slice(n,a+1):e.slice(a,n+1).reverse(),i.length<2)return null;const l=[0];let c=0;for(let d=1;d<i.length;d++){const[e,t]=i[d-1],[o,r]=i[d];c+=this.dataManager.calculateDistance(t,e,r,o),l.push(c)}return 0===c?null:{path:i,distances:l,totalDistance:c}}calculateBearing(e){if(!e||!e.fromStopInfo||!e.toStopInfo)return 0;const t=parseFloat(e.fromStopInfo.stop_lat),o=parseFloat(e.fromStopInfo.stop_lon),r=parseFloat(e.toStopInfo.stop_lat),s=parseFloat(e.toStopInfo.stop_lon);return this.calculateLinearBearing(t,o,r,s)}extractRouteCoordinates(e){return e?Array.isArray(e)?e:"LineString"===e.type?e.coordinates:"MultiLineString"===e.type?e.coordinates.flat():null:null}calculateLinearBearing(e,t,o,r){const s=e=>e*Math.PI/180,n=s(e),a=s(o),i=s(r-t),l=Math.sin(i)*Math.cos(a),c=Math.cos(n)*Math.sin(a)-Math.sin(n)*Math.cos(a)*Math.cos(i);let d=Math.atan2(l,c);return(180*d/Math.PI+360)%360}calculateAllPositions(e){return e.map(e=>{var t,o;const r=null==(t=e.route)?void 0:t.route_id,s=null==(o=e.route)?void 0:o.route_short_name,n=e.tripId;let a=null,i=0;return e.segment?(a=this.calculatePosition(e.segment,r,n,s),a&&(i=a.bearing||this.calculateBearing(e.segment))):e.position&&(a=e.position),a?{...e,position:a,bearing:i,rtInfo:a.rtInfo||null}:null}).filter(e=>null!==e)}}const y=new class{constructor(){this.delayCache=new Map,this.stats={totalObservations:0,delaysByLine:{},delaysByHour:{},delaysByStop:{},peakDelayHours:[]},this.delayHistory=[],this.maxHistorySize=5e3,this.tripLineCache=new Map,this.minDelayThreshold=120,this.majorDelayThreshold=300}init(e,t){this.dataManager=e,this.realtimeManager=t}calculateTripDelay(e,t,o){if(!e||!t||0===t.length)return null;const r=e.trip_id,s=this.delayCache.get(r);if(s&&Date.now()-s.timestamp<6e4)return s.data;const n=this.findCurrentStopForTrip(t,o);if(!n)return null;const a=this.getRealTimeDataForStop(n.stop_id,e.route_id);if(!a)return null;const i=this.computeDelaySeconds(n,a);if(Math.abs(i)<this.minDelayThreshold)return null;const l={tripId:r,delaySeconds:i,isMajor:Math.abs(i)>=this.majorDelayThreshold,relevantStop:n,scheduledTime:this.formatTime(n.departure_time),estimatedTime:this.addSecondsToTime(n.departure_time,i),stopId:n.stop_id};return this.delayCache.set(r,{data:l,timestamp:Date.now()}),l}adjustProgressForDelay(e,t,o){if(!e||!t)return(null==e?void 0:e.progress)||0;const r=e.progress;if(t.delaySeconds>0){const e=Math.min(.05,t.delaySeconds/3600);return Math.min(1,r+e)}if(t.delaySeconds<0){const e=Math.min(.05,Math.abs(t.delaySeconds)/3600);return Math.max(0,r-e)}return r}recordDelay(e,t,o){if(!e||!t)return;const{tripId:r,delaySeconds:s,isMajor:n,stopId:a}=e,i=t.route_id,l=Math.floor(o/3600);this.delayHistory.push({tripId:r,lineId:i,delaySeconds:s,isMajor:n,stopId:a,timestamp:Date.now(),hour:l}),this.delayHistory.length>this.maxHistorySize&&this.delayHistory.shift(),this.stats.delaysByLine[i]||(this.stats.delaysByLine[i]={totalDelay:0,count:0,maxDelay:0,minDelay:0,majorDelayCount:0});const c=this.stats.delaysByLine[i];c.totalDelay+=s,c.count++,c.maxDelay=Math.max(c.maxDelay,s),c.minDelay=Math.min(c.minDelay,s),n&&c.majorDelayCount++;const d=`${l}:00`;this.stats.delaysByHour[d]||(this.stats.delaysByHour[d]={totalDelay:0,count:0}),this.stats.delaysByHour[d].totalDelay+=s,this.stats.delaysByHour[d].count++,this.stats.delaysByStop[a]||(this.stats.delaysByStop[a]={totalDelay:0,count:0}),this.stats.delaysByStop[a].totalDelay+=s,this.stats.delaysByStop[a].count++,this.stats.totalObservations++}getDelayStats(){return{totalObservations:this.stats.totalObservations,lineStats:Object.entries(this.stats.delaysByLine).map(([e,t])=>({lineId:e,averageDelay:Math.round(t.totalDelay/(t.count||1)),maxDelay:t.maxDelay,minDelay:t.minDelay,majorDelayCount:t.majorDelayCount,observations:t.count})),hourlyStats:Object.entries(this.stats.delaysByHour).sort((e,t)=>e[0].localeCompare(t[0])).map(([e,t])=>({hour:e,averageDelay:Math.round(t.totalDelay/(t.count||1)),observations:t.count})),worstStops:Object.entries(this.stats.delaysByStop).sort((e,t)=>t[1].totalDelay/(t[1].count||1)-e[1].totalDelay/(e[1].count||1)).slice(0,10).map(([e,t])=>({stopId:e,averageDelay:Math.round(t.totalDelay/(t.count||1)),observations:t.count}))}}async syncStatsToServer(){try{const e=this.getDelayStats(),t=await fetch("/api/delay-stats",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({timestamp:(new Date).toISOString(),stats:e,history:this.delayHistory.slice(-100)})}).catch(()=>null);if(t&&t.ok)return console.log("[DelayManager] ‚úÖ Statistiques synchronis√©es au serveur"),!0}catch(e){}try{const e=this.getDelayStats(),t={timestamp:(new Date).toISOString(),stats:e,history:this.delayHistory.slice(-100)};return localStorage.setItem("perimap_delay_stats",JSON.stringify(t)),console.log("[DelayManager] üíæ Statistiques sauvegard√©es en localStorage"),!0}catch(e){return console.warn("[DelayManager] Erreur lors de la sauvegarde locale:",e),!1}}loadStatsFromStorage(){try{const e=localStorage.getItem("perimap_delay_stats");if(!e)return null;const t=JSON.parse(e);return console.log("[DelayManager] üìÇ Statistiques charg√©es depuis localStorage"),t}catch(e){return console.warn("[DelayManager] Erreur lors du chargement des stats:",e),null}}clearStorage(){try{return localStorage.removeItem("perimap_delay_stats"),this.delayHistory=[],this.stats={totalObservations:0,delaysByLine:{},delaysByHour:{},delaysByStop:{},peakDelayHours:[]},console.log("[DelayManager] üóëÔ∏è Toutes les statistiques ont √©t√© effac√©es"),!0}catch(e){return console.warn("[DelayManager] Erreur lors du nettoyage:",e),!1}}exportStats(e="json"){const t=this.getDelayStats();return"csv"===e?this.statsToCSV(t):t}findCurrentStopForTrip(e,t){if(!e||0===e.length)return null;for(let a=1;a<e.length;a++){const o=e[a-1],r=e[a],s=this.dataManager.timeToSeconds(o.departure_time),n=this.dataManager.timeToSeconds(r.departure_time);if(t>=s&&t<n)return r}const o=e[e.length-1],r=e[e.length-2],s=this.dataManager.timeToSeconds(r.departure_time),n=this.dataManager.timeToSeconds(o.arrival_time);return t>=s&&t<=n?o:null}getRealTimeDataForStop(e,t){return null}computeDelaySeconds(e,t){return 0}formatTime(e){return e||"--:--"}addSecondsToTime(e,t){if(!e)return"--:--";const o=e.split(":");let r=parseInt(o[0])||0,s=parseInt(o[1])||0,n=parseInt(o[2])||0;for(n+=t;n>=60;)s++,n-=60;for(;s>=60;)r++,s-=60;return`${String(r).padStart(2,"0")}:${String(s).padStart(2,"0")}:${String(n).padStart(2,"0")}`}statsToCSV(e){let t="Hour,Line,AverageDelay(seconds),MaxDelay,Observations\n";return e.hourlyStats.forEach(e=>{t+=`${e.hour},,${e.averageDelay},${e.observations}\n`}),e.lineStats.forEach(e=>{t+=`,${e.lineId},${e.averageDelay},${e.maxDelay},${e.observations}\n`}),t}};class S{constructor(){this.isOpen=!1,this.currentTab="summary",this.panel=null,this.isAdminMode=this.checkAdminMode()}checkAdminMode(){var e;const t=window.__ADMIN_TOKEN||(null==(e=window.__APP_CONFIG)?void 0:e.adminToken),o=document.querySelector('meta[name="peribus-admin-token"]');return!(!t&&!o)}init(){this.panel=document.createElement("div"),this.panel.id="data-exporter-panel",this.panel.className="data-exporter-panel",this.panel.innerHTML=this.createPanelHTML(),document.body.appendChild(this.panel),this.attachEvents(),this.loadCSS(),this.isAdminMode&&this.addToAdminMenu(),document.addEventListener("keydown",e=>{e.altKey&&"d"===e.key.toLowerCase()&&this.toggle()}),console.log("[DataExporter] ‚úÖ Console analytique initialis√©e (Alt+D)")}loadCSS(){const e=document.createElement("link");e.rel="stylesheet",e.href="css/data-exporter.css",document.head.appendChild(e)}addToAdminMenu(){const e=document.querySelector("[data-admin-menu]")||document.querySelector(".admin-menu")||document.getElementById("admin-menu");if(e&&this.isAdminMode){const t=document.createElement("button");t.className="admin-menu-item admin-analytics-btn",t.innerHTML="üìä Analytics",t.title="Ouvrir la console de donn√©es (Alt+D)",t.addEventListener("click",()=>this.toggle()),e.appendChild(t)}}createPanelHTML(){return'\n            <div class="exporter-header">\n                <div class="exporter-title">üìä Donn√©es analytiques</div>\n                <button class="exporter-close">&times;</button>\n            </div>\n\n            <div class="exporter-tabs">\n                <button class="exporter-tab active" data-tab="summary">R√©sum√©</button>\n                <button class="exporter-tab" data-tab="stops">Arr√™ts</button>\n                <button class="exporter-tab" data-tab="delays">Retards</button>\n                <button class="exporter-tab" data-tab="export">Export</button>\n            </div>\n\n            <div class="exporter-content">\n                \x3c!-- R√©sum√© --\x3e\n                <div class="exporter-tab-content active" id="tab-summary">\n                    <div class="summary-stats"></div>\n                </div>\n\n                \x3c!-- Arr√™ts --\x3e\n                <div class="exporter-tab-content" id="tab-stops">\n                    <div class="stops-table"></div>\n                </div>\n\n                \x3c!-- Retards --\x3e\n                <div class="exporter-tab-content" id="tab-delays">\n                    <div class="delays-content"></div>\n                </div>\n\n                \x3c!-- Export --\x3e\n                <div class="exporter-tab-content" id="tab-export">\n                    <div class="export-buttons">\n                        <button class="export-btn" data-format="stops-csv">üì• Arr√™ts (CSV)</button>\n                        <button class="export-btn" data-format="delays-csv">üì• Retards (CSV)</button>\n                        <button class="export-btn" data-format="all-json">üì• Tout (JSON)</button>\n                    </div>\n                </div>\n            </div>\n        '}attachEvents(){this.panel.querySelectorAll(".exporter-tab").forEach(e=>{e.addEventListener("click",e=>this.switchTab(e.target.dataset.tab))}),this.panel.querySelector(".exporter-close").addEventListener("click",()=>this.close()),this.panel.querySelectorAll(".export-btn").forEach(e=>{e.addEventListener("click",e=>this.export(e.target.dataset.format))})}toggle(){this.isOpen?this.close():this.open()}open(){this.panel.classList.add("open"),this.isOpen=!0,this.refreshData()}close(){this.panel.classList.remove("open"),this.isOpen=!1}switchTab(e){this.currentTab=e,this.panel.querySelectorAll(".exporter-tab").forEach(e=>{e.classList.remove("active")}),this.panel.querySelector(`[data-tab="${e}"]`).classList.add("active"),this.panel.querySelectorAll(".exporter-tab-content").forEach(e=>{e.classList.remove("active")}),this.panel.querySelector(`#tab-${e}`).classList.add("active"),this.refreshData()}refreshData(){switch(this.currentTab){case"summary":this.showSummary();break;case"stops":this.showStops();break;case"delays":this.showDelays()}}showSummary(){const e=this.panel.querySelector(".summary-stats"),t=w.getStopStats(),o=w.getDelayStats();let r='<div class="stat-cards">';if(t&&t.length>0&&(r+=`\n                <div class="stat-card">\n                    <div class="stat-label">Arr√™t #1</div>\n                    <div class="stat-value">Stop ${t[0].stopId}</div>\n                    <div class="stat-detail">${t[0].clicks} clics</div>\n                </div>\n            `),o&&o.lineStats.length>0){const e=o.lineStats[0];r+=`\n                <div class="stat-card">\n                    <div class="stat-label">Ligne retard√©e</div>\n                    <div class="stat-value">${e.lineId}</div>\n                    <div class="stat-detail">${Math.floor(e.averageDelay/60)}m moyen</div>\n                </div>\n            `}r+=`\n            <div class="stat-card">\n                <div class="stat-label">Total observations</div>\n                <div class="stat-value">${o?o.totalObservations:0}</div>\n            </div>\n        </div>`,e.innerHTML=r}showStops(){const e=this.panel.querySelector(".stops-table"),t=w.getStopStats();if(!t||0===t.length)return void(e.innerHTML='<p class="no-data">Aucune donn√©e</p>');let o='\n            <table class="data-table">\n                <thead>\n                    <tr>\n                        <th>Rang</th>\n                        <th>Stop ID</th>\n                        <th>Clics</th>\n                    </tr>\n                </thead>\n                <tbody>\n        ';t.slice(0,20).forEach((e,t)=>{o+=`<tr><td>${t+1}</td><td>${e.stopId}</td><td>${e.clicks}</td></tr>`}),o+="</tbody></table>",e.innerHTML=o}showDelays(){const e=this.panel.querySelector(".delays-content"),t=w.getDelayStats();if(!t)return void(e.innerHTML='<p class="no-data">Aucune donn√©e</p>');let o='<div class="delays-tabs">';o+='<div class="delays-section"><h3>Par ligne</h3>',o+='<table class="data-table"><thead><tr><th>Ligne</th><th>Moyen</th><th>Max</th><th>Majeurs</th></tr></thead><tbody>',t.lineStats.forEach(e=>{const t=Math.floor(e.averageDelay/60),r=Math.floor(e.maxDelay/60);o+=`<tr><td>${e.lineId}</td><td>${t}m</td><td>${r}m</td><td>${e.majorDelayCount}</td></tr>`}),o+="</tbody></table></div>",o+='<div class="delays-section"><h3>Par heure (top 10)</h3>',o+='<table class="data-table"><thead><tr><th>Heure</th><th>Retard moyen</th><th>Obs</th></tr></thead><tbody>',t.hourlyStats.slice(0,10).forEach(e=>{const t=Math.floor(e.averageDelay/60);o+=`<tr><td>${e.hour}</td><td>${t}m</td><td>${e.observations}</td></tr>`}),o+="</tbody></table></div>",o+="</div>",e.innerHTML=o}export(e){switch(e){case"stops-csv":w.exportStopsToCSV();break;case"delays-csv":w.exportDelaysToCSV();break;case"all-json":w.exportAllJSON()}}}class w{static getStopStats(){if(!window.analyticsManager)return console.warn("analyticsManager non disponible"),null;const e=window.analyticsManager.stopClickStats||new Map,t=Array.from(e.entries()).map(([e,t])=>({stopId:e,clicks:t,frequency:"high"})).sort((e,t)=>t.clicks-e.clicks).slice(0,50);return console.log(`üìä ${t.length} arr√™ts les plus fr√©quent√©s:`),t.forEach((e,t)=>{console.log(`${t+1}. Stop ${e.stopId}: ${e.clicks} clics`)}),t}static getDelayStats(){if(!window.delayManager)return console.warn("delayManager non disponible"),null;const e=window.delayManager.getDelayStats();return console.log("\nüìà RETARDS PAR LIGNE:"),e.lineStats.forEach(e=>{console.log(`\nLigne ${e.lineId}:\n  - Retard moyen: ${Math.floor(e.averageDelay/60)}m ${e.averageDelay%60}s\n  - Retard max: ${Math.floor(e.maxDelay/60)}m\n  - Retards majeurs (>5min): ${e.majorDelayCount}\n  - Observations: ${e.observations}`)}),console.log("\n‚è∞ RETARDS PAR HEURE:"),e.hourlyStats.forEach(e=>{console.log(`${e.hour}: ${Math.floor(e.averageDelay/60)}m avg (${e.observations} obs)`)}),console.log("\nüöè ARR√äTS LES PLUS AFFECT√âS:"),e.worstStops.slice(0,10).forEach((e,t)=>{console.log(`${t+1}. Stop ${e.stopId}: ${Math.floor(e.averageDelay/60)}m avg`)}),e}static exportStopsToCSV(){const e=this.getStopStats();if(!e)return;let t="Rang,Stop ID,Clics\n";e.forEach((e,o)=>{t+=`${o+1},${e.stopId},${e.clicks}\n`}),this.downloadFile(t,"stops_frequents.csv")}static exportDelaysToCSV(){var e;const t=null==(e=window.delayManager)?void 0:e.getDelayStats();if(!t)return void console.warn("delayManager non disponible pour export");let o="Ligne,Retard Moyen (sec),Retard Max (sec),Majeurs,Observations\n";t.lineStats.forEach(e=>{o+=`${e.lineId},${e.averageDelay},${e.maxDelay},${e.majorDelayCount},${e.observations}\n`}),this.downloadFile(o,"retards_par_ligne.csv"),o="Heure,Retard Moyen (sec),Observations\n",t.hourlyStats.forEach(e=>{o+=`${e.hour},${e.averageDelay},${e.observations}\n`}),this.downloadFile(o,"retards_par_heure.csv")}static exportAllJSON(){var e;const t=window.delayManager,o={timestamp:(new Date).toISOString(),stops:this.getStopStats(),delays:(null==t?void 0:t.getDelayStats())||null,rawHistory:(null==(e=null==t?void 0:t.delayHistory)?void 0:e.slice(-1e3))||[]},r=JSON.stringify(o,null,2);this.downloadFile(r,"perimap_data_export.json","application/json")}static downloadFile(e,t,o="text/csv"){const r=new Blob([e],{type:o}),s=URL.createObjectURL(r),n=document.createElement("a");n.href=s,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s),console.log(`‚úÖ Fichier t√©l√©charg√©: ${t}`)}static summary(){console.clear(),console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),console.log("üìä EXTRAIT DES DONN√âES ANALYTIQUES"),console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");const e=this.getStopStats(),t=this.getDelayStats();if(e&&e.length>0&&console.log(`\nüèÜ Arr√™t #1: Stop ${e[0].stopId} (${e[0].clicks} clics)`),t){const e=t.lineStats[0];e&&console.log(`\n‚ö†Ô∏è Ligne la plus retard√©e: ${e.lineId} (${Math.floor(e.averageDelay/60)}m moyen)`)}console.log("\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"),console.log("Commandes disponibles:"),console.log("  DataExporter.getStopStats()      ‚Üí Arr√™ts"),console.log("  DataExporter.getDelayStats()     ‚Üí Retards"),console.log("  DataExporter.exportStopsToCSV()  ‚Üí T√©l√©ch. CSV"),console.log("  DataExporter.exportDelaysToCSV() ‚Üí T√©l√©ch. CSV"),console.log("  DataExporter.exportAllJSON()     ‚Üí Tout en JSON"),console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n")}}function _(e){if(null==e)return"";return String(e).toLowerCase().replace(/terminus\b/gi," ").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[()\[\]{}]/g," ").replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim()}function T(e,t){return function(e,t){const o=_(e),r=_(t);return!(!o||!r)&&o===r}(e,t)}"undefined"!=typeof window&&(window.DataExporter=w,window.getStops=()=>w.getStopStats(),window.getDelays=()=>w.getDelayStats(),window.exportData=()=>w.exportAllJSON());const b={les01:"304",MRo01:"267",HOC02:"162",PBa01:"129",OMN02:"33",Cle02:"279",CRX02:"530",Ros02:"242",Ron02:"744",Glc01:"12412",COU01:"204",CHo01:"193",Vil01:"98",CFr01:"285",pre02:"284",Doj01:"303",Ros01:"244",Lpt01:"12411",GSG01:"340",Gue02:"290",AUG01:"47",Ver01:"526",bar01:"71",Aut02:"2",TGA01:"94",CRO02:"86",VED01:"136",CFo04:"810",AGO01:"83",Dur01:"257",bar02:"72",MEd02:"139",Tra01:"607",Mdx02:"282",TrM02:"12381",ESG01:"278",SPO02:"25",BTO01:"34",LAC03:"353",GMO02:"80",BUG02:"46",ITi01:"12379",Mil02:"673",Tai01:"12359",PHa01:"351",Mds01:"151",Sul01:"799",SOM02:"66",tou04:"687",PEP01:"55",ChA04:"515",MAN02:"82",MPA01:"88",VHu02:"315",FLE02:"11",Can02:"131",Bor01:"146",PEM03:"755",LYA02:"185",PRo01:"208",SNC02:"43",CCh02:"273",Bbe02:"12345",CST02:"62",POS01:"20",Lil02:"192",Sul02:"805",tou03:"724",Ple01:"12374",Gue01:"289",PLA01:"299",BoI02:"459",Lon02:"616",Clu01:"753",BFr01:"689",Cco01:"669",VST02:"31",CIO02:"41",PBE01:"18",BPa02:"323",TPD02:"60",CLA02:"275",COM01:"159",Les02:"305",CxB02:"343",PMa02:"263",SOM01:"65",Ver03:"156",CRX01:"291",Erm02:"222",Mou02:"97",Ron01:"738",COU02:"203",Pen01:"209",Rud02:"224",Vil02:"99",FMa01:"186",par02:"171",GSG02:"341",RtA01:"698",Ver02:"276",Cit02:"110",AVJ02:"9",VED02:"137",RPJ02:"7",CAR01:"67",Pen02:"12366",Val01:"376",Chb01:"214",SGE01:"201",Tra02:"608",CDa01:"221",Mds02:"150",mon01:"345",Ru02:"271",GMO01:"79",cha01:"347",Hal01:"809",Prm02:"293",PEM01:"12343",Cit01:"109",RtR01:"704",ITi02:"12382",CEC01:"12",Tai02:"375",PHa02:"352",Hor01:"239",Amp01:"320",Ars01:"132",PEP02:"56",Maj02:"458",CEC02:"13",CFr02:"286",Pis02:"58",Mah02:"12368",Ebe01:"265",PRo02:"12367",TBa02:"235",CLB02:"529",Feu01:"154",Bon02:"12365",OdG02:"350",SEV01:"38",BEa02:"12362",Rom02:"197",RPT02:"93",Puy01:"266",Jau01:"260",FER02:"37",maz01:"206",BoI01:"218",OMN01:"32",BFr02:"691",TRo02:"200",Aru02:"240","4rt01":"301",PBa02:"675",Dur02:"736",Pag02:"656",mon02:"346",HOC01:"161",CxB03:"344",Doj02:"630",FER01:"36",Por01:"251",Mrl01:"714",Cle01:"280",PEX01:"16",RtA02:"708",Ver04:"697",FMa02:"12344",Aut01:"1",PEC01:"28",Sar01:"817",BLZ01:"525",Pag01:"181",PoI02:"12384",Gre01:"219",par01:"170",MaF01:"12369",Sau01:"77",Mdx01:"281",Tac01:"3",PEM02:"747",LAC01:"534",Jal02:"153",Pl802:"12372",MGr01:"135",CRO01:"85",AvC01:"701",MEd01:"138",Val02:"538",ESA01:"517",ERo01:"236",EMa01:"142",CRe01:"548",ESG02:"277",REY01:"14",SPO01:"24",Por02:"535",BTO02:"35",Pri01:"749",adm01:"253",FDH01:"51",LYA01:"184",pre01:"283",PEX02:"17",CCh01:"272",Mil01:"653",ZAE01:"5",ERo02:"237",POS02:"23",Mrl02:"715",FDH02:"52",TOU01:"661",FBo02:"693",MAN01:"81",MPA02:"89",Ars02:"133",Maj01:"457",Pri02:"750",Lon01:"216",EMa02:"143",SNC01:"42",Sil01:"27",CST01:"61",Lil01:"191",CIO01:"40",Cde01:"12358",BPa01:"324",RPJ01:"6",COM02:"160",Rom01:"198",TOU02:"718",PLA02:"300",BdS01:"703",PEM04:"757",Clu02:"754",CDa02:"220",Cco02:"670",TRo01:"199",Aru01:"241",TPD01:"59",VST01:"29",LAB01:"140",AMa02:"288",AMa01:"287",Lpt02:"12410",Iza02:"104",PoI01:"12383",Dou02:"311",ZAE02:"713",BPU01:"12377",Erm01:"223",Mou01:"96",BUG01:"45",cam01:"811",BLZ02:"87",AVJ01:"8",Mer01:"572",CAR02:"68",Iza01:"103",FLE01:"10",LAB02:"141",Bad01:"748",HMa01:"700",Ru01:"270",Ebe02:"12346",PCa01:"685",LAC02:"54",Prm01:"292",Jal01:"152",Pl801:"12371",MGr01:"134",PLB01:"73",SGE02:"202",BPU02:"30",REY02:"15",aqu01:"231",cha02:"348",Hor02:"238",CFo03:"550",VHu01:"316",Can01:"130",Mah01:"207",Doj04:"732",Bor02:"147",PBE02:"19",Pis01:"57",Tbg01:"325",adm02:"597",Lav01:"309",CRe02:"593",Bbe01:"217",Suc01:"498",Dou01:"310",PLB02:"74",Bon01:"210",SEV02:"39",Amp02:"319",FBo01:"692",RPT01:"92",Rud01:"225",PMa01:"262",maz02:"205",TBa01:"234","4rt02":"302",Feu02:"26",OdG01:"349",CLB01:"296",BEa01:"213",CLA01:"527",Cde02:"12378"};let I=null;function E(e,t=null){if(t&&b[t])return b[t];if(I&&I.has(e)){const t=I.get(e);if(b[t])return b[t]}const o=e.match(/^([A-Za-z]{2,4}\d{2})$/);return o&&b[o[1]]?b[o[1]]:null}function M(e,t=null){return null!==E(e,t)}const A=new class{constructor(){this.STORAGE_KEYS={STOP_CLICKS:"perimap_analytics_stop_clicks",ROUTE_CLICKS:"perimap_analytics_route_clicks",STOP_PLACE_CLICKS:"perimap_analytics_stopplace_clicks",SESSION_DATA:"perimap_analytics_session",PRELOAD_PRIORITY:"perimap_analytics_preload_priority"},this.stopClicks=new Map,this.routeClicks=new Map,this.stopPlaceClicks=new Map,this.sessionData={startTime:Date.now(),totalClicks:0,totalStopsViewed:0},this.MAX_HISTORY_ENTRIES=1e3,this.PERSISTENCE_INTERVAL=3e4,this.init()}init(){this.loadFromStorage(),setInterval(()=>this.saveToStorage(),this.PERSISTENCE_INTERVAL),console.log("[Analytics] Gestionnaire analytique initialis√©")}trackStopClick(e,t){if(!e)return;const o=`${e}_${t}`,r=this.stopClicks.get(o)||{stopId:e,stopName:t,count:0,lastClick:null,firstClick:Date.now()};r.count++,r.lastClick=Date.now(),this.stopClicks.set(o,r),this.sessionData.totalClicks++,this.sessionData.totalStopsViewed++,r.count}trackStopPlaceClick(e,t){if(!e)return;const o=`${e}_${t}`,r=this.stopPlaceClicks.get(o)||{stopPlaceId:e,stopPlaceName:t,count:0,lastClick:null,firstClick:Date.now()};r.count++,r.lastClick=Date.now(),this.stopPlaceClicks.set(o,r),this.sessionData.totalClicks++,r.count}trackRouteClick(e,t){if(!e)return;const o=t||e,r=this.routeClicks.get(o)||{routeId:e,routeShortName:t||e,count:0,lastClick:null,firstClick:Date.now()};r.count++,r.lastClick=Date.now(),this.routeClicks.set(o,r),this.sessionData.totalClicks++,r.count}getTopStops(e=10){return Array.from(this.stopClicks.values()).sort((e,t)=>t.count-e.count).slice(0,e)}getTopStopPlaces(e=10){return Array.from(this.stopPlaceClicks.values()).sort((e,t)=>t.count-e.count).slice(0,e)}getTopRoutes(e=10){return Array.from(this.routeClicks.values()).sort((e,t)=>t.count-e.count).slice(0,e)}computePreloadPriority(){const e={stops:this.getTopStops(20),stopPlaces:this.getTopStopPlaces(10),routes:this.getTopRoutes(10)};return console.log("[Analytics] Priorit√©s de pr√©chargement calcul√©es:",e),e}saveToStorage(){try{const e=Array.from(this.stopClicks.values()).sort((e,t)=>t.count-e.count).slice(0,this.MAX_HISTORY_ENTRIES),t=Array.from(this.stopPlaceClicks.values()).sort((e,t)=>t.count-e.count).slice(0,this.MAX_HISTORY_ENTRIES),o=Array.from(this.routeClicks.values()).sort((e,t)=>t.count-e.count).slice(0,this.MAX_HISTORY_ENTRIES);localStorage.setItem(this.STORAGE_KEYS.STOP_CLICKS,JSON.stringify(e)),localStorage.setItem(this.STORAGE_KEYS.STOP_PLACE_CLICKS,JSON.stringify(t)),localStorage.setItem(this.STORAGE_KEYS.ROUTE_CLICKS,JSON.stringify(o));const r={lastUpdate:Date.now(),sessionStartTime:this.sessionData.startTime,totalClicks:this.sessionData.totalClicks,totalStopsViewed:this.sessionData.totalStopsViewed};localStorage.setItem(this.STORAGE_KEYS.SESSION_DATA,JSON.stringify(r))}catch(e){console.warn("[Analytics] Erreur lors de la sauvegarde:",e.message)}}loadFromStorage(){try{const e=JSON.parse(localStorage.getItem(this.STORAGE_KEYS.STOP_CLICKS))||[],t=JSON.parse(localStorage.getItem(this.STORAGE_KEYS.STOP_PLACE_CLICKS))||[],o=JSON.parse(localStorage.getItem(this.STORAGE_KEYS.ROUTE_CLICKS))||[];e.forEach(e=>{const t=`${e.stopId}_${e.stopName}`;this.stopClicks.set(t,e)}),t.forEach(e=>{const t=`${e.stopPlaceId}_${e.stopPlaceName}`;this.stopPlaceClicks.set(t,e)}),o.forEach(e=>{const t=e.routeShortName||e.routeId;this.routeClicks.set(t,e)}),console.log("[Analytics] Donn√©es charg√©es depuis localStorage"),console.log(`  - ${this.stopClicks.size} arr√™ts`),console.log(`  - ${this.stopPlaceClicks.size} stop places`),console.log(`  - ${this.routeClicks.size} lignes`)}catch(e){console.warn("[Analytics] Erreur lors du chargement:",e.message)}}getStatistics(){return{sessionData:this.sessionData,uniqueStops:this.stopClicks.size,uniqueStopPlaces:this.stopPlaceClicks.size,uniqueRoutes:this.routeClicks.size,topStops:this.getTopStops(5),topStopPlaces:this.getTopStopPlaces(5),topRoutes:this.getTopRoutes(5),preloadPriority:this.computePreloadPriority()}}reset(){this.stopClicks.clear(),this.routeClicks.clear(),this.stopPlaceClicks.clear(),this.sessionData={startTime:Date.now(),totalClicks:0,totalStopsViewed:0},localStorage.removeItem(this.STORAGE_KEYS.STOP_CLICKS),localStorage.removeItem(this.STORAGE_KEYS.ROUTE_CLICKS),localStorage.removeItem(this.STORAGE_KEYS.STOP_PLACE_CLICKS),console.log("[Analytics] Donn√©es r√©initialis√©es")}},C={majeures:{name:"Lignes majeures",lines:["A","B","C","D"],color:"#2563eb"},express:{name:"Lignes express",lines:["e1","e2","e4","e5","e6","e7"],color:"#dc2626"},quartier:{name:"Lignes de quartier",lines:["K1A","K1B","K2","K3A","K3B","K4A","K4B","K5","K6"],color:"#059669"},rabattement:{name:"Lignes de rabattement",lines:["R1","R2","R3","R4","R5","R6","R7","R8","R9","R10","R11","R12","R13","R14","R15"],color:"#7c3aed"},navettes:{name:"Navettes",lines:["N","N1"],color:"#f59e0b"}},$={A:"grandperigueux_fiche_horaires_ligne_A_sept_2025.pdf",B:"grandperigueux_fiche_horaires_ligne_B_sept_2025.pdf",C:"grandperigueux_fiche_horaires_ligne_C_sept_2025.pdf",D:"grandperigueux_fiche_horaires_ligne_D_sept_2025.pdf",e1:"grandperigueux_fiche_horaires_ligne_e1_sept_2025.pdf",e2:"grandperigueux_fiche_horaires_ligne_e2_sept_2025.pdf",e4:"grandperigueux_fiche_horaires_ligne_e4_sept_2025.pdf",e5:"grandperigueux_fiche_horaires_ligne_e5_sept_2025.pdf",e6:"grandperigueux_fiche_horaires_ligne_e6_sept_2025.pdf",e7:"grandperigueux_fiche_horaires_ligne_e7_12_janvier.pdf",K1A:"grandperigueux_K1A_12_janv_26.pdf",K1B:"grandperigueux_fiche_horaires_ligne_k1B_12_janvier.pdf",K2:"grandperigueux_fiche_horaires_ligne_k2_12_janvier.pdf",K3A:"grandperigueux_fiche_horaires_ligne_K3A_sept_2025.pdf",K3B:"grandperigueux_fiche_horaires_ligne_K3B_sept_2025.pdf",K4A:"grandperigueux_fiche_horaires_ligne_K4A_sept_2025.pdf",K4B:"grandperigueux_fiche_horaires_ligne_K4B_sept_2025.pdf",K5:"grandperigueux_fiche_horaires_ligne_K5_sept_2025.pdf",K6:"grandperigueux_fiche_horaires_ligne_K6_sept_2025.pdf",N:"grandperigueux_fiche_horaires_ligne_N_sept_2025.pdf",N1:"grandperigueux_fiche_horaires_ligne_N1_sept_2025.pdf"},k={A:"ZAE Marsac <> Centre Hospitalier",B:"Les Tournesols <> Gare SNCF",C:"ZAE Marsac <> P+R Aquacap",D:"P+R Charrieras <> Tourny",e1:"ZAE Marsac <> P+R Aquacap",e2:"Talleyrand P√©rigord <> Fromarsac",e4:"Charrieras <> La Feuilleraie <> Tourny",e5:"Les Tournesols <> PEM",e6:"Cr√©avall√©e <> Tr√©sorerie municipale",e7:"Notre-Dame de Sanilhac poste <> Les Lilas h√¥pital",K1A:"Maison Rouge <> Tourny / La Rudeille <> Tourny",K1B:"Le Lac <> P√¥le universitaire Grenadi√®re <> Taillefer",K2:"Champcevinel bourg <> Tourny",K3A:"La Feuilleraie <> Place du 8 mai",K3B:"P√©pini√®re <> Place du 8 mai",K4A:"Sarrazi <> Dojo d√©partemental <> Tourny",K4B:"Coulounieix bourg <> Tourny",K5:"Halte ferroviaire Boulazac <> La Feuilleraie",K6:"Halte ferroviaire Marsac sur l'Isle",N:"Tourny <> PEM",N1:"Gare SNCF <> 8 mai <> Tourny <> Gare SNCF"};function B(e){for(const[t,o]of Object.entries(C))if(o.lines.includes(e))return t;return"autres"}const x=new class{constructor(){this.proxyUrl="/api/realtime",this.cache=new Map,this.cacheMaxAge=3e4,this.preloadedStops=new Set,this.isAvailable=!1,this.lastError=null,this.stops=null,this.stats={requests:0,successes:0,failures:0,preloadRequests:0,preloadSuccesses:0,preloadFailures:0},this.preloadConfig={mainLinesOnly:!0,preloadTopStops:!0,maxPreloadRequests:50,delayBetweenRequests:100},this.isPreloading=!1}init(e,t=!0){this.stops=e,function(e){if(e&&0!==e.length){I=new Map;for(const t of e)t.stop_id&&t.stop_code&&I.set(t.stop_id,t.stop_code);console.log(`[StopKeyMapping] ${I.size} mappings stop_id -> stop_code charg√©s`)}else console.warn("[StopKeyMapping] Pas de stops fournis pour le mapping")}(e),t&&setTimeout(()=>this.preloadMainLinesAndTopStops(),500)}async preloadMainLinesAndTopStops(){if(this.isPreloading)console.warn("[Realtime] Pr√©chargement d√©j√† en cours");else{this.isPreloading=!0,console.log("[Realtime] üöÄ D√©marrage du pr√©chargement intelligent...");try{const e=new Set;if(this.preloadConfig.mainLinesOnly&&this.stops){C.majeures.lines,C.express.lines;this.stops.forEach(t=>{M(t.stop_id,t.stop_code)&&e.add(t)}),console.log(`[Realtime] ${e.size} arr√™ts avec temps r√©el actif identifi√©s`)}if(this.preloadConfig.preloadTopStops&&A){const t=A.getTopStops(20);t.forEach(t=>{if(this.stops){const o=this.stops.find(e=>e.stop_id===t.stopId);o&&M(o.stop_id,o.stop_code)&&e.add(o)}}),console.log(`[Realtime] +${t.length} arr√™ts populaires identifi√©s`)}const t=Array.from(e).slice(0,this.preloadConfig.maxPreloadRequests),o=10;let r=0,s=0;for(let n=0;n<t.length;n+=o){const e=t.slice(n,n+o).map((e,t)=>new Promise(o=>{setTimeout(async()=>{try{await this.getRealtimeForStop(e.stop_id,e.stop_code),this.preloadedStops.add(e.stop_id),r++,o()}catch(t){s++,o()}},t*this.preloadConfig.delayBetweenRequests)}));await Promise.all(e),console.log(`[Realtime] Batch ${Math.floor(n/o)+1}/${Math.ceil(t.length/o)} compl√©t√©`)}this.stats.preloadRequests=t.length,this.stats.preloadSuccesses=r,this.stats.preloadFailures=s,console.log(`[Realtime] ‚úÖ Pr√©chargement termin√©: ${r} succ√®s, ${s} erreurs`)}catch(e){console.error("[Realtime] Erreur lors du pr√©chargement:",e)}finally{this.isPreloading=!1}}}getPreloadStatus(){return{isPreloading:this.isPreloading,preloadedStopsCount:this.preloadedStops.size,stats:{preloadRequests:this.stats.preloadRequests,preloadSuccesses:this.stats.preloadSuccesses,preloadFailures:this.stats.preloadFailures,totalRequests:this.stats.requests,totalSuccesses:this.stats.successes,totalFailures:this.stats.failures},cacheSize:this.cache.size}}async getRealtimeForStop(e,t=null){if(!M(e,t))return null;const o=E(e,t);if(!o)return null;const r=`hawk_${o}`,s=this.cache.get(r);if(s&&Date.now()-s.fetchedAt<this.cacheMaxAge)return s.data;this.stats.requests++;try{const e=await fetch(`${this.proxyUrl}?stop=${o}`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(1e4)});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();return this.cache.set(r,{data:t,fetchedAt:Date.now()}),this.isAvailable=!0,this.lastError=null,this.stats.successes++,console.log(`[Realtime] ‚úÖ Donn√©es re√ßues pour hawk:${o}:`,t.count,"d√©parts"),t}catch(n){return console.warn(`[Realtime] Erreur pour arr√™t ${e} (hawk:${o}):`,n.message),this.lastError=n.message,this.stats.failures++,null}}async getRealtimeForStopPlace(e){if(!this.stops)return console.warn("[Realtime] Stops non initialis√©s, appeler init() d'abord"),null;const t=function(e,t){const o=[];if(!t)return o;for(const r of t)if(r.parent_station===e&&r.stop_code){const e=b[r.stop_code];e&&o.push({stopId:r.stop_id,stopCode:r.stop_code,hawkKey:e})}return o}(e,this.stops);if(0===t.length)return null;console.log(`[Realtime] StopPlace ${e} -> ${t.length} quais: ${t.map(e=>e.stopCode).join(", ")}`);const o=[];for(const{stopId:r,stopCode:s,hawkKey:n}of t){const e=await this.getRealtimeForStop(r,s);e&&e.departures&&o.push(...e.departures.map(e=>({...e,quay:s,hawkKey:n})))}return 0===o.length?null:(o.sort((e,t)=>this.parseTime(e.time)-this.parseTime(t.time)),{stopPlaceId:e,timestamp:(new Date).toISOString(),departures:o.slice(0,10),count:o.length})}parseTime(e){if(!e)return 1/0;const t=e.match(/(\d{2}):(\d{2})/);return t?60*parseInt(t[1])+parseInt(t[2]):1/0}mergeWithStatic(e,t){if(!t||!t.schedules||0===t.schedules.length)return e.map(e=>({...e,isRealtime:!1}));const o=new Map;t.schedules.forEach((e,t)=>{const r=`${this.normalizeLigne(e.ligne)}_${this.normalizeDestination(e.destination)}`;o.has(r)||o.set(r,[]),o.get(r).push({...e,_index:t})});const r=[],s=new Set;for(const n of e){const e=this.normalizeLigne(n.routeShortName||n.routeId),a=`${e}_${this.normalizeDestination(n.destination)}`;let i=null;const l=o.get(a)||[];for(const t of l)if(!s.has(t._index)){i=t,s.add(t._index);break}if(!i)for(const o of t.schedules){if(s.has(o._index))continue;if(this.normalizeLigne(o.ligne)===e){i=o,s.add(t.schedules.indexOf(o));break}}if(i){const e=this.parseTemps(i.temps);r.push({...n,isRealtime:!0,realtimeMinutes:e,realtimeText:i.temps,realtimeDestination:i.destination,realtimeQuai:i.quai,realtimeIsTheoretical:i.theoretical||!1})}else r.push({...n,isRealtime:!1})}for(let n=0;n<t.schedules.length;n++)if(!s.has(n)){const e=t.schedules[n];r.push({routeId:e.ligne,routeShortName:e.ligne,destination:e.destination,isRealtime:!0,realtimeMinutes:this.parseTemps(e.temps),realtimeText:e.temps,realtimeQuai:e.quai,realtimeIsTheoretical:e.theoretical||!1,isExtraRealtime:!0})}return r.sort((e,t)=>(e.isRealtime?e.realtimeMinutes:this.getMinutesFromTime(e.time))-(t.isRealtime?t.realtimeMinutes:this.getMinutesFromTime(t.time))),r}normalizeLigne(e){return e?String(e).toUpperCase().replace(/[^A-Z0-9]/g,""):""}normalizeDestination(e){if(!e)return"";const t=String(e).normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase().replace(/[^A-Z0-9\s]/g,"").trim();return t.split(/\s+/).filter(e=>e.length>2)[0]||t}parseTemps(e){if(!e)return 999;const t=e.toLowerCase().trim(),o=t.match(/(\d+)\s*min/);if(o)return parseInt(o[1],10);if(t.includes("approche")||t.includes("imminent")||"0"===t)return 0;const r=e.match(/(\d{1,2}):(\d{2})/);if(r){const e=new Date;let t=60*parseInt(r[1],10)+parseInt(r[2],10)-(60*e.getHours()+e.getMinutes());return t<0&&(t+=1440),t}return 999}getMinutesFromTime(e){if(!e)return 999;const t=e.match(/(\d{1,2}):(\d{2})/);if(!t)return 999;const o=new Date,r=60*o.getHours()+o.getMinutes();let s=60*parseInt(t[1],10)+parseInt(t[2],10)-r;return s<-60&&(s+=1440),s}clearCache(){this.cache.clear()}hasRealtimeDataForStop(e,t=null){const o=E(e,t);if(!o)return!1;const r=`hawk_${o}`,s=this.cache.get(r);return!!(s&&Date.now()-s.fetchedAt<this.cacheMaxAge)&&(s.data&&s.data.count>0)}},D=Object.freeze({url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",options:{attribution:"¬© OpenStreetMap contributors",maxZoom:19}}),R=Object.freeze({url:"https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",options:{attribution:"¬© OpenStreetMap contributors, ¬© CARTO",maxZoom:19,subdomains:"abcd"}});class P{constructor(e,t,o){this.mapElementId=e,this.map=null,this.busMarkers={},this.routeLayer=null,this.routeLayersById={},this.selectedRoute=null,this.centerCoordinates=[45.1833,.7167],this.zoomLevel=16,this.tempStopMarker=null,this.stopLayer=null,this.dataManager=t,this.timeManager=o,this.busPopup=null,this.busPopupDomElement=null,this.selectedBusId=null,this.userLocationMarker=null,this.locateControl=null,this.locateButtonElement=null,this.activeTileLayer=null,this.currentTheme=null,this.isDarkTheme=!1,this.clusterGroup=L.markerClusterGroup({spiderfyOnMaxZoom:!0,showCoverageOnHover:!1,zoomToBoundsOnClick:!0,disableClusteringAtZoom:16})}initializeMap(e=!0){var t,o;this.map=L.map(this.mapElementId,{zoomControl:!1}).setView(this.centerCoordinates,this.zoomLevel);const r="undefined"!=typeof document&&(null==(o=null==(t=document.body)?void 0:t.classList)?void 0:o.contains("dark-theme"));this.applyTheme(r),L.control.zoom({position:"topright"}).addTo(this.map),this.stopLayer=L.layerGroup().addTo(this.map),e&&this.map.addLayer(this.clusterGroup),console.log(`üó∫Ô∏è Carte ${this.mapElementId} initialis√©e`),this.map.on("click",()=>{this.tempStopMarker&&(this.map.removeLayer(this.tempStopMarker),this.tempStopMarker=null)}),this.busPopupDomElement=this.createBusPopupDomElement(),this.busPopup=L.popup({maxWidth:280,minWidth:280,autoClose:!0,closeOnClick:!0,closeButton:!0,autoPan:!1,autoPanPadding:[0,0],className:"bus-popup-container"}),this.busPopup.on("remove",()=>{this.selectedBusId=null}),this.isMapMoving=!1,this.map.on("movestart zoomstart",()=>{this.isMapMoving=!0}),this.map.on("moveend zoomend",()=>{this.isMapMoving=!1})}applyTheme(e){if(!this.map)return;const t=e?"dark":"light",o=this.currentTheme!==t;this.activeTileLayer&&(this.map.removeLayer(this.activeTileLayer),this.activeTileLayer=null);const r=e?R:D;this.activeTileLayer=L.tileLayer(r.url,r.options).addTo(this.map),this.currentTheme=t,this.isDarkTheme=e,o&&this.restyleRouteLayers()}getRouteStyle(e){return{color:this.getRouteColorForTheme(e),weight:this.isDarkTheme?3.5:4,opacity:this.isDarkTheme?.72:.85,lineCap:"round",lineJoin:"round"}}getRouteColorForTheme(e){const t=this.normalizeHexColor(e);return t?this.isDarkTheme?this.lightenColor(t,.2):t:"#3388ff"}normalizeHexColor(e){if(!e)return null;const t=e.startsWith("#")?e:`#${e}`;return/^#([0-9a-fA-F]{6})$/.test(t)?t.toUpperCase():null}lightenColor(e,t=.15){const o=e.replace("#","");if(6!==o.length)return e;const r=parseInt(o,16),s=r>>16&255,n=r>>8&255,a=255&r;return`#${(Math.round(s+(255-s)*t)<<16|Math.round(n+(255-n)*t)<<8|Math.round(a+(255-a)*t)).toString(16).padStart(6,"0")}`}restyleRouteLayers(){this.routeLayersById&&Object.values(this.routeLayersById).forEach(e=>{e.forEach(e=>{e&&e.__baseColor&&e.setStyle(this.getRouteStyle(e.__baseColor))})})}offsetPoint(e,t,o,r,s,n,a){const i=e*Math.PI/180,l=t*Math.PI/180,c=o*Math.PI/180,d=r*Math.PI/180,u=Math.atan2(Math.sin(d-l)*Math.cos(c),Math.cos(i)*Math.sin(c)-Math.sin(i)*Math.cos(c)*Math.cos(d-l))+Math.PI/2,p=s*(n-(a-1)/2)/6371e3,h=Math.asin(Math.sin(i)*Math.cos(p)+Math.cos(i)*Math.sin(p)*Math.cos(u)),m=l+Math.atan2(Math.sin(u)*Math.sin(p)*Math.cos(i),Math.cos(p)-Math.sin(i)*Math.sin(h));return[180*h/Math.PI,180*m/Math.PI]}offsetLineString(e,t,o,r){const s=[];for(let n=0;n<e.length;n++){const[a,i]=e[n];let l,c;n<e.length-1?[l,c]=e[n+1]:[l,c]=e[n-1];const[d,u]=this.offsetPoint(i,a,c,l,t,o,r);s.push([u,d])}return s}displayMultiColorRoutes(e,t,o){if(!e)return void console.warn("Aucune donn√©e GeoJSON √† afficher");this.routeLayer&&this.map.removeLayer(this.routeLayer),this.routeLayer=L.layerGroup().addTo(this.map),this.routeLayersById={};const r=new Map;e.features.forEach(e=>{var t;if(e.geometry&&"LineString"===e.geometry.type){const s=null==(t=e.properties)?void 0:t.route_id;if(!o.has(s))return;const n=JSON.stringify(e.geometry.coordinates);r.has(n)||r.set(n,[]),r.get(n).push(e)}}),r.forEach((e,o)=>{var r,s;const n=e.length;if(1===n){const o=e[0],n=null==(r=o.properties)?void 0:r.route_id,a=n?t.getRoute(n):null,i=(null==a?void 0:a.route_color)||(null==(s=o.properties)?void 0:s.route_color),l=this.normalizeHexColor(i)||"#3388FF",c=L.geoJSON(o,{style:this.getRouteStyle(l)});c.__baseColor=l,n&&(this.routeLayersById[n]||(this.routeLayersById[n]=[]),this.routeLayersById[n].push(c)),this.addRoutePopup(c,e,t),c.addTo(this.routeLayer)}else e.forEach((o,r)=>{var s,a;const i=null==(s=o.properties)?void 0:s.route_id,l=i?t.getRoute(i):null,c=(null==l?void 0:l.route_color)||(null==(a=o.properties)?void 0:a.route_color),d=this.normalizeHexColor(c)||"#3388FF",u={type:"Feature",geometry:{type:"LineString",coordinates:this.offsetLineString(o.geometry.coordinates,3,r,n)},properties:o.properties},p=L.geoJSON(u,{style:this.getRouteStyle(d)});p.__baseColor=d,i&&(this.routeLayersById[i]||(this.routeLayersById[i]=[]),this.routeLayersById[i].push(p)),p.addTo(this.routeLayer),this.addRoutePopup(p,e,t)})})}addRoutePopup(e,t,o){let r="<b>Ligne(s) sur ce trac√©:</b><br>";const s=new Set;t.forEach(e=>{var t;const r=null==(t=e.properties)?void 0:t.route_id,n=o.getRoute(r);n&&s.add(n.route_short_name||r)}),r+=Array.from(s).join(", "),e.bindPopup(r)}updateBusMarkers(e,t,o){const r=[],s=[],n=new Set;e.forEach(e=>n.add(e.tripId)),Object.keys(this.busMarkers).forEach(e=>{if(!n.has(e)){e===this.selectedBusId&&(this.busPopup.close(),this.selectedBusId=null);const t=this.busMarkers[e];s.push(t.marker),delete this.busMarkers[e]}}),e.forEach(e=>{const o=e.tripId;if(!o)return;const{lat:s,lon:n}=e.position;if(this.busMarkers[o]){const t=this.busMarkers[o];t.bus=e,t.marker.setLatLng([s,n])}else{const s=this.createBusMarker(e,t,o);this.busMarkers[o]=s,this.clusterGroup?r.push(s.marker):s.marker.addTo(this.map)}}),this.selectedBusId&&this.busMarkers[this.selectedBusId]&&!this.isMapMoving&&(this.busMarkers[this.selectedBusId],this._popupUpdateScheduled||(this._popupUpdateScheduled=!0,requestAnimationFrame(()=>{if(this._popupUpdateScheduled=!1,this.selectedBusId&&this.busMarkers[this.selectedBusId]&&!this.isMapMoving){const e=this.busMarkers[this.selectedBusId];this.updateBusPopupContent(this.busPopupDomElement,e.bus,t),this.busPopup.setLatLng(e.marker.getLatLng())}}))),this.clusterGroup?(s.length>0&&this.clusterGroup.removeLayers(s),r.length>0&&this.clusterGroup.addLayers(r)):s.length>0&&s.forEach(e=>this.map.removeLayer(e))}updateBusPopupContent(e,t,o){var r,s;try{const n=t.route,a=(null==n?void 0:n.route_short_name)||(null==n?void 0:n.route_id)||"?",i=(null==n?void 0:n.route_color)?`#${n.route_color}`:"#3B82F6",l=(null==n?void 0:n.route_text_color)?`#${n.route_text_color}`:"#ffffff",c=o.dataManager.stopTimesByTrip[t.tripId],d=o.getTripDestination(c),u=(null==(s=null==(r=t.segment)?void 0:r.toStopInfo)?void 0:s.stop_name)||"Inconnu";let p="...",h=!1;if(t.rtInfo&&null!==t.rtInfo.rtMinutes&&t.rtInfo.rtMinutes<999){const e=Math.round(t.rtInfo.rtMinutes);p=e<=0?"Imminent":1===e?"1 min":`${e} min`,h=!0}else{const e=o.getNextStopETA(t.segment,t.currentSeconds);p=e?e.formatted:"..."}const m="Terminus"===p||T(u,d)?"Terminus":`‚Üí ${d}`,g=e.querySelector(".bus-popup-line-badge"),f=e.querySelector(".line-number"),v=e.querySelector(".route-name"),y=e.querySelector('[data-update="state"]'),S=e.querySelector('[data-update="next-stop-value"]'),w=e.querySelector('[data-update="eta-value"]'),_=e.querySelector(".realtime-badge");g&&(g.style.background=i,g.style.color=l),f&&(f.textContent=a),v&&(v.textContent=`Ligne ${a}`),y&&(y.textContent=m),S&&(S.textContent=u),w&&(w.textContent=p,h||t.isRealtime?(w.classList.add("realtime"),w.classList.remove("theoretical")):(w.classList.add("theoretical"),w.classList.remove("realtime"))),_&&(h?(_.classList.remove("theoretical"),_.classList.add("realtime"),_.innerHTML='<span class="badge-dot"></span>Temps r√©el'):t.isRealtime?(_.classList.remove("theoretical"),_.classList.add("realtime"),_.innerHTML='<span class="badge-dot"></span>Position ajust√©e'):(_.classList.remove("realtime"),_.classList.add("theoretical"),_.innerHTML='<span class="badge-dot"></span>Position estim√©e'))}catch(n){console.error("Erreur mise √† jour popup:",n)}}createBusPopupDomElement(){const e=document.createElement("div");return e.className="bus-popup-modern",e.innerHTML='\n            <div class="bus-popup-header">\n                <div class="bus-popup-line-badge">\n                    <span class="line-number">?</span>\n                </div>\n                <div class="bus-popup-title">\n                    <span class="route-name">Ligne</span>\n                    <span class="route-destination" data-update="state">Chargement...</span>\n                </div>\n            </div>\n            <div class="bus-popup-body">\n                <div class="bus-popup-info-row">\n                    <div class="bus-popup-icon">üìç</div>\n                    <div class="bus-popup-info">\n                        <span class="info-label">Prochain arr√™t</span>\n                        <span class="info-value" data-update="next-stop-value">...</span>\n                    </div>\n                </div>\n                <div class="bus-popup-info-row">\n                    <div class="bus-popup-icon">‚è±Ô∏è</div>\n                    <div class="bus-popup-info">\n                        <span class="info-label">Arriv√©e estim√©e</span>\n                        <span class="info-value eta-highlight" data-update="eta-value">...</span>\n                    </div>\n                </div>\n            </div>\n            <div class="bus-popup-footer">\n                <span class="realtime-badge theoretical">\n                    <span class="badge-dot"></span>\n                    Position estim√©e\n                </span>\n            </div>\n        ',e}createBusMarker(e,t,o){const{lat:r,lon:s}=e.position,n=e.route,a=(null==n?void 0:n.route_short_name)||(null==n?void 0:n.route_id)||"?",i=(null==n?void 0:n.route_color)?`#${n.route_color}`:"#FFC107",l=(null==n?void 0:n.route_text_color)?`#${n.route_text_color}`:"#ffffff",c=e.currentStatus?`bus-status-${e.currentStatus}`:"bus-status-normal",d=L.divIcon({className:`bus-icon-rect ${c}`,html:`<div style="background-color: ${i}; color: ${l};">${a}</div>`,iconSize:[32,32],iconAnchor:[16,16],popupAnchor:[0,-16]}),u=L.marker([r,s],{icon:d,interactive:!0,bubblingMouseEvents:!1});u.on("click",e=>{console.log("[MapRenderer] üöå Bus clicked:",o),L.DomEvent.stopPropagation(e),this.selectedBusId=o;const r=this.busMarkers[o];r?(this.updateBusPopupContent(this.busPopupDomElement,r.bus,t),this.busPopup.setLatLng(u.getLatLng()).setContent(this.busPopupDomElement).openOn(this.map)):console.error("[MapRenderer] markerData not found for",o)});return{marker:u,bus:e}}highlightRoute(e,t){if(!this.routeLayersById||!this.routeLayersById[e])return;const o=t?6:4,r=t?1:.85;this.routeLayersById[e].forEach(e=>{const s=e.__baseColor||"#3388FF";e.setStyle({color:this.getRouteColorForTheme(s),weight:o,opacity:r}),t&&e.bringToFront()})}zoomToRoute(e){if(!this.routeLayersById||!this.routeLayersById[e]||0===this.routeLayersById[e].length)return void console.warn(`Aucune couche trouv√©e pour zoomer sur la route ${e}`);const t=L.featureGroup(this.routeLayersById[e]).getBounds();t&&t.isValid()&&this.map.fitBounds(t,{padding:[50,50]})}zoomToStop(e){const t=parseFloat(e.stop_lat),o=parseFloat(e.stop_lon);if(isNaN(t)||isNaN(o))return;this.map.setView([t,o],17),this.tempStopMarker&&this.map.removeLayer(this.tempStopMarker);const r=L.divIcon({className:"stop-search-marker",html:"<div></div>",iconSize:[12,12],iconAnchor:[6,6]});this.tempStopMarker=L.marker([t,o],{icon:r}).addTo(this.map)}displayStops(e=13){this.stopLayer.clearLayers();if(this.map.getZoom()<e)return;const t=L.divIcon({className:"stop-marker-icon",iconSize:[10,10],iconAnchor:[5,5]}),o=[];this.dataManager.masterStops.forEach(e=>{const r=parseFloat(e.stop_lat),s=parseFloat(e.stop_lon);if(isNaN(r)||isNaN(s))return;const n=L.marker([r,s],{icon:t,zIndexOffset:-100});n.on("click",()=>this.onStopClick(e)),o.push(n)}),o.forEach(e=>this.stopLayer.addLayer(e))}async onStopClick(e){const t=this.timeManager.getCurrentSeconds(),o=this.timeManager.getCurrentDate();A.trackStopClick(e.stop_id,e.stop_name),console.log(`üöè Clic sur arr√™t: ${e.stop_name}`);const r=this.dataManager.groupedStopMap[e.stop_id]||[e.stop_id],s=this.dataManager.getDeparturesForOneHour(r,t,o),{departuresByLine:n,isNextDayDepartures:a,firstDepartureTime:i}=s;console.log("üïê D√©parts trouv√©s:",Object.keys(n).length,"lignes",a?`(premiers d√©parts √† ${i})`:"");const l=parseFloat(e.stop_lat),c=parseFloat(e.stop_lon),d=this.createStopPopupContent(e,n,t,a,i,null),u=L.popup({maxHeight:350,maxWidth:280,minWidth:280,className:"stop-schedule-popup",autoPan:!1,closeOnClick:!0}).setLatLng([l,c]).setContent(d).openOn(this.map);setTimeout(()=>{document.querySelectorAll(".popup-dest-clickable").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const o=e.dataset.destination;this.goToDestinationStop(o)})})},50),this.fetchAndUpdateRealtime(e,u,n,t,a,i,l,c)}async fetchAndUpdateRealtime(e,t,o,r,s,n,a,i){try{const a=new Promise((e,t)=>setTimeout(()=>t(new Error("Timeout")),8e3)),i=x.getRealtimeForStopPlace(e.stop_id),l=await Promise.race([i,a]);if(l&&l.departures&&l.departures.length>0){console.log(`üì° Donn√©es temps r√©el re√ßues pour ${e.stop_name}:`,l.departures.length,"passages");const a={schedules:l.departures.map(e=>({ligne:e.line,destination:e.destination,temps:e.time,quai:e.quay||"",realtime:!1!==e.realtime,theoretical:e.theoretical||!1}))};if(t&&t.isOpen&&t.isOpen()){const i=this.createStopPopupContent(e,o,r,s,n,a);t.setContent(i),setTimeout(()=>{document.querySelectorAll(".popup-dest-clickable").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const o=e.dataset.destination;this.goToDestinationStop(o)})})},50)}}else console.log(`üì° Pas de donn√©es temps r√©el pour ${e.stop_name}`)}catch(l){"Timeout"===l.message?console.warn(`‚è±Ô∏è Timeout temps r√©el pour ${e.stop_name}`):console.warn(`‚ö†Ô∏è Erreur temps r√©el pour ${e.stop_name}:`,l.message)}}createStopPopupContent(e,t,o,r=!1,s=null,n=null){const a=Object.keys(t),i='<span class="realtime-icon"><svg viewBox="0 0 16 12" fill="currentColor">\n            <rect x="0" y="8" width="3" height="4" rx="0.5" opacity="1"/>\n            <rect x="4.5" y="5" width="3" height="7" rx="0.5" opacity="0.85"/>\n            <rect x="9" y="2" width="3" height="10" rx="0.5" opacity="0.7"/>\n            <rect x="13.5" y="0" width="2.5" height="12" rx="0.5" opacity="0.55"/>\n        </svg></span>',l={};n&&n.schedules&&n.schedules.forEach(e=>{var t;const o=null==(t=e.ligne)?void 0:t.toUpperCase();l[o]||(l[o]=[]),l[o].push(e)});const c=Object.keys(l).length>0,d={};a.forEach(o=>{const r=t[o],s=r.routeShortName;d[s]||(d[s]={routeShortName:r.routeShortName,routeColor:r.routeColor,routeTextColor:r.routeTextColor,routeId:r.routeId,destinations:[]});const n=_(e.stop_name),a=_(r.destination);a&&n&&a!==n&&d[s].destinations.push({destination:r.destination,departures:r.departures,tripId:r.tripId,routeId:r.routeId})});const u=Object.keys(d).sort((e,t)=>e.localeCompare(t,void 0,{numeric:!0}));let p='<div class="stop-popup-v105">';return p+=`<div class="popup-line-header">\n                    <span class="popup-stop-name">${e.stop_name}</span>`,c&&(p+=`<span class="realtime-badge">${i} Live</span>`),p+="</div>",r&&(p+='<div class="popup-notice">Ces horaires sont pr√©visionnels et peuvent changer en cas de perturbation.</div>'),0!==u.length||c?u.forEach(t=>{const o=d[t];if(0===o.destinations.length)return;const r=l[t.toUpperCase()]||[];p+='<div class="popup-line-block">',p+=`<div class="popup-line-header">\n                            <span class="popup-badge" style="background:#${o.routeColor};color:#${o.routeTextColor};">${o.routeShortName}</span>\n                         </div>`,o.destinations.forEach(t=>{p+=`<div class="popup-dest-row">\n                                <div class="popup-dest-name popup-dest-clickable" \n                                     data-route-id="${t.routeId||""}"\n                                     data-route-name="${o.routeShortName}"\n                                     data-route-color="${o.routeColor}"\n                                     data-destination="${t.destination}"\n                                     data-stop-id="${e.stop_id}"\n                                     data-stop-name="${e.stop_name}"\n                                     data-trip-id="${t.tripId||""}">\n                                    <span class="dest-label">Direction</span> ${t.destination}\n                                    <span class="dest-arrow">‚Üí</span>\n                                </div>\n                                <div class="popup-times">`;const s=r.filter(e=>{if(!e.destination)return!1;const o=e.destination.toLowerCase(),r=t.destination.toLowerCase();return o.includes(r)||r.includes(o)||o.split(" ")[0]===r.split(" ")[0]});let n=0;t.departures.forEach((e,t)=>{if(s.length>n){const e=s[n];n++,p+=`<span class="popup-time realtime" title="Temps r√©el">${i}${e.temps}</span>`}else p+=`<span class="popup-time">${e.time.substring(0,5)}</span>`});for(let e=n;e<s.length&&e<3;e++){const t=s[e];p+=`<span class="popup-time realtime" title="Temps r√©el">${i}${t.temps}</span>`}p+="</div></div>"}),p+="</div>"}):p+='<div class="popup-empty">\n                        <span class="popup-empty-icon">üåô</span>\n                        <span>Aucun passage pr√©vu</span>\n                     </div>',p+="</div>",p}goToDestinationStop(e){console.log(`üéØ Recherche arr√™t: ${e}`),this.map.closePopup();const t=this.findStopByName(e);if(t){const e=parseFloat(t.stop_lat),o=parseFloat(t.stop_lon);console.log(`‚úÖ Arr√™t trouv√©: ${t.stop_name} √† [${e}, ${o}]`),this.map.flyTo([e,o],16,{duration:1}),setTimeout(()=>{this.onStopClick(t)},1100)}else console.warn(`‚ùå Arr√™t non trouv√©: ${e}`)}findStopByName(e){if(!this.dataManager||!this.dataManager.masterStops)return null;const t=e.toLowerCase().trim();let o=this.dataManager.masterStops.find(e=>e.stop_name.toLowerCase().trim()===t);return o||(o=this.dataManager.masterStops.find(e=>e.stop_name.toLowerCase().includes(t)||t.includes(e.stop_name.toLowerCase()))),o}addLocateControl(e,t){if(!this.map)return void console.warn("Carte non initialis√©e, impossible d'ajouter le contr√¥le de localisation.");if(this.locateControl)return;if("undefined"==typeof navigator||!navigator.geolocation)return void console.warn("API de g√©olocalisation indisponible dans ce navigateur.");const o=this,r=L.Control.extend({options:{position:"bottomright"},onAdd(e){const t=L.DomUtil.create("div","map-floating-controls"),r=L.DomUtil.create("button","map-btn-locate",t);return r.type="button",r.setAttribute("aria-label","Me localiser"),r.title="Me localiser",r.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <circle cx="12" cy="12" r="3"/>\n    <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>\n</svg>',o.locateButtonElement=r,o.setLocateButtonState("idle"),L.DomEvent.disableClickPropagation(t),L.DomEvent.disableScrollPropagation(t),L.DomEvent.on(r,"click",e=>{e.preventDefault(),e.stopPropagation(),o.map&&(o.setLocateButtonState("loading"),o.map.locate({enableHighAccuracy:!0,watch:!1,setView:!1,maximumAge:0}))}),t}});this.locateControl=new r,this.locateControl.addTo(this.map),this.map.on("locationfound",t=>{o.setLocateButtonState("idle"),"function"==typeof e&&e({coords:{latitude:t.latitude,longitude:t.longitude}}),o.panToUserLocation()}),this.map.on("locationerror",e=>{o.setLocateButtonState("error"),"function"==typeof t&&t(e),setTimeout(()=>o.setLocateButtonState("idle"),1800)})}setLocateButtonState(e){this.locateButtonElement&&(this.locateButtonElement.classList.toggle("is-loading","loading"===e),this.locateButtonElement.classList.toggle("has-error","error"===e),"idle"===e&&(this.locateButtonElement.classList.remove("is-loading"),this.locateButtonElement.classList.remove("has-error")))}updateUserLocation(e){if(!this.map)return;const t=[e.lat,e.lng];if(this.userLocationMarker)this.userLocationMarker.setLatLng(t);else{const e=L.divIcon({className:"user-location-marker",iconSize:[16,16],iconAnchor:[8,8]});this.userLocationMarker=L.marker(t,{icon:e,zIndexOffset:1e3}).addTo(this.map)}}onLocateError(){this.setLocateButtonState("error"),setTimeout(()=>this.setLocateButtonState("idle"),1800)}panToUserLocation(){if(this.userLocationMarker){const e=this.userLocationMarker.getLatLng();this.map.flyTo(e,Math.max(this.map.getZoom(),17))}else this.map&&(this.setLocateButtonState("loading"),this.map.locate({enableHighAccuracy:!0,watch:!1,setView:!0}))}addDelayedBusMarker(e){if(!this.map||!e.position)return;const{tripId:t,routeName:o,routeColor:r,delaySeconds:s,position:n,isMajorDelay:a}=e,i=`delay_${t}`,l=Math.floor(s/60);this.delayedBusMarkers&&this.delayedBusMarkers[i]&&this.map.removeLayer(this.delayedBusMarkers[i]),this.delayedBusMarkers||(this.delayedBusMarkers={});const c=`\n            <div class="delayed-bus-marker ${a?"major-delay":""}">\n                <div class="bus-icon" style="--line-color: ${r||"#1976D2"}">\n                    ${o}\n                </div>\n                <div class="delay-indicator">!</div>\n                <div class="delay-tooltip">\n                    ‚ö†Ô∏è ${o}: ~${l} min de retard\n                </div>\n            </div>\n        `,d=L.divIcon({className:"delayed-bus-icon-wrapper",html:c,iconSize:[44,44],iconAnchor:[22,22]}),u=L.marker([n.lat,n.lng],{icon:d,zIndexOffset:2e3});u.addTo(this.map),this.delayedBusMarkers[i]=u,u.on("click",()=>{const t=`\n                <div class="delay-popup">\n                    <div class="delay-popup-header" style="background: ${r||"#1976D2"}">\n                        <span class="route-name">${o}</span>\n                        <span class="delay-badge">‚ö†Ô∏è ~${l} min</span>\n                    </div>\n                    <div class="delay-popup-body">\n                        <p><strong>Direction:</strong> ${e.headsign||"N/A"}</p>\n                        <p><strong>Prochain arr√™t:</strong> ${e.nextStopName||"N/A"}</p>\n                        <p><strong>Pr√©vu:</strong> <span class="original-time">${e.scheduledTime}</span></p>\n                        <p><strong>Estim√©:</strong> <span class="delayed-time">${e.estimatedTime}</span></p>\n                        <p class="delay-note">\n                            ${e.isPeakHour?"üöó Heure de pointe - trafic dense":""}\n                        </p>\n                    </div>\n                </div>\n            `;L.popup().setLatLng([n.lat,n.lng]).setContent(t).openOn(this.map)}),console.log(`üöå Marqueur retard ajout√©: ${o} √† [${n.lat.toFixed(5)}, ${n.lng.toFixed(5)}]`)}removeDelayedBusMarker(e){const t=`delay_${e}`;this.delayedBusMarkers&&this.delayedBusMarkers[t]&&(this.map.removeLayer(this.delayedBusMarkers[t]),delete this.delayedBusMarkers[t])}clearDelayedBusMarkers(){if(this.delayedBusMarkers){for(const e in this.delayedBusMarkers)this.map.removeLayer(this.delayedBusMarkers[e]);this.delayedBusMarkers={}}}}function N(){var e,t;return(null==(e=window.__APP_CONFIG)?void 0:e.backendMode)?window.__APP_CONFIG.backendMode:"3000"===window.location.port&&"localhost"===window.location.hostname?"otp":(null==(t=window.__APP_CONFIG)?void 0:t.googleApiKey)?"google":"vercel"}function F(){const e=N();return"vercel"===e||"otp"===e}function O(){return"otp"===N()}function G(){if(window.__ADMIN_TOKEN&&"__VITE_ADMIN_TOKEN__"!==window.__ADMIN_TOKEN)return window.__ADMIN_TOKEN;if(window.__APP_CONFIG&&window.__APP_CONFIG.adminToken)return window.__APP_CONFIG.adminToken;const e=document.querySelector('meta[name="peribus-admin-token"]');return e&&e.content&&e.content.trim()?e.content.trim():""}const j={routes:"/api/routes",places:"/api/places",geocode:"/api/geocode"},H={routes:"/api/routes",places:"/api/places/autocomplete",reverse:"/api/places/reverse",realtime:"/api/realtime"};function U(){return O()?H:j}function z(){const e=N();return{googleApiKey:window.__APP_CONFIG&&window.__APP_CONFIG.googleApiKey?window.__APP_CONFIG.googleApiKey:"",adminToken:G(),useProxy:F(),useOtp:O(),backendMode:e,apiEndpoints:U(),arrivalPageSize:6,minBusItineraries:3,maxBottomSheetLevels:3}}class q{constructor(e){this.apiKey=e,this.sessionToken=null;const t=z();this.useProxy=t.useProxy,this.useOtp=t.useOtp||!1,this.backendMode=t.backendMode||"vercel",this.apiEndpoints=t.apiEndpoints||U(),this.perigueuxBounds={south:45.1,west:.6,north:45.3,east:.85},this.perigueuxCenter={lat:45.184029,lng:.7211149},this.geocoder=null,this.autocompleteService=null,this.apiLoadPromise=null,this.proxyReady=!1,this.googleAuthFailed=!1,this.googleAuthFailureMessage="",this.clientOrigin="undefined"!=typeof window&&window.location?window.location.origin:"",this.placeAliases={campus:{canonicalName:"Campus Universitaire, P√©rigueux",aliases:["campus","campus p√©rigueux","fac","fac p√©rigueux","universit√©","universit√© p√©rigueux","iut","iut p√©rigueux","grenadi√®re","pole universitaire","p√¥le universitaire","la grenadi√®re"],coordinates:{lat:45.1958,lng:.7192},description:"Campus universitaire (arr√™ts Campus + P√¥le Grenadi√®re)",gtfsStops:[{stopId:"MOBIITI:StopPlace:77309",name:"Campus",lat:45.197113,lng:.71813},{stopId:"MOBIITI:StopPlace:77314",name:"P√¥le Universitaire Grenadi√®re",lat:45.194477,lng:.720215}],searchRadius:400}}}async loadGoogleMapsAPI(){var e;return this.useProxy?(console.log("‚úÖ Mode proxy activ√© - SDK Google Maps non requis"),this.proxyReady=!0,Promise.resolve()):this.googleAuthFailed?Promise.reject(new Error(this.buildAuthFailureMessage())):this.apiLoadPromise?this.apiLoadPromise:(null==(e=window.google)?void 0:e.maps)&&(await this.ensureGoogleLibraries(),window.google.maps.places&&window.google.maps.Geocoder)?(console.log("‚úÖ API Google Maps d√©j√† charg√©e."),this.initServices(),Promise.resolve()):(this.installGoogleAuthHook(),this.apiLoadPromise=new Promise((e,t)=>{const o="peribus-google-auth-failure",r=e=>{var s;window.removeEventListener(o,r),this.googleAuthFailed=!0,this.googleAuthFailureMessage=this.buildAuthFailureMessage(null==(s=null==e?void 0:e.detail)?void 0:s.origin),console.error(this.googleAuthFailureMessage),this.apiLoadPromise=null,t(new Error(this.googleAuthFailureMessage))};window.addEventListener(o,r,{once:!0});const s=()=>window.removeEventListener(o,r),n=document.createElement("script");n.src=`https://maps.googleapis.com/maps/api/js?key=${this.apiKey}&libraries=places,geocoding&v=weekly&loading=async`,n.async=!0,n.defer=!0,n.setAttribute("data-google-maps","true"),n.onload=()=>{s(),console.log("‚úÖ API Google Maps charg√©e avec succ√®s."),setTimeout(async()=>{var o,r,s,n;try{if(await this.ensureGoogleLibraries(),!(null==(r=null==(o=window.google)?void 0:o.maps)?void 0:r.places)||!(null==(n=null==(s=window.google)?void 0:s.maps)?void 0:n.Geocoder))throw new Error("Biblioth√®ques places/geocoding non disponibles");this.initServices(),e()}catch(a){console.error("‚ùå google.maps.places ou google.maps.Geocoder n'est pas disponible"),this.apiLoadPromise=null,t(a)}},100)},n.onerror=()=>{s(),console.error("‚ùå Erreur lors du chargement du script Google Maps."),this.apiLoadPromise=null,t(new Error("Impossible de charger Google Maps API."))},document.head.appendChild(n)}),this.apiLoadPromise)}initServices(){var e,t,o,r,s;if((null==(t=null==(e=window.google)?void 0:e.maps)?void 0:t.places)&&(null==(r=null==(o=window.google)?void 0:o.maps)?void 0:r.Geocoder))try{this.geocoder=new google.maps.Geocoder,(null==(s=google.maps.places.AutocompleteSuggestion)?void 0:s.fetchAutocompleteSuggestions)?console.log("‚úÖ Nouvelle API AutocompleteSuggestion disponible."):(console.warn("‚ö†Ô∏è AutocompleteSuggestion non disponible, fallback vers ancienne API"),this.autocompleteService=new google.maps.places.AutocompleteService),this.sessionToken=new google.maps.places.AutocompleteSessionToken}catch(n){console.error("‚ùå Erreur lors de l'initialisation des services:",n)}else console.error("‚ùå Les biblioth√®ques Google Maps 'places' ou 'geocoding' ne sont pas disponibles.")}async ensureGoogleLibraries(){var e;if(!(null==(e=window.google)?void 0:e.maps))return;const t=window.google.maps.importLibrary;if("function"==typeof t){if(!window.google.maps.places)try{const e=await t("places");e&&(window.google.maps.places=window.google.maps.places||{},Object.assign(window.google.maps.places,e))}catch(o){console.warn("‚ö†Ô∏è Impossible de charger la biblioth√®que Places via importLibrary:",o)}if(!window.google.maps.Geocoder)try{const e=await t("geocoding");(null==e?void 0:e.Geocoder)&&!window.google.maps.Geocoder&&(window.google.maps.Geocoder=e.Geocoder)}catch(o){console.warn("‚ö†Ô∏è Impossible de charger la biblioth√®que Geocoding via importLibrary:",o)}}}async getPlaceAutocomplete(e){var t;const o=this._checkPlaceAlias(e);try{let s=[];if(this.useOtp){console.log("üîç Recherche autocompl√©tion (OTP/Photon):",e);const t=new URL(this.apiEndpoints.places,window.location.origin);t.searchParams.set("q",e),t.searchParams.set("lat",this.perigueuxCenter.lat),t.searchParams.set("lon",this.perigueuxCenter.lng),t.searchParams.set("limit","10");const o=await fetch(t.toString());if(!o.ok){const e=await o.json().catch(()=>({}));throw new Error(e.error||`Erreur OTP: ${o.status}`)}s=((await o.json()).suggestions||[]).map(e=>({description:e.description+(e.city?`, ${e.city}`:""),placeId:null,coordinates:{lat:e.lat,lng:e.lon},type:e.type||"place",source:e.source||"photon"})),console.log(`‚úÖ ${s.length} suggestions trouv√©es (OTP/Photon)`)}else if(this.useProxy){console.log("üîç Recherche autocompl√©tion (proxy):",e);const t=new URL(this.apiEndpoints.places,window.location.origin);t.searchParams.set("input",e);const o=await fetch(t.toString());if(!o.ok){const e=await o.json().catch(()=>({}));throw new Error(e.error||`Erreur proxy: ${o.status}`)}s=((await o.json()).predictions||[]).map(e=>({description:e.description,placeId:e.placeId})),console.log(`‚úÖ ${s.length} suggestions trouv√©es (proxy)`)}else{if(!this.sessionToken){console.warn("‚ö†Ô∏è Service d'autocompl√©tion non initialis√©. Tentative de chargement...");try{await this.loadGoogleMapsAPI()}catch(r){return console.error("‚ùå Impossible d'initialiser le service d'autocompl√©tion:",r.message),o?[this._createAliasResult(o)]:[]}if(!this.sessionToken)return console.error("‚ùå Impossible d'initialiser le service d'autocompl√©tion"),o?[this._createAliasResult(o)]:[]}if(null==(t=google.maps.places.AutocompleteSuggestion)?void 0:t.fetchAutocompleteSuggestions){const t={input:e,locationRestriction:{west:this.perigueuxBounds.west,north:this.perigueuxBounds.north,east:this.perigueuxBounds.east,south:this.perigueuxBounds.south},region:"fr",sessionToken:this.sessionToken};console.log("üîç Recherche autocompl√©tion (SDK):",e);const{suggestions:o}=await google.maps.places.AutocompleteSuggestion.fetchAutocompleteSuggestions(t);console.log(`‚úÖ ${o.length} suggestions trouv√©es`),s=o.map(e=>({description:e.placePrediction.text.text,placeId:e.placePrediction.placeId}))}else console.warn("‚ö†Ô∏è Utilisation de l'ancienne API AutocompleteService (d√©pr√©ci√©e)"),s=await new Promise((t,o)=>{const r={input:e,sessionToken:this.sessionToken,componentRestrictions:{country:"fr"},bounds:new google.maps.LatLngBounds(new google.maps.LatLng(this.perigueuxBounds.south,this.perigueuxBounds.west),new google.maps.LatLng(this.perigueuxBounds.north,this.perigueuxBounds.east)),strictBounds:!0};this.autocompleteService.getPlacePredictions(r,(e,o)=>{o===google.maps.places.PlacesServiceStatus.OK&&e?(console.log(`‚úÖ ${e.length} suggestions trouv√©es (ancienne API)`),t(e.map(e=>({description:e.description,placeId:e.place_id})))):(console.warn("‚ö†Ô∏è √âchec de l'autocompl√©tion Places:",o),t([]))})})}if(o){s.some(e=>e.description.toLowerCase().includes("grenadi√®re")||e.description.toLowerCase().includes("universitaire"))||(s.unshift(this._createAliasResult(o)),console.log(`üéì Alias inject√©: ${o.canonicalName}`))}return s}catch(r){return console.error("‚ùå Erreur lors de l'autocompl√©tion:",r),o?[this._createAliasResult(o)]:[]}}_createAliasResult(e){return{description:`üéì ${e.canonicalName}`,placeId:"ALIAS_CAMPUS",isAlias:!0,coordinates:e.coordinates,aliasDescription:e.description}}_checkPlaceAlias(e){if(!e||e.length<3)return null;const t=e.toLowerCase().trim();for(const[o,r]of Object.entries(this.placeAliases)){if(r.aliases.some(e=>e.startsWith(t)||t.startsWith(e)))return console.log(`üéì Alias trouv√©: "${e}" ‚Üí "${r.canonicalName}"`),r}return null}async resolveAliasOrPlaceId(e){if(e&&e.startsWith("ALIAS_")){const t=e.replace("ALIAS_","").toLowerCase(),o=this.placeAliases[t];if(o&&o.coordinates)return console.log(`üéì R√©solution alias: ${e} ‚Üí ${JSON.stringify(o.coordinates)}`),o.coordinates}return this.getPlaceCoords(e)}async reverseGeocode(e,t){if(this.useProxy)try{const o=new URL(this.apiEndpoints.geocode,window.location.origin);o.searchParams.set("lat",e),o.searchParams.set("lng",t);const r=await fetch(o.toString());if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error||`Erreur geocode proxy: ${r.status}`)}const s=await r.json();if(s.results&&s.results.length>0){const e=s.results[0].place_id;return console.log(`‚úÖ G√©ocodage invers√© r√©ussi (proxy): ${e}`),e}return console.warn("G√©ocodage invers√©: Aucun r√©sultat trouv√©."),null}catch(o){return console.error("‚ùå Erreur g√©ocodage invers√© (proxy):",o),null}if(!this.geocoder){console.warn("‚ö†Ô∏è Service Geocoder non initialis√©. Tentative de chargement...");try{await this.loadGoogleMapsAPI()}catch(o){return console.error("‚ùå Impossible d'initialiser le service Geocoder:",o.message),null}if(!this.geocoder)return console.error("‚ùå Impossible d'initialiser le service Geocoder"),null}return new Promise((o,r)=>{const s={lat:e,lng:t};this.geocoder.geocode({location:s},(e,t)=>{"OK"===t?e&&e.length>0?(console.log(`‚úÖ G√©ocodage invers√© r√©ussi: ${e[0].place_id}`),o(e[0].place_id)):(console.warn("G√©ocodage invers√©: Aucun r√©sultat trouv√©."),o(null)):(console.warn("√âchec du g√©ocodage invers√©:",t),r(new Error(`Geocode failed with status: ${t}`)))})})}async getPlaceCoords(e){if(e&&"object"==typeof e&&(e.lat||e.latitude)){const t=e.lat||e.latitude,o=e.lng||e.lon||e.longitude;return console.log(`‚úÖ Coordonn√©es directes: ${t}, ${o}`),{lat:t,lng:o}}const t=e;if(t&&"string"==typeof t&&t.startsWith("ALIAS_")){const e=t.replace("ALIAS_","").toLowerCase(),o=this.placeAliases[e];if(o&&o.coordinates)return console.log(`üéì R√©solution alias coords: ${t} ‚Üí ${JSON.stringify(o.coordinates)}`),{lat:o.coordinates.lat,lng:o.coordinates.lng,gtfsStops:o.gtfsStops||null,searchRadius:o.searchRadius||300,isMultiStop:Array.isArray(o.gtfsStops)&&o.gtfsStops.length>1}}if(this.useOtp)return console.warn("getPlaceCoords (OTP): placeId non support√©, utilisez les coordonn√©es directes"),null;if(this.useProxy)try{const e=new URL(this.apiEndpoints.places,window.location.origin);e.searchParams.set("placeId",t);const o=await fetch(e.toString());if(!o.ok){const e=await o.json().catch(()=>({}));return console.warn("getPlaceCoords (proxy): erreur",e.error||o.status),null}const r=await o.json();return r.lat&&r.lng?(console.log(`‚úÖ Coordonn√©es obtenues (proxy): ${t} ‚Üí ${r.lat}, ${r.lng}`),{lat:r.lat,lng:r.lng}):(console.warn("getPlaceCoords (proxy): pas de coordonn√©es pour",t),null)}catch(o){return console.error("getPlaceCoords (proxy): erreur",o),null}if(!this.geocoder){console.warn("‚ö†Ô∏è Service Geocoder non initialis√©. Tentative de chargement...");try{await this.loadGoogleMapsAPI()}catch(o){return console.error("‚ùå Impossible d'initialiser le service Geocoder:",o.message),null}if(!this.geocoder)return console.error("‚ùå Impossible d'initialiser le service Geocoder"),null}return new Promise((e,o)=>{this.geocoder.geocode({placeId:t},(o,r)=>{if("OK"===r&&o&&o.length>0){const t=o[0].geometry&&o[0].geometry.location;if(t&&"function"==typeof t.lat&&"function"==typeof t.lng)return void e({lat:t.lat(),lng:t.lng()});if(t&&t.lat&&t.lng)return void e({lat:t.lat,lng:t.lng})}console.warn("getPlaceCoords: pas de r√©sultat pour",t,r),e(null)})})}async fetchItinerary(e,t,o=null){var r,s,n,a,i,l,c,d,u,p,h,m,g,f,v,y,S,w,_,T,b,L,I,E;const M=performance.now();console.log(`üß† V230 RECHERCHE ITIN√âRAIRE (${this.backendMode}): ${"object"==typeof e?"coords":e} ‚Üí ${"object"==typeof t?"coords":t}`),o&&console.log(`‚è∞ Mode: ${o.type||"partir"}, Heure: ${o.hour}:${o.minute}`);let A=null,C=null;"object"==typeof e&&(null==e?void 0:e.coordinates)?A=e.coordinates:"object"==typeof e&&(null==e?void 0:e.lat)&&(A=e),"object"==typeof t&&(null==t?void 0:t.coordinates)?C=t.coordinates:"object"==typeof t&&(null==t?void 0:t.lat)&&(C=t);const $="string"==typeof e&&e.startsWith("ALIAS_"),k="string"==typeof t&&t.startsWith("ALIAS_"),B=[];$&&B.push(this.getPlaceCoords(e).then(e=>{A=e})),k&&B.push(this.getPlaceCoords(t).then(e=>{C=e})),B.length&&await Promise.all(B);const x={bus:null,bike:null,walk:null,recommendations:[]},D=[o];o&&"arriver"===o.type?console.log(`‚è∞ V222 Mode ARRIVER: 1 appel avec arrivalTime=${o.hour}:${o.minute}`):console.log(`‚è∞ V222 Mode PARTIR: 1 appel avec departureTime=${(null==o?void 0:o.hour)||"now"}:${(null==o?void 0:o.minute)||""}`);const[R,P,N]=await Promise.allSettled([Promise.allSettled(D.map(o=>this._fetchBusRoute(e,t,o,A,C))),this.fetchBicycleRoute(e,t,A,C),this.fetchWalkingRoute(e,t,A,C)]),F=e=>{var t,o,r,s,n,a,i,l,c,d,u,p;let h=null==(n=null==(s=null==(r=null==(o=null==(t=e.legs)?void 0:t[0])?void 0:o.localizedValues)?void 0:r.departureTime)?void 0:s.time)?void 0:n.text;if(h)return h;const m=null==(l=null==(i=null==(a=e.legs)?void 0:a[0])?void 0:i.steps)?void 0:l.find(e=>"TRANSIT"===e.travelMode);if(null==m?void 0:m.transitDetails){const e=m.transitDetails;if(h=null==(u=null==(d=null==(c=e.localizedValues)?void 0:c.departureTime)?void 0:d.time)?void 0:u.text,h)return h;const t=null==(p=e.stopDetails)?void 0:p.departureTime;if(t){const e=new Date(t);if(!isNaN(e.getTime()))return`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}}return""};if("fulfilled"===R.status){const e=[],t=new Set;for(const o of R.value)if("fulfilled"===o.status&&(null==(s=null==(r=o.value)?void 0:r.routes)?void 0:s.length)>0)for(const r of o.value.routes){const o=F(r),s=null==(i=null==(a=null==(n=r.legs)?void 0:n[0])?void 0:a.steps)?void 0:i.find(e=>"TRANSIT"===e.travelMode),g=`${o}-${(null==(c=null==(l=null==s?void 0:s.transitDetails)?void 0:l.transitLine)?void 0:c.nameShort)||(null==(u=null==(d=null==s?void 0:s.transitDetails)?void 0:d.transitLine)?void 0:u.name)||""}-${(null==(m=null==(h=null==(p=null==s?void 0:s.transitDetails)?void 0:p.stopDetails)?void 0:h.departureStop)?void 0:m.name)||""}`;t.has(g)||(t.add(g),e.push(r))}if(e.length>0){e.sort((e,t)=>{const o=F(e)||"99:99",r=F(t)||"99:99";return o.localeCompare(r)});const t=e.slice(0,8),o={routes:t,hasMore:e.length>8},r=e[0],s=parseInt(null==(g=r.duration)?void 0:g.replace("s",""))||0,n=Math.round(s/60),a=(null==(y=null==(v=null==(f=r.legs)?void 0:f[0])?void 0:v.steps)?void 0:y.filter(e=>"TRANSIT"===e.travelMode))||[],i=Math.max(0,a.length-1);x.bus={data:o,duration:n,transfers:i},console.log(`üöç V218: ${t.length}/${e.length} trajets affich√©s (max 8)`);const l=t.map(e=>F(e)).filter(Boolean).join(", ");console.log(`üìã Horaires: ${l}`),x.recommendations.push({mode:"bus",score:100,reason:`${n}min${i?` (${i} corresp.)`:""}`})}else console.warn("‚ö†Ô∏è Pas de bus disponible"),x.recommendations.push({mode:"bus",score:0,reason:"Aucun bus disponible"})}else console.warn("‚ö†Ô∏è Erreur appels bus"),x.recommendations.push({mode:"bus",score:0,reason:"Erreur recherche bus"});if("fulfilled"===P.status&&(null==(w=null==(S=P.value)?void 0:S.routes)?void 0:w.length)>0){const e=P.value.routes[0],t=Math.round((parseInt(null==(_=e.duration)?void 0:_.replace("s",""))||0)/60),o=(e.distanceMeters/1e3).toFixed(1);x.bike={data:P.value,duration:t,distance:o},console.log(`üö¥ V√©lo: ${t}min, ${o}km`);let r=t<15?100:t<30?90:t<45?70:40;x.recommendations.push({mode:"bike",score:r,reason:`${t}min (${o}km)`})}if("fulfilled"===N.status&&(null==(b=null==(T=N.value)?void 0:T.routes)?void 0:b.length)>0){const e=N.value.routes[0],t=Math.round((parseInt(null==(L=e.duration)?void 0:L.replace("s",""))||0)/60),o=(e.distanceMeters/1e3).toFixed(1);x.walk={data:N.value,duration:t,distance:o},console.log(`üö∂ Marche: ${t}min, ${o}km`);let r=t<10?95:t<20?85:t<30?65:t<45?40:20;x.recommendations.push({mode:"walk",score:r,reason:`${t}min (${o}km)`})}x.recommendations.sort((e,t)=>t.score-e.score);const O=Math.round(performance.now()-M),G=D.length+2;return console.log(`‚ö° V222 Calcul termin√© en ${O}ms (${G} appels API au lieu de 10)`),console.log(`üí∞ √âconomie API: ${Math.round(100*(1-G/10))}%`),(null==(E=null==(I=window.google)?void 0:I.maps)?void 0:E.places)&&(this.sessionToken=new google.maps.places.AutocompleteSessionToken),x}_offsetSearchTime(e,t){if(!e){const e=new Date;return e.setMinutes(e.getMinutes()+t),{type:"partir",hour:e.getHours().toString().padStart(2,"0"),minute:e.getMinutes().toString().padStart(2,"0")}}let o;o=e.date&&"today"!==e.date&&"Aujourd'hui"!==e.date?new Date(e.date):new Date,o.setHours(parseInt(e.hour)||0),o.setMinutes(parseInt(e.minute)||0),o.setSeconds(0),o.setMinutes(o.getMinutes()+t);const r=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`;return{...e,date:r,hour:o.getHours().toString().padStart(2,"0"),minute:o.getMinutes().toString().padStart(2,"0")}}async _fetchBusRoute(e,t,o=null,r=null,s=null){if(this.useOtp)return this._fetchBusRouteOtp(e,t,o,r,s);const n=this.useProxy?`${this.apiEndpoints.routes}?action=directions`:"https://routes.googleapis.com/directions/v2:computeRoutes",a={origin:r?{location:{latLng:{latitude:r.lat,longitude:r.lng}}}:{placeId:e},destination:s?{location:{latLng:{latitude:s.lat,longitude:s.lng}}}:{placeId:t},travelMode:"TRANSIT",computeAlternativeRoutes:!0,transitPreferences:{allowedTravelModes:["BUS"],routingPreference:"FEWER_TRANSFERS"},languageCode:"fr",units:"METRIC"};if(o){const e=this._buildDateTime(o);"arriver"===o.type?(a.arrivalTime=e,console.log(`üéØ V222 API arrivalTime: ${e}`)):a.departureTime=e}const i={"Content-Type":"application/json"};this.useProxy||(i["X-Goog-Api-Key"]=this.apiKey,i["X-Goog-FieldMask"]="routes.duration,routes.distanceMeters,routes.polyline,routes.legs.steps");const l=await fetch(n,{method:"POST",headers:i,body:JSON.stringify(a)});if(!l.ok){const e=await l.text();if(console.error("‚ùå Erreur API Routes (bus):",e),404===l.status||e.includes("NOT_FOUND"))throw new Error("Aucun bus disponible");throw new Error(`Erreur API Routes: ${l.status}`)}const c=await l.json();if(!c.routes||0===c.routes.length)throw new Error("Aucun itin√©raire en bus trouv√©");return console.log(`‚úÖ ${c.routes.length} itin√©raire(s) bus trouv√©(s)`),c}async _fetchBusRouteOtp(e,t,o=null,r=null,s=null){console.log("üöç Recherche itin√©raire OTP...");let n=r,a=s;if(!n&&(null==e?void 0:e.coordinates)&&(n=e.coordinates),!a&&(null==t?void 0:t.coordinates)&&(a=t.coordinates),!n||!a)throw new Error("Coordonn√©es requises pour le mode OTP");const i={origin:{lat:n.lat,lon:n.lng||n.lon},destination:{lat:a.lat,lon:a.lng||a.lon},mode:"TRANSIT",maxWalkDistance:1e3,maxTransfers:3,options:{numItineraries:8}};if(o){const e=this._buildDateTime(o);i.time=e,i.timeType="arriver"===o.type?"arrival":"departure"}const l=await fetch(this.apiEndpoints.routes,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!l.ok){const e=await l.json().catch(()=>({}));if(console.error("‚ùå Erreur API OTP:",e),"NO_ROUTE"===e.code||404===l.status)throw new Error("Aucun bus disponible");throw new Error(e.error||`Erreur OTP: ${l.status}`)}const c=await l.json();if(!c.success||!c.routes||0===c.routes.length)throw new Error("Aucun itin√©raire en bus trouv√©");const d=c.routes.map(e=>this._convertOtpRouteToGoogleFormat(e));return console.log(`‚úÖ ${d.length} itin√©raire(s) OTP trouv√©(s)`),{routes:d}}_convertOtpRouteToGoogleFormat(e){var t;const o=e.legs||[],r=o.map(e=>{var t,o,r,s,n,a,i;const l=["BUS","TRAM","SUBWAY","RAIL"].includes(e.mode);return{travelMode:l?"TRANSIT":"WALK",distanceMeters:e.distanceMeters||0,staticDuration:`${e.duration}s`,polyline:e.polyline?{encodedPolyline:e.polyline}:null,startLocation:{latLng:{latitude:null==(t=e.from)?void 0:t.lat,longitude:null==(o=e.from)?void 0:o.lon}},endLocation:{latLng:{latitude:null==(r=e.to)?void 0:r.lat,longitude:null==(s=e.to)?void 0:s.lon}},...l&&{transitDetails:{stopDetails:{departureStop:{name:null==(n=e.from)?void 0:n.name},arrivalStop:{name:null==(a=e.to)?void 0:a.name},departureTime:e.startTime?new Date(e.startTime).toISOString():null,arrivalTime:e.endTime?new Date(e.endTime).toISOString():null},localizedValues:{departureTime:{time:{text:this._formatTimeFromMs(e.startTime)}},arrivalTime:{time:{text:this._formatTimeFromMs(e.endTime)}}},transitLine:{nameShort:e.routeShortName||(null==(i=e.routeColor)?void 0:i.shortName)||"",name:e.routeLongName||"",color:e.routeColor||"#3388ff",textColor:e.routeTextColor||"#FFFFFF",vehicle:{type:e.mode}},headsign:e.headsign||""}}}});return{duration:`${e.duration||o.reduce((e,t)=>e+(t.duration||0),0)}s`,distanceMeters:e.distanceMeters||o.reduce((e,t)=>e+(t.distanceMeters||0),0),polyline:e.polyline||(null==(t=o[0])?void 0:t.polyline)||null,legs:[{steps:r,polyline:e.polyline||o.map(e=>e.polyline).filter(Boolean)[0],localizedValues:{departureTime:{time:{text:this._formatTimeFromMs(e.startTime)}},arrivalTime:{time:{text:this._formatTimeFromMs(e.endTime)}}}}]}}_formatTimeFromMs(e){if(!e)return"";const t=new Date(e);return isNaN(t.getTime())?"":`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}_buildDateTime(e){const{date:t,hour:o,minute:r}=e;let s=(e=>{if(!e||"today"===e||"Aujourd'hui"===e)return new Date;const t=String(e).split(/[-/]/).map(Number);if(t.length>=3&&t.every(e=>Number.isFinite(e))){const[e,o,r]=t;return new Date(e,o-1,r)}return new Date(e)})(t);isNaN(s.getTime())&&(console.warn("‚ö†Ô∏è Date invalide, utilisation de la date actuelle"),s=new Date);const n=parseInt(o)||0,a=parseInt(r)||0;s.setHours(n,a,0,0);const i=-s.getTimezoneOffset(),l=i>=0?"+":"-",c=String(Math.floor(Math.abs(i)/60)).padStart(2,"0"),d=String(Math.abs(i)%60).padStart(2,"0"),u=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}T${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}:${String(s.getSeconds()).padStart(2,"0")}${l}${c}:${d}`;return console.log("üïí DateTime construit (local):",u),u}async fetchBicycleRoute(e,t,o=null,r=null){console.log(`üö¥ API Google Routes (V√âLO): ${e} ‚Üí ${t}`);const s=this.useProxy?`${this.apiEndpoints.routes}?action=bicycle`:"https://routes.googleapis.com/directions/v2:computeRoutes",n={origin:o?{location:{latLng:{latitude:o.lat,longitude:o.lng}}}:{placeId:e},destination:r?{location:{latLng:{latitude:r.lat,longitude:r.lng}}}:{placeId:t},travelMode:"BICYCLE",languageCode:"fr",units:"METRIC"},a={"Content-Type":"application/json"};this.useProxy||(a["X-Goog-Api-Key"]=this.apiKey,a["X-Goog-FieldMask"]="routes.duration,routes.distanceMeters,routes.polyline,routes.legs.steps");const i=await fetch(s,{method:"POST",headers:a,body:JSON.stringify(n)});if(!i.ok){const e=await i.text();throw console.error("‚ùå Erreur API Routes (v√©lo):",e),new Error(`Erreur v√©lo: ${i.status}`)}const l=await i.json();return console.log("‚úÖ Itin√©raire v√©lo calcul√©"),l}async fetchWalkingRoute(e,t,o=null,r=null){console.log(`üö∂ API Google Routes (MARCHE): ${e} ‚Üí ${t}`);const s=this.useProxy?`${this.apiEndpoints.routes}?action=walking`:"https://routes.googleapis.com/directions/v2:computeRoutes",n={origin:o?{location:{latLng:{latitude:o.lat,longitude:o.lng}}}:{placeId:e},destination:r?{location:{latLng:{latitude:r.lat,longitude:r.lng}}}:{placeId:t},travelMode:"WALK",languageCode:"fr",units:"METRIC"},a={"Content-Type":"application/json"};this.useProxy||(a["X-Goog-Api-Key"]=this.apiKey,a["X-Goog-FieldMask"]="routes.duration,routes.distanceMeters,routes.polyline,routes.legs.steps");const i=await fetch(s,{method:"POST",headers:a,body:JSON.stringify(n)});if(!i.ok){const e=await i.text();throw console.error("‚ùå Erreur API Routes (marche):",e),new Error(`Erreur marche: ${i.status}`)}const l=await i.json();return console.log("‚úÖ Itin√©raire marche calcul√©"),l}async fetchWalkRoute(e,t){return this.fetchWalkingRoute(e,t)}installGoogleAuthHook(){if("undefined"==typeof window)return;if(window.__peribusGoogleAuthHookInstalled)return;window.__peribusGoogleAuthHookInstalled=!0;const e=window.gm_authFailure;window.gm_authFailure=()=>{var t;try{window.dispatchEvent(new CustomEvent("peribus-google-auth-failure",{detail:{origin:null==(t=window.location)?void 0:t.origin}}))}catch(o){console.warn("gm_authFailure dispatch error",o)}if("function"==typeof e)try{e()}catch(o){console.warn("gm_authFailure previous handler failed",o)}}}buildAuthFailureMessage(e=this.clientOrigin){return`Google Maps API a refus√© le referer ${e||this.clientOrigin||"ce domaine"}. Ajoutez cette URL dans les restrictions HTTP de votre cl√© Google Cloud.`}}const K=12e4,W=Object.freeze({STOP_SEARCH_RADIUS_M:500,STOP_SEARCH_LIMIT:10,MAX_ITINERARIES:12,MIN_BUS_ITINERARIES:3,WALK_DIRECT_MAX_METERS:150,ENABLE_TRANSFERS:!0,TRANSFER_MAX_ITINERARIES:6,TRANSFER_MIN_BUFFER_SECONDS:180,TRANSFER_MAX_WAIT_SECONDS:1800,TRANSFER_MAX_FIRST_LEG_STOPS:8,TRANSFER_CANDIDATE_TRIPS_LIMIT:20,TRANSFER_WALK_RADIUS_M:200});function V({dataManager:e,apiManager:t,icons:o}){const r=new Map,s=new Map,n=(o,s)=>async function(e,t,o){var r,s,n;const{dataManager:a,apiManager:i}=e;if(!t||!o)return null;const l=a.calculateDistance(t.lat,t.lon,o.lat,o.lon);if(!l||Number.isNaN(l))return null;if(l<=W.WALK_DIRECT_MAX_METERS){return{encodedPolyline:Y([[t.lat,t.lon],[o.lat,o.lon]]),distanceMeters:Math.round(l),durationSeconds:J(l),source:"direct"}}if(null==i?void 0:i.fetchWalkingRoute)try{const a=await X(e,t.lat,t.lon),c=await X(e,o.lat,o.lon);if(a&&c){const e=await i.fetchWalkingRoute(a,c),t=null==(r=null==e?void 0:e.routes)?void 0:r[0],o=(null==(s=null==t?void 0:t.polyline)?void 0:s.encodedPolyline)||(null==t?void 0:t.polyline);if(o){const e=parseInt(null==(n=null==t?void 0:t.duration)?void 0:n.replace("s",""),10);return{encodedPolyline:o,distanceMeters:Math.round((null==t?void 0:t.distanceMeters)||l),durationSeconds:e&&!Number.isNaN(e)?e:J(l),source:"api"}}}}catch(d){console.warn("Erreur getWalkingRoute, fallback segment direct:",d)}const c=Y([[t.lat,t.lon],[o.lat,o.lon]]);return{encodedPolyline:c,distanceMeters:Math.round(l),durationSeconds:J(l),source:"fallback"}}({dataManager:e,apiManager:t,placeIdCache:r},o,s),a=(t,o,r,n,a,i="partir")=>function(e,t,o,r,s,n,a="partir"){const{dataManager:i,gtfsTripsCache:l}=e;try{const e=JSON.stringify({startIds:t.slice().sort(),endIds:o.slice().sort(),date:r.toISOString().split("T")[0],windowStartSec:s,windowEndSec:n,searchMode:a}),c=Date.now(),d=l.get(e);if(d&&c-d.ts<K)return d.value;const u=i.getTripsBetweenStops(t,o,r,s,n,a)||[];return l.set(e,{ts:c,value:u}),u}catch(c){return console.warn("getCachedTripsBetweenStops error",c),i.getTripsBetweenStops(t,o,r,s,n,a)||[]}}({dataManager:e,gtfsTripsCache:s},t,o,r,n,a,i);return{computeHybridItinerary:(t,r,s,i={},l={})=>async function(e,t,o,r,s={},n={}){var a,i,l;globalThis._transferHubsLogged=!1,globalThis._hubDebugLogged=!1,globalThis._assembleDebugLogged=!1,globalThis._transferResultsLogged=!1,globalThis._routerGroupMapLogged=!1;const c=e.dataManager,d=e.icons,u=e.config,p=e.getWalkingRoute,h=e.getCachedTripsBetweenStops,m=e.encodePolyline,g=e.computeWalkDurationSeconds,f=(null==n?void 0:n.from)||null,v=(null==n?void 0:n.to)||null;if(!c||!c.isLoaded)return[];const y=new Set(["undefined","null","--","‚Äî","n/a","na","inconnu","unknown"]),S=e=>{if(null==e)return null;if("number"==typeof e)return String(e);const t=String(e).trim();if(!t)return null;const o=t.toLowerCase();return y.has(o)||/^[-‚Äì‚Äî\s:._]+$/.test(t)?null:t},w=e=>{if(!e)return null;const t=S(e.stop_name);if(t)return t;if(e.parent_station){const t=c.getStop(e.parent_station),o=S(null==t?void 0:t.stop_name);if(o)return o}const o=S(e.stop_code);return o||(e.stop_id||null)},_=e=>{if(!e)return null;const t=parseFloat(e.lat??e.latitude),o=parseFloat(e.lon??e.lng??e.longitude);return Number.isNaN(t)||Number.isNaN(o)?null:{lat:t,lon:o}},T=_(t),b=_(o),L=e=>{if(!e)return null;const t=parseFloat(e.stop_lat),o=parseFloat(e.stop_lon);return Number.isNaN(t)||Number.isNaN(o)?null:{lat:t,lon:o}},I=u.STOP_SEARCH_RADIUS_M||1200,E=u.STOP_SEARCH_LIMIT||5,M=e=>(e||"").toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").replace(/[^a-z0-9\s]/g," ").trim(),A=(e,t=2*E)=>{if(!e)return[];const o=c.findStopsByName&&c.findStopsByName(e,t)||[];if(o.length)return o.slice(0,t);const r=M(e);if(!r)return[];const s=[];for(const n of c.stops){if(s.length>=t)break;const e=M(n.stop_name);e&&e.includes(r)&&s.push(n)}return s},C=(e,t,o,r=null)=>{const s=[],n=new Set,a=(e,t,o=!1)=>{e&&!n.has(e.stop_id)&&(n.add(e.stop_id),s.push({stop:e,distance:Number.isFinite(t)?t:null,isForced:o}))};if(r&&Array.isArray(r))for(const u of r){const t=c.getStop(u);if(t){const o=parseFloat(t.stop_lat),r=parseFloat(t.stop_lon),s=!e||Number.isNaN(o)||Number.isNaN(r)?0:c.calculateDistance(e.lat,e.lon,o,r);a(t,s,!0),console.log(`üìç P√¥le multimodal: arr√™t forc√© ${t.stop_name||u} ajout√©`)}}if(e)for(const u of c.stops){const t=parseFloat(u.stop_lat),o=parseFloat(u.stop_lon);if(Number.isNaN(t)||Number.isNaN(o))continue;const r=c.calculateDistance(e.lat,e.lon,t,o);Number.isNaN(r)||r>I||a(u,r)}const i=o||t;if((!e||0===s.length)&&i){A(i).forEach((t,o)=>{const r=e?c.calculateDistance(e.lat,e.lon,parseFloat(t.stop_lat),parseFloat(t.stop_lon)):50*o;a(t,r)})}if(e||0!==s.length||(console.warn(`‚ö†Ô∏è Hybrid: aucun rep√®re g√©ographique pour ${t}, utilisation d'un fallback par lignes principales.`),c.stops.slice(0,E).forEach(e=>a(e,null))),!s.length)return console.warn(`‚ö†Ô∏è Hybrid: aucun arr√™t trouv√© pour ${t}.`),[];s.sort((e,t)=>{if(e.isForced!==t.isForced)return e.isForced?-1:1;const o="1"!==e.stop.location_type;if(o!==("1"!==t.stop.location_type))return o?-1:1;const r=null==e.distance?1/0:e.distance,s=null==t.distance?1/0:t.distance;if(r===s){const o=w(e.stop)||e.stop.stop_name||"",r=w(t.stop)||t.stop.stop_name||"";return o.localeCompare(r)}return r-s});const l=s.slice(0,E),d=l[0];if(d){const e=null!=d.distance?`${Math.round(d.distance)} m`:"distance inconnue",o=w(d.stop)||d.stop.stop_name||d.stop.stop_id||"arr√™t inconnu";console.log(`üîé Hybrid: ${l.length} arr√™t(s) candidats pour ${t}. Meilleur: ${o} (${e}).`)}return l},$=()=>{const e=e=>{if(!e||"today"===e||"Aujourd'hui"===e)return new Date;const t=String(e).split(/[-/]/).map(Number);if(t.length>=3&&t.every(e=>Number.isFinite(e))){const[e,o,r]=t;return new Date(e,o-1,r)}return new Date(e)};try{const t=e(null==r?void 0:r.date),o=parseInt(null==r?void 0:r.hour,10)||0,s=parseInt(null==r?void 0:r.minute,10)||0;return t.setHours(o,s,0,0),t}catch(t){return console.warn("‚ö†Ô∏è Hybrid: date invalide, utilisation de la date courante.",t),new Date}},k=C(T,"l‚Äôorigine",(null==s?void 0:s.fromLabel)||(null==s?void 0:s.fromName),f),B=C(b,"la destination",(null==s?void 0:s.toLabel)||(null==s?void 0:s.toName),v);if(!k.length||!B.length)return[];const x=$(),D=e=>{if(!e)return null;const t=e=>[e[1],e[0]];if(Array.isArray(e)){if(!e.length)return null;if("number"==typeof e[0][0])return e.map(t);if(Array.isArray(e[0]))return e.flat().map(t)}return"LineString"===e.type?e.coordinates.map(t):"MultiLineString"===e.type?e.coordinates.flat().map(t):null},R=(e,t)=>{if(!e||!t)return null;let o=null,r=1/0;for(let s=0;s<e.length;s++){const n=c.calculateDistance(t.lat,t.lon,e[s][0],e[s][1]);n<r&&(r=n,o=s)}return o},P=(e,t,o)=>{if(!e||e.length<2||!t||!o)return null;const r=R(e,t),s=R(e,o);if(null==r||null==s)return null;if(r===s)return[e[r],e[s]];if(r<s)return e.slice(r,s+1);return e.slice(s,r+1).reverse()},N=(e,t,o)=>{if(!e||!t||!o)return null;const r=L(t),s=L(o);if(!r||!s)return null;const n=w(t),a=w(o);let i=c.getRouteGeometry(e.routeId);!i&&e.shapeId&&(i=c.getShapeGeoJSON(e.shapeId,e.routeId));let l=D(i),u=P(l,r,s);(!u||u.length<2)&&(u=[[r.lat,r.lon],[s.lat,s.lon]]);let p=u.map(e=>[Number(e[0]),Number(e[1])]).filter(([e,t])=>Number.isFinite(e)&&Number.isFinite(t));p.length<2&&(p=[[r.lat,r.lon],[s.lat,s.lon]]);const h=m(p),g=Math.max(0,e.arrivalSeconds-e.departureSeconds),f=(e.stopTimes||[]).slice(1,-1).map(e=>{const t=c.getStop(e.stop_id);return{name:w(t)||e.stop_id,stop_id:e.stop_id,lat:t?parseFloat(t.stop_lat):null,lng:t?parseFloat(t.stop_lon):null}}).filter(e=>e.name),v=e.route||c.getRoute(e.routeId);return{step:{type:"BUS",icon:d.BUS,instruction:`Prendre ${(null==v?void 0:v.route_short_name)||e.routeId}`,polyline:{encodedPolyline:h,latLngs:p},routeColor:(null==v?void 0:v.route_color)?`#${v.route_color}`:"#3388ff",routeTextColor:(null==v?void 0:v.route_text_color)?`#${v.route_text_color}`:"#ffffff",routeShortName:(null==v?void 0:v.route_short_name)||e.routeId,departureStop:n||"Arr√™t de d√©part",arrivalStop:a||"Arr√™t d‚Äôarriv√©e",departureTime:c.formatTime(e.departureSeconds),arrivalTime:c.formatTime(e.arrivalSeconds),duration:c.formatDuration(g)||"Horaires th√©oriques",intermediateStops:f,numStops:Math.max(0,(e.stopTimes||[]).length-1),_durationSeconds:g},summary:{type:"BUS",name:(null==v?void 0:v.route_short_name)||e.routeId,color:(null==v?void 0:v.route_color)?`#${v.route_color}`:"#3388ff",textColor:(null==v?void 0:v.route_text_color)?`#${v.route_text_color}`:"#ffffff"}}},F=async({firstSegment:e,secondSegment:t,boardingStop:o,transferStop:r,finalStop:s,origin:n,destination:a,originCandidates:i,destCandidates:l,windowStartSec:d,windowEndSec:u,startStopSet:p=new Set,endStopSet:h=new Set})=>{var m,g;if(!(e&&t&&o&&r&&s))return console.warn("assembleTransferItinerary: missing required params",{firstSegment:!!e,secondSegment:!!t,boardingStop:!!o,transferStop:!!r,finalStop:!!s}),null;const f=w(o),v=w(r);w(s);const y=i.find(e=>e.stop.stop_id===o.stop_id),S=l.find(e=>e.stop.stop_id===s.stop_id),_={type:"BUS",steps:[],summarySegments:[],transfers:1,tripId:`${e.tripId}+${t.tripId}`,route:t.route},T=L(o),b=L(s);if(!T||!b)return null;const I=f?`Marcher jusqu‚Äô√† ${f}`:"Marcher jusqu‚Äô√† l‚Äôarr√™t",E=await j(I,n,T);E&&_.steps.push(E);const M=N(e,o,r);if(!M)return console.warn("assembleTransferItinerary: firstLeg build failed"),null;_.steps.push(M.step),_.summarySegments.push(M.summary);const A=Math.max(0,t.departureSeconds-e.arrivalSeconds),C=N(t,r,s);if(!C)return console.warn("assembleTransferItinerary: secondLeg build failed"),null;_.steps.push(C.step),_.summarySegments.push(C.summary);const $=await j("Marcher jusqu‚Äô√† destination",b,a);$&&_.steps.push($),_.departureTime=c.formatTime(e.departureSeconds),_._departureSeconds=e.departureSeconds,_.arrivalTime=c.formatTime(t.arrivalSeconds),_._arrivalSeconds=t.arrivalSeconds;const k=((null==E?void 0:E._durationSeconds)||0)+((null==(m=M.step)?void 0:m._durationSeconds)||0)+A+((null==(g=C.step)?void 0:g._durationSeconds)||0)+((null==$?void 0:$._durationSeconds)||0);return _.duration=k>0?c.formatDuration(k):"Horaires th√©oriques",_._hybridDiagnostics={boardingStopId:o.stop_id,transferStopId:r.stop_id,alightingStopId:s.stop_id,firstTripId:e.tripId,secondTripId:t.tripId,transfers:1,startDistanceMeters:y&&null!=y.distance?Math.round(y.distance):null,endDistanceMeters:S&&null!=S.distance?Math.round(S.distance):null,requestedWindow:{start:d,end:u},candidateStartStopIds:Array.from(p),candidateEndStopIds:Array.from(h)},_._transferInfo={waitMinutes:Math.round(A/60),transferStopName:v||r.stop_name},_},O=(e,t)=>{const o=new Map,r=new Map,s=new Set(e),n=new Set(t);for(const i of c.trips){const e=c.stopTimesByTrip[i.trip_id];if(!e||e.length<2)continue;let t=-1;for(let o=0;o<e.length;o++)if(s.has(e[o].stop_id)){t=o;break}let a=-1;for(let o=0;o<e.length;o++)if(n.has(e[o].stop_id)){a=o;break}if(-1!==t){o.has(i.route_id)||o.set(i.route_id,new Set);for(let r=t+1;r<e.length;r++)o.get(i.route_id).add(e[r].stop_id)}if(-1!==a&&a>0){r.has(i.route_id)||r.set(i.route_id,new Set);for(let t=0;t<a;t++)r.get(i.route_id).add(e[t].stop_id)}}const a=new Map;for(const[i,l]of o)for(const[e,t]of r)if(i!==e)for(const o of l)t.has(o)&&(a.has(o)||a.set(o,{startRoutes:new Set,endRoutes:new Set,isExact:!0}),a.get(o).startRoutes.add(i),a.get(o).endRoutes.add(e));if(0===a.size){const e=300;for(const[t,s]of o)for(const[o,n]of r)if(t!==o)for(const r of s){const s=c.getStop(r);if(!s)continue;const i=parseFloat(s.stop_lat),l=parseFloat(s.stop_lon);if(Number.isFinite(i))for(const d of n){const s=c.getStop(d);if(!s)continue;const n=parseFloat(s.stop_lat),u=parseFloat(s.stop_lon);if(!Number.isFinite(n))continue;const p=c.calculateDistance(i,l,n,u);if(p<=e){const e=`${r}|${d}`;a.has(e)||a.set(e,{alightStop:r,boardStop:d,startRoutes:new Set,endRoutes:new Set,isExact:!1,walkDistance:Math.round(p)}),a.get(e).startRoutes.add(t),a.get(e).endRoutes.add(o)}}}}return{startRoutes:o,endRoutes:r,transferHubs:a}},G=async({origin:e,destination:t,originCandidates:o,destCandidates:s,startStopSet:n,endStopSet:a,expandedEndIds:i,reqDate:l,windowStartSec:d,windowEndSec:p})=>{var h,m,g;if(!u.ENABLE_TRANSFERS)return[];const f=[],v=c.getServiceIds(l);if(!v||0===v.size)return f;const y=e=>Array.from(v).some(t=>c.serviceIdsMatch(e.service_id,t)),S=Array.from(n),w=Array.from(a),{startRoutes:_,endRoutes:T,transferHubs:b}=O(S,w);if(!globalThis._transferHubsLogged)if(globalThis._transferHubsLogged=!0,console.log("üéØ Analyse des correspondances:",{routesDepuisDepart:_.size,routesVersArrivee:T.size,hubsTrouves:b.size}),b.size>0){const e=Array.from(b.entries()).slice(0,3).map(([e,t])=>{var o,r,s;return{hub:t.isExact?null==(o=c.getStop(e))?void 0:o.stop_name:`${null==(r=c.getStop(t.alightStop))?void 0:r.stop_name} ‚Üí ${null==(s=c.getStop(t.boardStop))?void 0:s.stop_name}`,walk:t.walkDistance||0,fromRoutes:t.startRoutes.size,toRoutes:t.endRoutes.size}});console.log("üöè Hubs de correspondance:",e)}else console.log("‚ùå Aucun hub de correspondance trouv√© entre les lignes");if(0===b.size)return f;const L=new Set,I=[];let E=0,M=0;for(const[A,C]of b){E++;const i=C.isExact?A:C.alightStop,l=C.isExact?A:C.boardStop,f=[];for(const e of C.startRoutes){const t=c.tripsByRoute[e]||[];for(const e of t){if(!y(e))continue;const t=c.stopTimesByTrip[e.trip_id];if(!t)continue;let o=-1,s=-1;for(let e=0;e<t.length;e++)-1===o&&n.has(t[e].stop_id)&&(o=e),t[e].stop_id===i&&(s=e);if(-1!==o&&-1!==s&&o<s){const n=c.timeToSeconds(t[o].departure_time),a=c.timeToSeconds(t[s].arrival_time);null==r||r.type;n>=d&&n<=p&&f.push({trip:e,stopTimes:t,boardingIdx:o,alightIdx:s,depSec:n,arrSec:a})}}}if(M+=f.length,f.sort((e,t)=>e.depSec-t.depSec),1===E&&!globalThis._hubDebugLogged){globalThis._hubDebugLogged=!0;const e=C.isExact?null==(h=c.getStop(A))?void 0:h.stop_name:`${null==(m=c.getStop(C.alightStop))?void 0:m.stop_name} ‚Üí ${null==(g=c.getStop(C.boardStop))?void 0:g.stop_name}`;console.log(`üîé Hub #1 "${e}":`,{alightStopId:i,boardStopId:l,startRoutes:Array.from(C.startRoutes).map(e=>e.split(":").pop()),endRoutes:Array.from(C.endRoutes).map(e=>e.split(":").pop()),firstLegTrips:f.length,startStopSetSize:n.size,endStopSetSize:a.size})}for(const r of f.slice(0,10)){const h=r.arrSec+u.TRANSFER_MIN_BUFFER_SECONDS,m=r.arrSec+u.TRANSFER_MAX_WAIT_SECONDS;for(const u of C.endRoutes){const g=c.tripsByRoute[u]||[];for(const u of g){if(u.trip_id===r.trip.trip_id)continue;if(!y(u))continue;const g=`${r.trip.trip_id}->${u.trip_id}`;if(L.has(g))continue;const f=c.stopTimesByTrip[u.trip_id];if(!f)continue;let v=-1,S=-1;for(let e=0;e<f.length;e++)-1===v&&f[e].stop_id===l&&(v=e),a.has(f[e].stop_id)&&(S=e);if(-1!==v&&-1!==S&&v<S){const y=c.timeToSeconds(f[v].departure_time),w=c.timeToSeconds(f[S].arrival_time);if(y>=h&&y<=m){L.add(g);const h=c.getStop(r.stopTimes[r.boardingIdx].stop_id),m=c.getStop(i),_=c.getStop(l),T=c.getStop(f[S].stop_id),b={tripId:r.trip.trip_id,routeId:r.trip.route_id,route:c.getRoute(r.trip.route_id),shapeId:r.trip.shape_id||null,boardingStopId:r.stopTimes[r.boardingIdx].stop_id,departureSeconds:r.depSec,arrivalSeconds:r.arrSec,stopTimes:r.stopTimes.slice(r.boardingIdx,r.alightIdx+1)},E={tripId:u.trip_id,routeId:u.route_id,route:c.getRoute(u.route_id),shapeId:u.shape_id||null,alightingStopId:f[S].stop_id,departureSeconds:y,arrivalSeconds:w,stopTimes:f.slice(v,S+1)},M=await F({firstSegment:b,secondSegment:E,boardingStop:h,transferStop:m,finalStop:T,origin:e,destination:t,originCandidates:o,destCandidates:s,windowStartSec:d,windowEndSec:p,startStopSet:n,endStopSet:a});M||globalThis._assembleDebugLogged||(globalThis._assembleDebugLogged=!0,console.log("‚ö†Ô∏è assembleTransferItinerary returned null:",{firstBoardingStop:null==h?void 0:h.stop_name,transferAlightStop:null==m?void 0:m.stop_name,finalStop:null==T?void 0:T.stop_name,firstSegment:!!b,secondSegment:!!E})),M&&(!C.isExact&&C.walkDistance&&(M._transferInfo.walkBetweenStops=C.walkDistance,M._transferInfo.transferBoardStopName=null==_?void 0:_.stop_name),I.push(M))}}}}}}if("arriver"===(null==r?void 0:r.type)){const e=I.filter(e=>(e._arrivalSeconds||c.timeToSeconds(e.arrivalTime)||0)<=H);e.sort((e,t)=>{const o=e._arrivalSeconds||c.timeToSeconds(e.arrivalTime)||0;return(t._arrivalSeconds||c.timeToSeconds(t.arrivalTime)||0)-o}),f.push(...e.slice(0,u.TRANSFER_MAX_ITINERARIES))}else I.sort((e,t)=>(e._departureSeconds||0)-(t._departureSeconds||0)),f.push(...I.slice(0,u.TRANSFER_MAX_ITINERARIES));return globalThis._transferResultsLogged||(globalThis._transferResultsLogged=!0,console.log("üîÑ R√©sultat correspondances:",{hubsAnalyses:E,firstLegTripsTotal:M,candidatsTotal:I.length,"itinerairesGard√©s":f.length}),0===M&&console.log("‚ö†Ô∏è Aucun trip first leg trouv√© - v√©rifier startStopSet vs alightStopId"),f.length>0&&console.log("‚úÖ Itin√©raires de correspondance:",f.map(e=>{var t;return{departure:e.departureTime,arrival:e.arrivalTime,stepsCount:null==(t=e.steps)?void 0:t.length,_depSec:e._departureSeconds}}))),f},j=async(e,t,o)=>{if(!t||!o)return null;try{const r=await p(t,o);if(!r||!r.distanceMeters||r.distanceMeters<1)return null;const s=r.durationSeconds??g(r.distanceMeters);return{type:"WALK",icon:d.WALK,instruction:e,polylines:r.encodedPolyline?[{encodedPolyline:r.encodedPolyline}]:[],subSteps:[],totalDistanceMeters:Math.round(r.distanceMeters),departureTime:"~",arrivalTime:"~",duration:s?`${Math.max(1,Math.round(s/60))} min`:"‚Äî",_durationSeconds:s,_source:r.source||"direct"}}catch(r){return console.warn("Erreur buildWalkStep (hybrid):",r),null}},H=3600*x.getHours()+60*x.getMinutes(),U=14400,z=1800;let q,K;"arriver"===(null==r?void 0:r.type)?(K=H,q=H-U):(q=H-z,K=H+U);K<=q&&(K=q+U);const W=e=>`${Math.floor(e/3600).toString().padStart(2,"0")}:${Math.floor(e%3600/60).toString().padStart(2,"0")}`,V=`${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}`,J=["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"][x.getDay()],Y=c.getServiceIds(x);console.log(`üìÖ V192 Date: ${V} (${J}) - ${Y.size} service(s) actif(s)`),console.log("üìÖ V192 Services actifs:",Array.from(Y)),0===Y.size&&console.warn(`‚ö†Ô∏è AUCUN SERVICE ACTIF pour ${V} - Les bus ne circulent peut-√™tre pas ce jour`);console.log(`‚è∞ Fen√™tre de recherche (${(null==r?void 0:r.type)||"partir"}):`,{"demand√©":W(H),"fen√™tre":`${W(q)} - ${W(K)}`,"dur√©e":U/3600+"h"});const X=e=>{const t=new Set;if(!e)return t;const o=e.parent_station&&e.parent_station.trim()?e.parent_station.trim():null;return o&&c.groupedStopMap[o]&&c.groupedStopMap[o].forEach(e=>t.add(e)),c.groupedStopMap[e.stop_id]&&c.groupedStopMap[e.stop_id].forEach(e=>t.add(e)),t.add(e.stop_id),t},Z=Object.keys(c.groupedStopMap||{})[0];Z&&!globalThis._routerGroupMapLogged&&(globalThis._routerGroupMapLogged=!0,console.log("üó∫Ô∏è groupedStopMap sample:",Z,"->",c.groupedStopMap[Z]));const Q=new Set;k.forEach(e=>{X(e.stop).forEach(e=>Q.add(e))});const ee=new Set;B.forEach(e=>{X(e.stop).forEach(e=>ee.add(e))});const te=Array.from(Q),oe=Array.from(ee);console.log("üîç Router: Recherche directe",{startIds:te.slice(0,5),endIds:oe.slice(0,5),fenetre:`${Math.floor(q/3600)}h${Math.floor(q%3600/60)} - ${Math.floor(K/3600)}h${Math.floor(K%3600/60)}`,mode:(null==r?void 0:r.type)||"partir"});const re=(null==r?void 0:r.type)||"partir",se=h(te,oe,x,q,K,re);if((null==se?void 0:se.length)>0){console.log(`‚úÖ Router: ${se.length} trip(s) direct(s) trouv√©(s)`);const e=se.map(e=>{var t;return{dep:W(e.departureSeconds),arr:W(e.arrivalSeconds),ligne:(null==(t=e.route)?void 0:t.route_short_name)||e.routeId}});console.log("üìã V195 Tous les horaires GTFS:",e)}const ne=[];let ae=se||[];"arriver"===(null==r?void 0:r.type)?(ae=ae.filter(e=>e.arrivalSeconds<=H),ae.sort((e,t)=>t.arrivalSeconds-e.arrivalSeconds)):ae.sort((e,t)=>e.departureSeconds-t.departureSeconds);if(ae.length){const e=ae.slice(0,u.MAX_ITINERARIES);for(const t of e)try{const e=c.getStop(t.boardingStopId)||(null==(a=k[0])?void 0:a.stop),o=c.getStop(t.alightingStopId)||(null==(i=B[0])?void 0:i.stop),r=L(e),s=L(o);if(!r||!s)continue;const n=w(e),d=w(o),u={type:"BUS",tripId:t.tripId,route:t.route,steps:[],summarySegments:[]},p=n?`Marcher jusqu‚Äô√† ${n}`:"Marcher jusqu‚Äô√† l‚Äôarr√™t",h=await j(p,T,r);h&&u.steps.push(h);const m=N(t,e,o);if(!m)continue;u.steps.push(m.step);const g=d?`Marcher depuis ${d}`:"Marcher jusqu‚Äô√† destination",f=await j(g,s,b);f&&u.steps.push(f),u.summarySegments.push(m.summary),u.departureTime=c.formatTime(t.departureSeconds),u._departureSeconds=t.departureSeconds,u.arrivalTime=c.formatTime(t.arrivalSeconds),u._arrivalSeconds=t.arrivalSeconds;const v=((null==h?void 0:h._durationSeconds)||0)+((null==(l=m.step)?void 0:l._durationSeconds)||0)+((null==f?void 0:f._durationSeconds)||0);u.duration=v>0?c.formatDuration(v):"Horaires th√©oriques";const y=k.find(t=>t.stop.stop_id===(null==e?void 0:e.stop_id)),S=B.find(e=>e.stop.stop_id===(null==o?void 0:o.stop_id));u._hybridDiagnostics={boardingStopId:null==e?void 0:e.stop_id,alightingStopId:null==o?void 0:o.stop_id,startDistanceMeters:y&&null!=y.distance?Math.round(y.distance):null,endDistanceMeters:S&&null!=S.distance?Math.round(S.distance):null,requestedWindow:{start:q,end:K},candidateStartStopIds:te,candidateEndStopIds:oe},ne.push(u)}catch(le){console.warn("Erreur lors de la construction d'un itin√©raire hybride:",le)}}if((!se||!se.length)&&u.ENABLE_TRANSFERS){console.warn("‚ö†Ô∏è Hybrid: aucun trip direct trouv√©, tentative avec correspondances.");const e=await G({origin:T,destination:b,originCandidates:k,destCandidates:B,startStopSet:Q,endStopSet:ee,expandedEndIds:oe,reqDate:x,windowStartSec:q,windowEndSec:K});ne.push(...e)}const ie="arriver"===(null==r?void 0:r.type);ne.sort((e,t)=>{if(ie){const o=void 0!==e._arrivalSeconds?e._arrivalSeconds:c.timeToSeconds?c.timeToSeconds(e.arrivalTime):0;return(void 0!==t._arrivalSeconds?t._arrivalSeconds:c.timeToSeconds?c.timeToSeconds(t.arrivalTime):0)-o}return(void 0!==e._departureSeconds?e._departureSeconds:c.timeToSeconds?c.timeToSeconds(e.departureTime):0)-(void 0!==t._departureSeconds?t._departureSeconds:c.timeToSeconds?c.timeToSeconds(t.departureTime):0)}),ie||ne.forEach(e=>{(void 0!==e._departureSeconds?e._departureSeconds:c.timeToSeconds?c.timeToSeconds(e.departureTime):0)<H&&(e._isPreviousDeparture=!0)});console.log(`üìä V190 Itin√©raires (${ie?"ARRIVER":"PARTIR"}):`,ne.slice(0,5).map(e=>({dep:e.departureTime,arr:e.arrivalTime,type:e.type,avant:e._isPreviousDeparture?"‚¨ÖÔ∏è":""}))),ne.length||(console.warn("‚ö†Ô∏è Hybrid: aucun itin√©raire GTFS (direct ou correspondance) trouv√©."),console.log("üîç DEBUG - expandedStartIds:",te),console.log("üîç DEBUG - expandedEndIds:",oe),console.log("üîç DEBUG - groupedStopMap keys sample:",Object.keys(c.groupedStopMap||{}).slice(0,10)),console.table({startCandidates:k.map(e=>({id:e.stop.stop_id,name:w(e.stop)||e.stop.stop_name,dist:null!=e.distance?Math.round(e.distance):null})),endCandidates:B.map(e=>({id:e.stop.stop_id,name:w(e.stop)||e.stop.stop_name,dist:null!=e.distance?Math.round(e.distance):null})),windowStartSec:q,windowEndSec:K}));return ne}({dataManager:e,icons:o,config:W,getWalkingRoute:n,getCachedTripsBetweenStops:a,encodePolyline:Y,computeWalkDurationSeconds:J},t,r,s,i,l)}}function J(e){return!e||Number.isNaN(e)?0:Math.max(30,Math.round(e/1.35))}function Y(e){const t=e=>{let t=Math.round(1e5*e);t=t<0?~(t<<1):t<<1;let o="";for(;t>=32;)o+=String.fromCharCode(63+(32|31&t)),t>>=5;return o+=String.fromCharCode(t+63),o};let o=0,r=0,s="";for(const[n,a]of e){const e=Math.round(1e5*n),i=Math.round(1e5*a),l=i-r;s+=t(e-o),s+=t(l),o=e,r=i}return s}async function X(e,t,o){const{apiManager:r,placeIdCache:s}=e,n=`${t},${o}`;if(s.has(n))return s.get(n);if(!(null==r?void 0:r.reverseGeocode))return null;try{const e=await r.reverseGeocode(t,o);return e&&s.set(n,e),e}catch(a){return console.warn("reverseGeocode failed for",n,a),null}}class Z{constructor({dataManager:e,icons:t,googleApiKey:o,geocodeProxyUrl:r}){this.worker=null,this.isSupported="undefined"!=typeof Worker,this.requestId=0,this.pending=new Map,this.readyPromise=null,this.icons=t,this.googleApiKey=o,this.geocodeProxyUrl=r||("undefined"!=typeof window?`${window.location.origin}/api/geocode`:"/api/geocode"),this.isSupported&&e&&(this.readyPromise=this.initializeWorker(e))}async initializeWorker(e){try{this.worker=new Worker(new URL("./workers/routerWorker.js",import.meta.url),{type:"module"})}catch(s){return console.warn("RouterWorkerClient: impossible de cr√©er le worker",s),this.isSupported=!1,Promise.reject(s)}this.worker.onmessage=e=>{const{type:t,requestId:o,payload:r,error:s}=e.data||{};if("ready"===t){const e=this.pending.get("init");return void(e&&(e.resolve(!0),this.pending.delete("init")))}if("init-error"===t){const e=this.pending.get("init");return void(e&&(e.reject(new Error(s||"router worker init error")),this.pending.delete("init")))}if(!o)return;const n=this.pending.get(o);n&&(s?n.reject(new Error(s)):n.resolve(r),this.pending.delete(o))},this.worker.onerror=e=>{const t=this.pending.get("init");t&&(t.reject(e.error||new Error("router worker crashed during init")),this.pending.delete("init")),this.rejectAll(e.error||new Error("router worker crashed"))};const t=new Promise((e,t)=>{this.pending.set("init",{resolve:e,reject:t})}),o=e.createRoutingSnapshot(),r=function(e){if(!e||"object"!=typeof e)return null;const t={};return["BUS","WALK","statusWarning"].forEach(o=>{"string"==typeof e[o]&&(t[o]=e[o])}),t}(this.icons);return this.worker.postMessage({type:"init",payload:{snapshot:o,icons:r,googleApiKey:this.googleApiKey,geocodeProxyUrl:this.geocodeProxyUrl}}),t}rejectAll(e){this.pending.forEach(({reject:t})=>t(e)),this.pending.clear()}async computeHybridItinerary(e){if(!this.isSupported||!this.worker)throw new Error("RouterWorkerClient indisponible");return await this.readyPromise,this.enqueueRequest("computeItinerary",e)}enqueueRequest(e,t){const o="req_"+ ++this.requestId,r=new Promise((e,t)=>{this.pending.set(o,{resolve:e,reject:t})});return this.worker.postMessage({type:e,requestId:o,payload:t}),r}terminate(){this.worker&&(this.worker.terminate(),this.worker=null),this.rejectAll(new Error("Router worker terminated"))}}class Q{constructor({icons:e,geolocationManager:t}){this.icons=e,this.geolocationManager=t,this.timeDropdowns=new Set,this.handleTimeDropdownDocumentClick=this.handleTimeDropdownDocumentClick.bind(this)}applyThemeState(e,t=[]){const o=!!e;document.body.classList.toggle("dark-theme",o);Array.from(document.querySelectorAll("[data-theme-toggle]")).forEach(e=>{e.setAttribute("aria-pressed",o?"true":"false"),e.title=o?"Th√®me clair":"Th√®me sombre"});Array.from(document.querySelectorAll(".theme-toggle-icon")).forEach(e=>{e.textContent=o?"‚òÄÔ∏è":"üåô"});try{["map","detail-map","results-map"].forEach(e=>{const t=document.getElementById(e);t&&t.classList.toggle("dark-theme",o)})}catch(r){}(t||[]).filter(Boolean).forEach(e=>{"function"==typeof(null==e?void 0:e.applyTheme)&&(e.applyTheme(o),e.map&&e.map.invalidateSize())})}initTheme(e=[]){var t;try{this._themeRenderers=e;const o=localStorage.getItem("ui-theme"),r=null==(t=window.matchMedia)?void 0:t.call(window,"(prefers-color-scheme: dark)"),s=(null==r?void 0:r.matches)??!1,n=!o||"auto"===o,a=n?s:"dark"===o;this.applyThemeState(a,e),r&&n&&(this._mediaQueryListener=e=>{const t=localStorage.getItem("ui-theme");t&&"auto"!==t||(this.applyThemeState(e.matches,this._themeRenderers||[]),console.log("üåì Th√®me syst√®me d√©tect√©: "+(e.matches?"sombre":"clair")))},r.addEventListener("change",this._mediaQueryListener))}catch(o){console.warn("initTheme error",o)}}destroyThemeListener(){var e;if(this._mediaQueryListener){const t=null==(e=window.matchMedia)?void 0:e.call(window,"(prefers-color-scheme: dark)");null==t||t.removeEventListener("change",this._mediaQueryListener),this._mediaQueryListener=null}}populateTimeSelects(e={}){const{hall:t,results:o}=e,r=e=>{if(!e)return;const{dateEl:t,hourEl:o,minEl:r}=e;if(!t||!o||!r)return;const s=new Date,n=s.getHours(),a=5*Math.round(s.getMinutes()/5);t.innerHTML="";for(let i=0;i<7;i++){const e=new Date;e.setDate(s.getDate()+i);const o=e.toISOString().split("T")[0],r=document.createElement("option");r.value=o,r.textContent=this.formatDateLabel(e,i),0===i&&(r.selected=!0),t.appendChild(r)}o.innerHTML="";for(let i=0;i<24;i++){const e=document.createElement("option");e.value=i,e.textContent=`${String(i).padStart(2,"0")} h`,i===n&&(e.selected=!0),o.appendChild(e)}r.innerHTML="";for(let i=0;i<60;i+=5){const e=document.createElement("option");e.value=i,e.textContent=String(i).padStart(2,"0"),i===a&&(e.selected=!0),r.appendChild(e)}this.enhanceTimeSelect(o,e=>(null==e?void 0:e.textContent)||"--"),this.enhanceTimeSelect(r,e=>(null==e?void 0:e.textContent)||"--")};r(t),r(o)}formatDateLabel(e,t){if(0===t)return"Aujourd'hui";if(1===t)return"Demain";return new Intl.DateTimeFormat("fr-FR",{weekday:"long"}).format(e)}setupPlannerListeners(e,t,o){const{submitBtn:r,fromInput:s,toInput:n,fromSuggestions:a,toSuggestions:i,swapBtn:l,whenBtn:c,popover:d,dateSelect:u,hourSelect:p,minuteSelect:h,popoverSubmitBtn:m,geolocateBtn:g}=t,{onExecuteSearch:f,handleAutocomplete:v,getFromPlaceId:y,setFromPlaceId:S,getToPlaceId:w,setToPlaceId:_}=o;let T=!1;try{u&&u.addEventListener("change",()=>{T=!0}),p&&p.addEventListener("change",()=>{T=!0}),h&&h.addEventListener("change",()=>{T=!0})}catch(b){}r.addEventListener("click",async o=>{o.preventDefault(),d&&!d.classList.contains("hidden")&&(d.classList.add("hidden"),c.classList.remove("popover-active"),this.closeAllTimeDropdowns()),await f(e,t)}),s.addEventListener("input",e=>{v(e.target.value,a,e=>{S(e)})}),n.addEventListener("input",e=>{v(e.target.value,i,e=>{_(e)})}),c&&d&&(c.addEventListener("click",e=>{e.stopPropagation(),d.classList.toggle("hidden"),c.classList.toggle("popover-active"),T=!1}),d.querySelectorAll(".popover-tab").forEach(e=>{e.addEventListener("click",e=>{d.querySelectorAll(".popover-tab").forEach(e=>e.classList.remove("active")),e.currentTarget.classList.add("active");const t=e.currentTarget.dataset.tab;m.textContent="arriver"===t?"Valider l'arriv√©e":"Partir maintenant"})}),m.addEventListener("click",()=>{var e,t,o;let r=(null==(e=u.options[u.selectedIndex])?void 0:e.text)||"";const s=(null==(o=null==(t=d.querySelector(".popover-tab.active"))?void 0:t.dataset)?void 0:o.tab)||"partir";if("partir"===s&&!T){const e=new Date,t=e.toISOString().split("T")[0];let o=e.getHours(),r=5*Math.round(e.getMinutes()/5);60===r&&(r=0,o=(o+1)%24);try{u.value=t,p.value=o,h.value=r,this.syncEnhancedTimeSelect(p),this.syncEnhancedTimeSelect(h)}catch(b){}}if(u.value===(new Date).toISOString().split("T")[0]){const e=new Date,t=parseInt(p.value)||0,o=parseInt(h.value)||0,s=new Date;if(s.setHours(t,o,0,0),s<e){const e=new Date;e.setDate(e.getDate()+1);const s=e.toISOString().split("T")[0];for(let n=0;n<u.options.length;n++)if(u.options[n].value===s){u.value=s,r=u.options[n].text,console.log(`‚è∞ Heure pass√©e (${t}h${String(o).padStart(2,"0")}) ‚Üí Basculement automatique sur Demain`);break}}}const n=String(p.value).padStart(2,"0"),a=String(h.value).padStart(2,"0"),i=c.querySelector("span");let l="arriver"===s?"Arriv√©e":"D√©part";i.textContent="Aujourd'hui"===r?`${l} √† ${n}h${a}`:`${l} ${r.toLowerCase()} √† ${n}h${a}`,d.classList.add("hidden"),c.classList.remove("popover-active"),this.closeAllTimeDropdowns()}),d.addEventListener("click",e=>e.stopPropagation())),l&&l.addEventListener("click",e=>{e.preventDefault();const t=s.value;s.value=n.value,n.value=t;const o=y();S(w()),_(o)}),g&&g.addEventListener("click",e=>{e.preventDefault(),this.geolocationManager?this.geolocationManager.useCurrentLocationAsDeparture({fromInput:s,toInput:n,geolocateBtn:g,onPlaceResolved:e=>{S(e)}}):console.warn("Geolocation manager non initialis√©")})}enhanceTimeSelect(e,t=e=>(null==e?void 0:e.textContent)||""){e&&(e._enhancedDropdown||this.createTimeDropdown(e),e._enhancedDropdown.formatOption=t,this.buildTimeDropdownOptions(e),this.updateTimeDropdownDisplay(e))}createTimeDropdown(e){const t=document.createElement("div");t.className="time-select-wrapper";e.parentNode.insertBefore(t,e),t.appendChild(e),e.classList.add("time-select-native"),e.setAttribute("tabindex","-1"),e.setAttribute("aria-hidden","true");const o=document.createElement("button");o.type="button",o.className="time-select-display",o.setAttribute("aria-haspopup","listbox"),o.setAttribute("aria-expanded","false"),t.appendChild(o);const r=document.createElement("div");r.className="time-select-menu",r.setAttribute("role","listbox"),t.appendChild(r),o.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();const r=t.classList.contains("is-open");this.toggleTimeDropdown(e,!r)}),e.addEventListener("change",()=>{this.updateTimeDropdownDisplay(e)}),e._enhancedDropdown={wrapper:t,displayBtn:o,menu:r,formatOption:e=>(null==e?void 0:e.textContent)||""};const s=e.id||"";/hour/i.test(s)?t.classList.add("time-select-wrapper-hour"):/minute/i.test(s)&&t.classList.add("time-select-wrapper-minute"),this.timeDropdowns.add(e),this.timeDropdownListenerAttached||(document.addEventListener("click",this.handleTimeDropdownDocumentClick),this.timeDropdownListenerAttached=!0)}buildTimeDropdownOptions(e){const t=null==e?void 0:e._enhancedDropdown;if(!t)return;const{menu:o,formatOption:r}=t;o.innerHTML="",Array.from(e.options||[]).forEach(t=>{const s=document.createElement("button");s.type="button",s.className="time-select-option",s.textContent=r(t),s.dataset.value=t.value,s.setAttribute("role","option"),t.disabled&&(s.disabled=!0),t.value===e.value&&s.classList.add("is-active"),s.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),e.value=t.value,this.updateTimeDropdownDisplay(e),this.toggleTimeDropdown(e,!1),e.dispatchEvent(new Event("change",{bubbles:!0}))}),o.appendChild(s)})}updateTimeDropdownDisplay(e){const t=null==e?void 0:e._enhancedDropdown;if(!t)return;const{displayBtn:o,menu:r,formatOption:s}=t,n=e.options[e.selectedIndex];o.textContent=s(n)||"--",r.querySelectorAll(".time-select-option").forEach(t=>{t.classList.toggle("is-active",t.dataset.value===e.value)})}toggleTimeDropdown(e,t){const o=null==e?void 0:e._enhancedDropdown;if(!o)return;t&&this.timeDropdowns.forEach(t=>{t!==e&&this.toggleTimeDropdown(t,!1)});const{wrapper:r,displayBtn:s}=o;r.classList.toggle("is-open",t),s.setAttribute("aria-expanded",t?"true":"false")}handleTimeDropdownDocumentClick(e){e.target.closest(".time-select-wrapper")||this.closeAllTimeDropdowns()}closeAllTimeDropdowns(){this.timeDropdowns.forEach(e=>this.toggleTimeDropdown(e,!1))}syncEnhancedTimeSelect(e){(null==e?void 0:e._enhancedDropdown)&&this.updateTimeDropdownDisplay(e)}}function ee(e,t,o,r){const s=(o-e)*Math.PI/180,n=(r-t)*Math.PI/180,a=Math.sin(s/2)**2+Math.cos(e*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(n/2)**2;return 6371e3*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))}function te({apiManager:e,icons:t={},onUserLocationUpdate:o,onUserLocationError:r}={}){const s={userLocation:null,userPlaceId:null,isGeocoding:!1,lastGeocodeTime:0,lastGeocodePos:null,hallButton:null,resultsButton:null,watchId:null},n=t.GEOLOCATE||"",a=t.GEOLOCATE_SPINNER||"",i=()=>{s.hallButton&&(s.hallButton.disabled=!0),s.resultsButton&&(s.resultsButton.disabled=!0)},l=e=>{e&&(e.innerHTML=n,e.disabled=!1)},c=t=>{const r=t.coords.latitude,n=t.coords.longitude;if(s.userLocation){if(ee(s.userLocation.lat,s.userLocation.lng,r,n)<10)return}s.userLocation={lat:r,lng:n},s.hallButton&&(s.hallButton.disabled=!1),s.resultsButton&&(s.resultsButton.disabled=!1),"function"==typeof o&&o(s.userLocation);const a=Date.now();let i=!1;if(s.lastGeocodeTime)if(null!==s.userPlaceId||s.isGeocoding){const e=a-s.lastGeocodeTime;let t=0;s.lastGeocodePos&&(t=ee(s.lastGeocodePos.lat,s.lastGeocodePos.lng,r,n)),(e>6e4||t>200)&&(i=!0)}else i=!0;else i=!0;i&&!s.isGeocoding&&((async(t,o)=>{if(e&&"function"==typeof e.reverseGeocode){if(!s.isGeocoding){s.isGeocoding=!0;try{const r=await e.reverseGeocode(t,o);s.userPlaceId=r||null,r&&console.log("G√©olocalisation invers√©e r√©ussie, place_id:",r)}catch(r){console.error("Erreur lors de la g√©olocalisation invers√©e:",r),s.userPlaceId=null}finally{s.isGeocoding=!1}}}else console.warn("Aucun apiManager.reverseGeocode disponible")})(r,n),s.lastGeocodeTime=a,s.lastGeocodePos={lat:r,lng:n})},d=e=>{console.warn(`Erreur de g√©olocalisation (code ${e.code}): ${e.message}`),i(),"function"==typeof r&&r(e)};return{startWatching:({hallButton:e,resultsButton:t}={})=>{if(s.hallButton=e||s.hallButton,s.resultsButton=t||s.resultsButton,s.hallButton&&(s.hallButton.innerHTML=n),s.resultsButton&&(s.resultsButton.innerHTML=n),"undefined"==typeof navigator||!navigator.geolocation)return console.warn("La g√©olocalisation n'est pas support√©e par ce navigateur."),void i();null===s.watchId&&(s.watchId=navigator.geolocation.watchPosition(c,d,{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}))},useCurrentLocationAsDeparture:async({fromInput:e,toInput:t,geolocateBtn:o,onPlaceResolved:r}={})=>{if(!s.userLocation)return void alert("Impossible de r√©cup√©rer votre position. Avez-vous autoris√© la g√©olocalisation ?");const n=o||s.hallButton||s.resultsButton;var i;if((i=n)&&(i.innerHTML=a,i.disabled=!0),s.userPlaceId&&!s.isGeocoding||(console.log("Attente du reverse geocoding..."),await function(e){return e.isGeocoding?new Promise(t=>{const o=setInterval(()=>{e.isGeocoding||(clearInterval(o),t())},100)}):Promise.resolve()}(s)),!s.userPlaceId)return alert("Impossible de convertir votre position en adresse pour le planificateur. Veuillez r√©essayer."),void l(n);"function"==typeof r&&r(s.userPlaceId),e&&(e.value="Ma Position"),t&&t.focus(),l(n)},handleGeolocationSuccess:c,handleGeolocationError:d,getUserLocation:()=>s.userLocation?{...s.userLocation}:null,getUserPlaceId:()=>s.userPlaceId}}const oe=new Set(["--:--","~"]),re=new Set(["undefined","null","--","--:--","‚Äî","n/a","na"]);function se(e){if("string"!=typeof e)return!1;const t=e.trim();return 0!==t.length&&!oe.has(t)}function ne(e){if(null==e)return!0;if("number"==typeof e)return!1;const t=String(e).trim();if(!t)return!0;const o=t.toLowerCase();return!!re.has(o)||(!!/^[-‚Äì‚Äî\s:._]+$/.test(t)||("inconnu"===o||"unknown"===o))}function ae(e,t="Arr√™t √† pr√©ciser"){return ne(e)?t:e}function ie(e,t="--:--"){return ne(e)?t:e}function le(e,t="BUS"){return ne(e)?t:e}function ce(e,t){return!ne(e)||!ne(t)}function de(e){if(!se(e))return null;const t=e.match(/^(\d{1,2}):(\d{2})$/);if(!t)return null;const o=Number.parseInt(t[1],10),r=Number.parseInt(t[2],10);return Number.isFinite(o)&&Number.isFinite(r)?60*o+r:null}function ue(e){if(!Number.isFinite(e))return null;for(;e<0;)e+=1440;const t=Math.abs(e)%60,o=Math.floor(e/60);return`${String(o).padStart(2,"0")}:${String(t).padStart(2,"0")}`}function pe(e,t){const o=de(e);if(null===o||!Number.isFinite(t))return null;return ue(o+Math.round(t/60))}function he(e,t){const o=de(e);if(null===o||!Number.isFinite(t))return null;return ue(o-Math.round(t/60))}function me(e,t){const o=de(e),r=de(t);if(null===o||null===r)return null;let s=r-o;return s<0&&(s+=1440),s}function ge(e){if(!e)return"--:--";try{const t=new Date(e),o=String(t.getHours()).padStart(2,"0");return`${o}:${String(t.getMinutes()).padStart(2,"0")}`}catch(t){return"--:--"}}function fe(e){if(!e)return"";try{const t=parseInt(e.slice(0,-1));if(isNaN(t)||t<1)return"";const o=Math.round(t/60);if(o<1)return"< 1 min";if(o>60){const e=Math.floor(o/60),t=o%60;return 0===t?`${e}h`:`${e}h ${t}min`}return`${o} min`}catch(t){return""}}function ve(e){if(!e)return 0;try{return parseInt(e.slice(0,-1))||0}catch(t){return 0}}const ye=new Map;function Se(e){return e?e.toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").replace(/[^a-z0-9]/g,"").trim():""}function we(e,t){if(!e||!t||!t.isLoaded)return null;const o=Se(e);if(!o)return null;if(ye.has(o))return ye.get(o);let r=null;if("function"==typeof t.findStopsByName){const o=t.findStopsByName(e,1);o&&o.length&&(r=o[0])}if(!r&&Array.isArray(t.masterStops))for(const s of t.masterStops)if(Se(s.stop_name)===o){r=s;break}if(r){const e={lat:parseFloat(r.stop_lat),lng:parseFloat(r.stop_lon)};return ye.set(o,e),e}return null}function _e(e){if(!e)return!1;if("WAIT"===e.type)return!0;const t=(e.instruction||"").toLowerCase(),o=t.includes("correspondance")||t.includes("attente")||t.includes("transfert"),r=ne(e.routeShortName),s=ne(e.departureStop)&&ne(e.arrivalStop);return o&&(r||s)}function Te(e){if(!e)return null;const t=e=>{if(!Array.isArray(e))return null;const t=e.map(e=>{if(!Array.isArray(e)||e.length<2)return null;const t=Number(e[0]),o=Number(e[1]);return Number.isFinite(t)&&Number.isFinite(o)?[t,o]:null}).filter(Boolean);return t.length?t:null};if(Array.isArray(e)){const o=t(e);if(o)return o}if(Array.isArray(e.latLngs)){const o=t(e.latLngs);if(o)return o}if(Array.isArray(e.points)){const o=t(e.points);if(o)return o}if(Array.isArray(e.coordinates)){const o=t(e.coordinates.map(([e,t])=>[t,e]));if(o)return o}const o=function(e){return e?"string"==typeof e?e:e.encodedPolyline||e.points||null:null}(e);if(o)try{return function(e){if(!e)return[];const t=[];let o=0,r=e.length,s=0,n=0;for(;o<r;){let r,a=0,i=0;do{r=e.charCodeAt(o++)-63,i|=(31&r)<<a,a+=5}while(r>=32);s+=1&i?~(i>>1):i>>1,a=0,i=0;do{r=e.charCodeAt(o++)-63,i|=(31&r)<<a,a+=5}while(r>=32);n+=1&i?~(i>>1):i>>1,t.push([s/1e5,n/1e5])}return t}(o)}catch(r){console.warn("getPolylineLatLngs: decode failed",r)}return null}function be(e){if(!e||_e(e))return[];const t=[],o=e=>{e&&t.push(e)};return"BUS"===e.type?o(null==e?void 0:e.polyline):Array.isArray(e.polylines)&&e.polylines.length?e.polylines.forEach(o):o(null==e?void 0:e.polyline),t}const Le={BUS:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/></svg>',busSmall:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/></svg>',statusTriangle:'<svg width="16" height="8" viewBox="0 0 16 8" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M8 0L16 8H0L8 0Z" /></svg>',statusWarning:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>',statusError:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>',BICYCLE:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM5 12c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 8.5c-1.9 0-3.5-1.6-3.5-3.5s1.6-3.5 3.5-3.5 3.5 1.6 3.5 3.5-1.6 3.5-3.5 3.5zm5.8-10l2.4-2.4.8.8c1.3 1.3 3 2.1 5.1 2.1V9c-1.5 0-2.7-.6-3.6-1.5l-1.9-1.9c-.5-.4-1-.6-1.6-.6s-1.1.2-1.4.6L7.8 8.4c-.4.4-.6.9-.6 1.4 0 .6.2 1.1.6 1.4L11 14v5h2v-6.2l-2.2-2.3zM19 12c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 8.5c-1.9 0-3.5-1.6-3.5-3.5s1.6-3.5 3.5-3.5 3.5 1.6 3.5 3.5-1.6 3.5-3.5 3.5z"/></svg>',WALK:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/></svg>',ALL:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l2.4 7.4h7.6l-6 4.6 2.3 7-6.3-4.6-6.3 4.6 2.3-7-6-4.6h7.6z"/></svg>',LEAF_ICON:'<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17 8C8 10 5.9 16.17 3.82 21.34l1.89.66.95-2.3c.48.17.98.3 1.34.3C19 20 22 3 22 3c-1 2-8 2.25-13 3.25S2 11.5 2 13.5s1.75 3.75 1.75 3.75C7 8 17 8 17 8z"/></svg>',GEOLOCATE:'<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2.5a6.5 6.5 0 0 0-6.5 6.5c0 4.9 6.5 12.5 6.5 12.5s6.5-7.6 6.5-12.5A6.5 6.5 0 0 0 12 2.5Zm0 9.3a2.8 2.8 0 1 1 0-5.6 2.8 2.8 0 0 1 0 5.6Z"/></svg>',GEOLOCATE_SPINNER:'<div class="spinner"></div>',MAP_LOCATE:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L7 12l10 0L12 2z"/><circle cx="12" cy="12" r="10"/></svg>',MANEUVER:{STRAIGHT:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>',TURN_LEFT:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 14 4 9 9 4"></polyline><path d="M20 20v-7a4 4 0 0 0-4-4H4"></path></svg>',TURN_RIGHT:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 14 20 9 15 4"></polyline><path d="M4 20v-7a4 4 0 0 1 4-4h12"></path></svg>',TURN_SLIGHT_LEFT:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M17 5 9 13v7"></path><path d="m8 18 4-4"></path></svg>',TURN_SLIGHT_RIGHT:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m21 3-5 5"/><path d="M21 3v8h-8"/><path d="m3 21 5.5-5.5"/></svg>',ROUNDABOUT_LEFT:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M10 9.5c.1-.4.5-.8.9-1s1-.3 1.5-.3c.7 0 1.3.1 1.9.4c.6.3 1.1.7 1.5 1.1c.4.5.7 1 .8 1.7c.1.6.1 1.3 0 1.9c-.2.7-.4 1.3-.8 1.8c-.4.5-1 1-1.6 1.3c-.6.3-1.3.5-2.1.5c-.6 0-1.1-.1-1.6-.2c-.5-.1-1-.4-1.4-.7c-.4-.3-.7-.7-.9-1.1"></path><path d="m7 9 3-3 3 3"></path><circle cx="12" cy="12" r="10"></circle></svg>',ROUNDABOUT_RIGHT:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9.5c-.1-.4-.5-.8-.9-1s-1-.3-1.5-.3c-.7 0-1.3.1-1.9.4c-.6.3-1.1.7-1.5 1.1c-.4.5-.7 1-.8 1.7c-.1.6-.1 1.3 0 1.9c.2.7.4 1.3.8 1.8c.4.5 1 1 1.6 1.3c.6.3 1.3.5 2.1.5c.6 0 1.1-.1 1.6-.2c.5-.1 1-.4 1.4-.7c.4-.3.7-.7-.9-1.1"></path><path d="m17 9-3-3-3 3"></path><circle cx="12" cy="12" r="10"></circle></svg>',DEFAULT:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m12 16 4-4-4-4"></path><path d="M8 12h8"></path></svg>'}},Ie={annulation:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',retard:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',default:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'};function Ee(e){switch(e){case"TURN_LEFT":return Le.MANEUVER.TURN_LEFT;case"TURN_RIGHT":return Le.MANEUVER.TURN_RIGHT;case"TURN_SLIGHT_LEFT":return Le.MANEUVER.TURN_SLIGHT_LEFT;case"TURN_SLIGHT_RIGHT":return Le.MANEUVER.TURN_SLIGHT_RIGHT;case"ROUNDABOUT_LEFT":return Le.MANEUVER.ROUNDABOUT_LEFT;case"ROUNDABOUT_RIGHT":return Le.MANEUVER.ROUNDABOUT_RIGHT;case"STRAIGHT":return Le.MANEUVER.STRAIGHT;default:return Le.MANEUVER.DEFAULT}}let Me={},Ae=[];function Ce(e,t,o,r){if(!e||!o)return;o.innerHTML="",Me={};let s=0;const n={majeures:{name:"Lignes majeures",routes:[]},express:{name:"Lignes express",routes:[]},quartier:{name:"Lignes de quartier",routes:[]},navettes:{name:"Navettes",routes:[]}},a=["majeures","express","quartier","navettes"];e.routes.forEach(e=>{const t=B(e.route_short_name);a.includes(t)&&n[t].routes.push(e)});for(const[i,l]of Object.entries(n)){if(0===l.routes.length)continue;const e=document.createElement("div");e.className="trafic-group";let r="";l.routes.sort((e,t)=>e.route_short_name.localeCompare(t.route_short_name,void 0,{numeric:!0})),l.routes.forEach(e=>{const o=t[e.route_id]||{status:"normal",message:""},n=e.route_color?`#${e.route_color}`:"#3388ff",a=e.route_text_color?`#${e.route_text_color}`:"#ffffff";"normal"!==o.status&&s++;const i=e.route_short_name;Me[i]={routeId:e.route_id,shortName:e.route_short_name,longName:k[e.route_short_name]||e.route_long_name||"",color:n,textColor:a,status:o.status,message:o.message,category:l.name};const c="normal"!==o.status?'<span class="status-icon"></span>':"";r+=`\n                <div class="trafic-badge-item status-${o.status}" data-line="${i}">\n                    <span class="line-badge" style="background-color: ${n}; color: ${a};">\n                        ${e.route_short_name}\n                    </span>\n                    ${c}\n                </div>\n            `}),e.innerHTML=`\n            <h4>${l.name}</h4>\n            <div class="trafic-badge-list">\n                ${r}\n            </div>\n        `,o.appendChild(e)}return function(e){e.querySelectorAll(".trafic-badge-item").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.line,o=Me[t];o&&function(e){let t=document.getElementById("line-detail-modal");t||(t=document.createElement("div"),t.id="line-detail-modal",t.className="line-detail-modal",t.innerHTML='\n            <div class="line-detail-backdrop"></div>\n            <div class="line-detail-content">\n                <button class="line-detail-close" aria-label="Fermer">\n                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                        <line x1="18" y1="6" x2="6" y2="18"></line>\n                        <line x1="6" y1="6" x2="18" y2="18"></line>\n                    </svg>\n                </button>\n                <div class="line-detail-header">\n                    <span class="line-detail-badge"></span>\n                    <span class="line-detail-name"></span>\n                </div>\n                <div class="line-detail-body">\n                    <div class="line-detail-status"></div>\n                    <div class="line-detail-section">\n                        <h4>Raison :</h4>\n                        <p class="line-detail-reason"></p>\n                    </div>\n                    <div class="line-detail-section">\n                        <h4>Informations compl√©mentaires :</h4>\n                        <p class="line-detail-info"></p>\n                    </div>\n                </div>\n            </div>\n        ',document.body.appendChild(t),t.querySelector(".line-detail-backdrop").addEventListener("click",$e),t.querySelector(".line-detail-close").addEventListener("click",$e));const o=t.querySelector(".line-detail-badge");o.textContent=e.shortName,o.style.backgroundColor=e.color,o.style.color=e.textColor,t.querySelector(".line-detail-name").textContent=e.longName||e.category;const r=t.querySelector(".line-detail-status"),s={normal:{label:"Trafic normal",class:"status-normal",icon:"‚úì"},perturbation:{label:"Perturbation en cours",class:"status-perturbation",icon:"!"},retard:{label:"Retards signal√©s",class:"status-retard",icon:"‚è±"},annulation:{label:"Service annul√©",class:"status-annulation",icon:"‚úï"},travaux:{label:"Travaux en cours",class:"status-travaux",icon:"‚ö†"}},n=s[e.status]||s.normal;r.className=`line-detail-status ${n.class}`,r.innerHTML=`<span class="status-badge-icon">${n.icon}</span> ${n.label}`;const a=t.querySelector(".line-detail-reason"),i=t.querySelector(".line-detail-info");"normal"===e.status?(a.textContent="Aucune perturbation signal√©e",i.textContent="Le trafic est normal sur cette ligne."):(a.textContent=e.message||"Information non disponible",i.textContent="Nous vous conseillons de pr√©voir un temps de trajet suppl√©mentaire. Consultez les horaires en temps r√©el pour plus de d√©tails.");t.classList.add("active"),document.body.style.overflow="hidden"}(o)})})}(o),r&&(r.textContent=s,r.classList.toggle("hidden",0===s)),s}function $e(){const e=document.getElementById("line-detail-modal");e&&(e.classList.remove("active"),document.body.style.overflow="")}function ke(e,t){const o=document.querySelector(".news-banner"),r=null==o?void 0:o.querySelector(".news-banner-text"),s=null==o?void 0:o.querySelector(".news-banner-label"),n=null==o?void 0:o.querySelector(".news-banner-icon");if(null==o||o.querySelector(".news-banner-link"),!o||!r)return;Ae=[];let a="normal";for(const[i,l]of Object.entries(t))if("normal"!==l.status){const t=e.getRoute(i);t&&(Ae.push({shortName:t.route_short_name,longName:k[t.route_short_name]||t.route_long_name||"",color:t.route_color?`#${t.route_color}`:"#3388ff",textColor:t.route_text_color?`#${t.route_text_color}`:"#ffffff",status:l.status,message:l.message}),"annulation"===l.status?a="annulation":"perturbation"===l.status&&"annulation"!==a?a="perturbation":"retard"===l.status&&"normal"===a&&(a="retard"))}if(o.classList.remove("severity-normal","severity-perturbation","severity-retard","severity-annulation"),o.classList.add(`severity-${a}`),0===Ae.length)r.textContent="Trafic normal sur l'ensemble du r√©seau P√©ribus",r.classList.remove("marquee-text"),o.classList.remove("has-perturbations"),s&&(s.textContent="Actualit√©s"),n&&(n.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>');else{const e=Ae.map(e=>`Ligne ${e.shortName}`).join(" ‚Ä¢ ");r.innerHTML=`<span class="marquee-inner">${e} ‚Äî Cliquez pour voir les d√©tails</span>`,r.classList.add("marquee-text"),o.classList.add("has-perturbations"),s&&(s.textContent=`${Ae.length} alerte${Ae.length>1?"s":""}`),n&&(n.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'),setTimeout(()=>{const e=r.querySelector(".marquee-inner");if(e&&e.scrollWidth>r.clientWidth){r.classList.add("marquee-active");const t=Math.max(10,e.scrollWidth/50);e.style.animationDuration=`${t}s`}},100)}o.style.cursor=Ae.length>0?"pointer":"default",o.onclick=Ae.length>0?e=>{e.target.classList.contains("news-banner-link")||function(){if(0===Ae.length)return;let e=document.getElementById("banner-detail-modal");e||(e=document.createElement("div"),e.id="banner-detail-modal",e.className="banner-detail-modal",e.innerHTML='\n            <div class="banner-detail-backdrop"></div>\n            <div class="banner-detail-content">\n                <button class="banner-detail-close" aria-label="Fermer">\n                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                        <line x1="18" y1="6" x2="6" y2="18"></line>\n                        <line x1="6" y1="6" x2="18" y2="18"></line>\n                    </svg>\n                </button>\n                <div class="banner-detail-header">\n                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>\n                    <h3>Perturbations en cours</h3>\n                </div>\n                <div class="banner-detail-body"></div>\n                <div class="banner-detail-footer">\n                    <a href="#trafic" class="banner-detail-link">Voir toutes les lignes</a>\n                </div>\n            </div>\n        ',document.body.appendChild(e),e.querySelector(".banner-detail-backdrop").addEventListener("click",Be),e.querySelector(".banner-detail-close").addEventListener("click",Be),e.querySelector(".banner-detail-link").addEventListener("click",Be));e.querySelector(".banner-detail-body").innerHTML=Ae.map(e=>{const t={perturbation:{label:"Perturbation",class:"status-perturbation"},retard:{label:"Retard",class:"status-retard"},annulation:{label:"Annulation",class:"status-annulation"},travaux:{label:"Travaux",class:"status-travaux"}}[e.status]||{label:"Info",class:"status-perturbation"};return`\n            <div class="banner-perturbation-item">\n                <div class="banner-perturbation-header">\n                    <span class="banner-line-badge" style="background-color: ${e.color}; color: ${e.textColor};">${e.shortName}</span>\n                    <span class="banner-status-tag ${t.class}">${t.label}</span>\n                </div>\n                <p class="banner-perturbation-message">${e.message||"Perturbation signal√©e sur cette ligne."}</p>\n            </div>\n        `}).join(""),e.querySelector(".banner-detail-header h3").textContent=`${Ae.length} perturbation${Ae.length>1?"s":""} en cours`,e.classList.add("active"),document.body.style.overflow="hidden"}()}:null}function Be(){const e=document.getElementById("banner-detail-modal");e&&(e.classList.remove("active"),document.body.style.overflow="")}function xe(e,t="partir"){if(!Array.isArray(e))return[];const o=new Map;e.forEach(e=>{const t=function(e){if(!e)return"null";const t=(e.summarySegments||[]).map(e=>e.name||e.routeShortName||"X").join(">"),o=(e.steps||[]).filter(e=>"BUS"===e.type).map(e=>{var t;return`${e.routeShortName||(null==(t=e.route)?void 0:t.route_short_name)||""}:${De(e.departureStop)}-${De(e.arrivalStop)}`}).join("|");return`${e.type}::${t}::${o}`}(e);o.has(t)||o.set(t,[]),o.get(t).push(e)});const r=[];return o.forEach((e,o)=>{if(1!==e.length)if(e.sort((e,t)=>Re(e.departureTime)-Re(t.departureTime)),"arriver"===t){const t=3,o=Math.max(0,e.length-t);r.push(...e.slice(o))}else r.push(e[0]);else r.push(e[0])}),console.log(`üîÑ D√©duplication (${t}): ${e.length} ‚Üí ${r.length} itin√©raires`),r}function De(e){return e?e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]/g,"").slice(0,20):""}function Re(e){if(!e||"string"!=typeof e)return 1/0;const t=de(e);return null!==t?t:1/0}function Pe(e,t=null){if(!Array.isArray(e))return[];if(!t)return e;let o;const r=t.date;if(o=r&&"today"!==r&&"Aujourd'hui"!==r?r instanceof Date?r:new Date(r):new Date,isNaN(o.getTime()))return console.warn("‚ö†Ô∏è filterExpiredDepartures: date invalide, pas de filtrage"),e;const s=new Date,n=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`,a=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`;if(a!==n)return console.log(`üìÖ V205: Recherche pour ${a} (‚â† aujourd'hui ${n}) ‚Üí pas de filtrage horaire`),e;const i="arriver"===t.type;let l;if(i){const e=new Date;l=60*e.getHours()+e.getMinutes(),console.log(`üïê V223: Mode ARRIVER - Filtrage des trajets qui arrivent avant ${e.getHours()}:${String(e.getMinutes()).padStart(2,"0")} (heure actuelle)`)}else{const e=parseInt(t.hour)||0,o=parseInt(t.minute)||0;l=60*e+o,console.log(`üïê V205: Filtrage des trajets avant ${e}:${String(o).padStart(2,"0")} (heure demand√©e)`)}const c=e.filter(e=>{const t=null==e?void 0:e.type;if("BIKE"===t||"WALK"===t||(null==e?void 0:e._isBike)||(null==e?void 0:e._isWalk))return!0;const o=i?null==e?void 0:e.arrivalTime:null==e?void 0:e.departureTime;if(!o||"~"===o||"--:--"===o)return!0;const r=Re(o);return r===1/0||r>=l-2}),d=e.length-c.length;return d>0&&console.log(`üö´ ${d} trajet(s) pass√©(s) filtr√©(s)`),c}function Ne(e,t,o){if(!Array.isArray(e))return[];const r=60*t+o;return e.filter(e=>{const t=null==e?void 0:e.arrivalTime;if(!t||"~"===t||"--:--"===t)return!0;const o=Re(t);return o===1/0||o<=r})}function Fe(e,t){if(!t||"arriver"!==t.type)return e;if(!Array.isArray(e)||!e.length)return e;const o=parseInt(t.hour)||0,r=parseInt(t.minute)||0,s=60*o+r;console.log(`üéØ rankArrivalItineraries: cible ${String(o).padStart(2,"0")}:${String(r).padStart(2,"0")} (${s}min), ${e.length} itin√©raires`);const n=e.filter(e=>"BIKE"!==e.type&&"WALK"!==e.type&&!e._isBike&&!e._isWalk),a=e.filter(e=>"BIKE"===e.type||e._isBike),i=e.filter(e=>"WALK"===e.type||e._isWalk);n.sort((e,t)=>{const o=Re(e.arrivalTime),r=Re(t.arrivalTime),n=o<=s;return n!==r<=s?n?-1:1:r-o});const l=[...n,...a,...i];return console.log("üìã Tri ARRIVER (BUS d'abord, arriv√©e d√©croissante):",l.slice(0,5).map(e=>`${e.type}:${e.arrivalTime}`).join(", ")),l}function Oe(e,t=5){if(!Array.isArray(e))return[];const o=[];let r=null,s=null;for(const i of e){const e=(null==i?void 0:i.type)||"BUS";"BIKE"===e||(null==i?void 0:i._isBike)?r||(r=i):"WALK"===e||(null==i?void 0:i._isWalk)?s||(s=i):o.push(i)}o.length<t&&o.length>0&&console.log(`‚ö†Ô∏è V120: Seulement ${o.length} trajet(s) bus trouv√©(s) (minimum souhait√©: ${t})`);const n=[...o];r&&n.push(r),s&&n.push(s);const a=e.length-n.length;return a>0&&console.log(`üö¥ V64: ${a} trajet(s) v√©lo/pi√©ton en double supprim√©(s)`),console.log(`üìä V120: ${o.length} bus, ${r?1:0} v√©lo, ${s?1:0} marche`),n}function Ge(e){if(!Array.isArray(e)||!e.length)return e;console.log(`üéØ rankDepartureItineraries: ${e.length} itin√©raires √† trier`),console.log("üìã Avant tri (heures de d√©part):",e.map(e=>e.departureTime).join(", "));const t=e.map(e=>{const t=(Array.isArray(e.steps)?e.steps:[]).filter(e=>"BUS"===e.type),o=Math.max(0,t.length-1),r=Re(e.departureTime);let s=0;const n=(e.duration||"").match(/(\d+)/);return n&&(s=parseInt(n[1],10)),{it:e,depMinutes:r,depTime:e.departureTime,transfers:o,durationMin:s}});return t.sort((e,t)=>e.depMinutes!==t.depMinutes?e.depMinutes-t.depMinutes:e.transfers!==t.transfers?e.transfers-t.transfers:e.durationMin-t.durationMin),console.log("üìã Apr√®s tri PARTIR (du plus t√¥t au plus tard):",t.slice(0,8).map(e=>({dep:e.depTime,depMin:e.depMinutes,arr:e.it.arrivalTime,transfers:e.transfers}))),t.map(e=>e.it)}const je=Object.freeze(Object.defineProperty({__proto__:null,deduplicateItineraries:xe,filterExpiredDepartures:Pe,filterLateArrivals:Ne,limitBikeWalkItineraries:Oe,rankArrivalItineraries:Fe,rankDepartureItineraries:Ge},Symbol.toStringTag,{value:"Module"}));function He(e){const{resultsListContainer:t,resultsModeTabs:o,getAllItineraries:r,getArrivalState:s,setArrivalRenderedCount:n,onLoadMoreDepartures:a,onLoadMoreArrivals:i,getDataManager:l,getSearchTime:c}=e;function d(e){return e?e.type?e.type:e.summarySegments&&e.summarySegments.length>0?"BUS":e._isBike?"BIKE":e._isWalk?"WALK":"BUS":"BUS"}function u(e){if(!e||"string"!=typeof e)return 1/0;const t=e.match(/(\d{1,2}):(\d{2})/);return t?60*parseInt(t[1],10)+parseInt(t[2],10):1/0}return{render:function(o){if(!t)return;const n=r(),{lastSearchMode:a,arrivalRankedAll:i,arrivalRenderedCount:l,pageSize:c}=s(),p="arriver"===a;let h;if(t.innerHTML="",h=p?"ALL"===o?[...i]:i.filter(e=>e.type===o):"ALL"===o?[...n]:n.filter(e=>e.type===o),!h.length)return void(t.innerHTML='<p class="results-message">Aucun itin√©raire n\'a √©t√© trouv√©.</p>');const m=h.filter(e=>"BUS"===d(e)),g=h.filter(e=>"BIKE"===d(e)),f=h.filter(e=>"WALK"===d(e));p?m.sort((e,t)=>u(t.arrivalTime)-u(e.arrivalTime)):m.sort((e,t)=>u(e.departureTime)-u(t.departureTime));let v=!1,y=!1,S=!1,w=0;const _=(r,s="")=>{var n,a;const i=d(r),l=document.createElement("div");l.className="route-option-wrapper";let c=s;"ALL"!==o||p||(0!==w||s||(c="Sugg√©r√©","BUS"===i&&(v=!0),"BIKE"===i&&(y=!0),"WALK"===i&&(S=!0)),s||("BUS"!==i||v?"BIKE"!==i||y?"WALK"!==i||S||(c="Itin√©raires Pi√©ton",S=!0):(c="Itin√©raires V√©lo",y=!0):(c="Itin√©raires Bus",v=!0))),c&&(l.innerHTML+=`<p class='route-option-title'>${c}</p>`);const u=document.createElement("div");u.className="route-option";let h="";if("BIKE"===i)h=`<div class='route-summary-bus-icon route-summary-bike-icon'>${Le.BICYCLE}</div><span class='route-type-label'>Trajet √† v√©lo</span><span class='route-type-distance'>${(null==(n=r.steps[0])?void 0:n.distance)||""}</span>`;else if("WALK"===i)h=`<div class='route-summary-bus-icon route-summary-walk-only-icon'>${Le.WALK}</div><span class='route-type-label'>Trajet √† pied</span><span class='route-type-distance'>${(null==(a=r.steps[0])?void 0:a.distance)||""}</span>`;else{const e=r.summarySegments||[],t=function(e){if(!(null==e?void 0:e.steps))return!1;for(const t of e.steps)if("WALK"===t.type||t._isWalk){const e=(t.duration||"").match(/(\d+)/);if((e?parseInt(e[1],10):0)>2)return!0;const o=(t.distance||"").match(/(\d+)/);if((o?parseInt(o[1],10):0)>100)return!0}return!1}(r);e.forEach((t,o)=>{const r=t.name||"Route";h+=`<div class='route-line-badge' style='background-color:${t.color};color:${t.textColor};'>${r}</div>`,o<e.length-1&&(h+="<span class='route-summary-dot'>‚Ä¢</span>")}),t&&(h+="<span class='route-summary-dot'>‚Ä¢</span>",h+=`<div class='route-summary-walk-icon'>${Le.WALK}</div>`)}const m=0===w&&"ALL"===o&&"BUS"===i?`<span class='route-duration-eco'>${Le.LEAF_ICON} ${r.duration}</span>`:`<span>${r.duration}</span>`,g="~"===r.departureTime?"<span class='route-time' style='color:var(--text-secondary);font-weight:500;'>(Trajet)</span>":`<span class='route-time'>${r.departureTime} &gt; ${r.arrivalTime}</span>`;u.innerHTML=`\n        <div class='route-summary-line'>${h}</div>\n        <div class='route-footer'>${g}<span class='route-duration'>${m}</span></div>\n      `,u.addEventListener("click",()=>e.onSelectItinerary(r,u)),l.appendChild(u);const f=document.createElement("div");f.className="route-details hidden",l.appendChild(f),t.appendChild(l),w++};m.forEach(e=>_(e)),g.forEach(e=>_(e)),f.forEach(e=>_(e));const T=document.createElement("button");T.className="btn btn-secondary btn-load-more",T.innerHTML='\n      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>\n      G√©n√©rer + de trajets\n    ',T.addEventListener("click",()=>{T.disabled=!0,T.innerHTML='<span class="spinner-small"></span> Recherche...',p&&"function"==typeof e.onLoadMoreArrivals?e.onLoadMoreArrivals().finally(()=>{T.disabled=!1,T.innerHTML='\n            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>\n            G√©n√©rer + de trajets\n          '}):"function"==typeof e.onLoadMoreDepartures&&e.onLoadMoreDepartures().finally(()=>{T.disabled=!1,T.innerHTML='\n            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>\n            G√©n√©rer + de trajets\n          '})}),t.appendChild(T)},showSkeleton:function(e=3){if(!t)return;let o="";for(let t=0;t<e;t++)o+='\n        <div class="route-option-wrapper skeleton-wrapper">\n          <div class="route-option skeleton-route">\n            <div class="route-option-left">\n              <div class="skeleton skeleton-badge" style="width: 50px; height: 24px;"></div>\n            </div>\n            <div class="route-option-center">\n              <div class="skeleton skeleton-line" style="width: 80%; height: 14px; margin-bottom: 8px;"></div>\n              <div class="skeleton skeleton-line" style="width: 60%; height: 12px;"></div>\n            </div>\n            <div class="route-option-right">\n              <div class="skeleton skeleton-badge" style="width: 45px; height: 20px;"></div>\n            </div>\n          </div>\n        </div>\n      ';t.innerHTML=o}}}let Ue,ze,qe,Ke,We,Ve,Je,Ye,Xe=new Set,Ze=null,Qe=null,et=null,tt=null;let ot={},rt=null,st=null,nt=null,at=null,it=[],lt=null,ct=[],dt=0,ut=6,pt=null,ht=0,mt=null;const gt=[.2,.5,.8],ft=z(),vt=ft.googleApiKey;ut=ft.arrivalPageSize;let yt=0,St=null,wt=!1;const _t={boarding:4,alighting:4,transfer:3,intermediate:1};function Tt(e){if("undefined"==typeof L||!L.divIcon)return null;const t={boarding:22,alighting:22,transfer:16,intermediate:12}[e]||12;return L.divIcon({className:`itinerary-stop-marker ${e}`,html:"<span></span>",iconSize:[t,t],iconAnchor:[t/2,t/2]})}const bt=e=>{if(!e||"BUS"!==e.type)return!1;const t=!ne(e.routeShortName),o=ce(e.departureStop,e.departureTime),r=ce(e.arrivalStop,e.arrivalTime);if(o||r)return!1;if(!t)return!0;return!Array.isArray(e.intermediateStops)||0===e.intermediateStops.length};function Lt(e,t){if(!e||!t)return;if(Ro()){document.querySelectorAll(".route-option").forEach(e=>e.classList.remove("is-active")),t.classList.add("is-active");const o=function(e){var t,o,r;if(!uo||!Ve)return;console.log("renderItineraryDetail: start",{itineraryId:e.tripId||(null==(t=e.trip)?void 0:t.trip_id)||e.id||null,stepCount:(null==(o=e.steps)?void 0:o.length)||0});let s="";if(s=e.steps.map((e,t)=>{const o="BUS"===e.type?e.routeColor||"var(--border)":"var(--text-secondary)";if("WALK"===e.type||"BIKE"===e.type){const t=e.subSteps&&e.subSteps.length>0,r="BIKE"===e.type?Le.BICYCLE:Le.WALK,s="BIKE"===e.type?"bicycle":"walk",n=(e.subSteps||[]).filter(e=>{const t=e.distance.match(/(\d+)\s*m/);return!("STRAIGHT"===e.maneuver&&t&&parseInt(t[1])<100)});return`\n                <div class="step-detail ${s}" style="--line-color: ${o};">\n                    <div class="step-icon">\n                        ${r}\n                    </div>\n                    <div class="step-info">\n                        <span class="step-instruction">${e.instruction} <span class="step-duration-inline">(${e.duration})</span></span>\n                        \n                        ${t?`\n                        <details class="intermediate-stops">\n                            <summary>\n                                <span>Voir les √©tapes</span>\n                                <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>\n                            </summary>\n                            <ul class="intermediate-stops-list walk-steps">\n                                ${n.map(e=>`\n                                    <li>\n                                        ${Ee(e.maneuver)}\n                                        <div class="walk-step-info">\n                                            <span>${e.instruction}</span>\n                                            <span class="walk-step-meta">${e.distance} ${e.duration?`(${e.duration})`:""}</span>\n                                        </div>\n                                    </li>\n                                `).join("")}\n                            </ul>\n                        </details>\n                        `:`<span class="step-sub-instruction">${e.instruction}</span>`}\n                    </div>\n                </div>\n            `}if(_e(e))return"";if(bt(e))return"";{const t=e.intermediateStops&&e.intermediateStops.length>0,r=t?e.intermediateStops.length:e.numStops>1?e.numStops-1:0;let s="Direct";r>1?s=`${r} arr√™ts`:1===r&&(s="1 arr√™t");const n=le(e.routeShortName),a=e.routeColor||"var(--primary)",i=e.routeTextColor||"#ffffff",l=ae(e.departureStop),c=ae(e.arrivalStop),d=ie(e.departureTime),u=ie(e.arrivalTime),p=(null==c?void 0:c.toLowerCase().includes("terminus"))||(null==c?void 0:c.toLowerCase().includes("gare")),h=p?"Arriv√©e au terminus":"Descente √†";return`\n                <div class="step-detail bus" style="--line-color: ${o};">\n                    <div class="step-icon">\n                        <div class="route-line-badge" style="background-color: ${a}; color: ${i};">${n}</div>\n                    </div>\n                    <div class="step-info">\n                        <span class="step-instruction">${e.instruction} <span class="step-duration-inline">(${e.duration})</span></span>\n                        \n                        <div class="step-stop-point stop-context">\n                            <span class="stop-label">Mont√©e</span>\n                            <span class="step-time"><strong>${l}</strong></span>\n                            <span class="step-time-detail">(${d})</span>\n                        </div>\n                        \n                        ${r>0?`\n                        <details class="intermediate-stops">\n                            <summary>\n                                <span>${s}</span>\n                                <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>\n                            </summary>\n                            ${t?`\n                            <ul class="intermediate-stops-list" style="--line-color: ${o};">\n                                ${e.intermediateStops.map(e=>`<li>${"string"==typeof e?e:(null==e?void 0:e.name)||(null==e?void 0:e.stop_name)||"Arr√™t"}</li>`).join("")}\n                            </ul>\n                            `:`<ul class="intermediate-stops-list" style="--line-color: ${o};"><li>(La liste d√©taill√©e des arr√™ts n'est pas disponible)</li></ul>`}\n                        </details>\n                        `:""}\n                        \n                        <div class="step-stop-point stop-context ${p?"is-terminus":""}">\n                            <span class="stop-label">${h}</span>\n                            <span class="step-time"><strong>${c}</strong></span>\n                            ${p?"":`<span class="step-time-detail">(${u})</span>`}\n                        </div>\n                    </div>\n                </div>\n            `}}).join(""),uo.innerHTML=s,hr(),io){const t="~"===e.departureTime?'<span class="route-time" style="color: var(--text-secondary); font-weight: 500;">(Trajet)</span>':`<span class="route-time">${e.departureTime} &gt; ${e.arrivalTime}</span>`;io.innerHTML=`\n            ${t}\n            <span class="route-duration">${e.duration}</span>\n        `}if(Ve.map&&e.steps){rt&&(Ve.map.removeLayer(rt),rt=null),nt&&nt.clearLayers();const t=[];e.steps.forEach(e=>{const o=rr(e),r=be(e);r.length?r.forEach(r=>{const s=Te(r);if(!s||!s.length)return void console.warn("renderItineraryDetail: √©tape sans coordonn√©es",{stepType:e.type,step:e});const n={type:"LineString",coordinates:s.map(([e,t])=>[t,e])};console.log("renderItineraryDetail: couche ajout√©e",{stepType:e.type,pointCount:s.length});const a=L.geoJSON(n,{style:o});t.push(a)}):_e(e)||console.warn("renderItineraryDetail: √©tape sans polylines",{stepType:e.type,step:e})}),t.length>0?(rt=L.featureGroup(t).addTo(Ve.map),sr(e,Ve.map,nt)):console.warn("renderItineraryDetail: aucune couche trac√©e (liste vide)",{itineraryId:e.tripId||(null==(r=e.trip)?void 0:r.trip_id)||e.id||null})}return rt}(e);return void function(e){if(!no)return;document.body.classList.add("detail-view-open"),zo(),Oo(),yt=0,lo&&(lo.classList.remove("sheet-level-0","sheet-level-1","sheet-level-2"),lo.classList.add("sheet-level-0"),lo.classList.remove("is-expanded"),lo.style.removeProperty("transform"));no.classList.remove("hidden"),no.classList.remove("is-scrolled"),hr(),so&&(so.classList.remove("hidden"),requestAnimationFrame(()=>so.classList.add("is-active")));Ve&&Ve.map&&Ve.map.invalidateSize();no.classList.add("is-active"),requestAnimationFrame(()=>{if(e&&Ve.map)try{const t=e.getBounds();t.isValid()&&Ve.map.fitBounds(t,{padding:[20,20]})}catch(t){console.error("Erreur lors du fitBounds sur la carte d√©tail:",t)}else Ve.map&&(console.warn("showItineraryDetailView: pas de routeLayer, centrage sur P√©rigueux"),Ve.map.setView([45.1845,.7211],13))})}(o)}const o=t.closest(".route-option-wrapper");if(!o)return;const r=o.querySelector(".route-details");if(!r)return;const s=!r.classList.contains("hidden");document.querySelectorAll(".route-option-wrapper .route-details").forEach(e=>{e!==r&&e.classList.add("hidden")}),document.querySelectorAll(".route-option-wrapper .route-option").forEach(e=>{e!==t&&e.classList.remove("is-active")}),s?(r.classList.add("hidden"),t.classList.remove("is-active")):(r.innerHTML.trim()||(r.innerHTML=function(e){const t=e.steps.map((e,t)=>{if("WALK"===e.type||"BIKE"===e.type){const t=e.subSteps&&e.subSteps.length>0,o="BIKE"===e.type?Le.BICYCLE:Le.WALK,r="BIKE"===e.type?"bicycle":"walk",s=(e.subSteps||[]).filter(e=>{const t=e.distance.match(/(\d+)\s*m/);return!("STRAIGHT"===e.maneuver&&t&&parseInt(t[1])<100)});return`\n                <div class="step-detail ${r}" style="--line-color: var(--text-secondary);">\n                    <div class="step-icon">\n                        ${o}\n                    </div>\n                    <div class="step-info">\n                        <span class="step-instruction">${e.instruction} <span class="step-duration-inline">(${e.duration})</span></span>\n                        \n                        ${t?`\n                        <details class="intermediate-stops">\n                            <summary>\n                                <span>Voir les √©tapes</span>\n                                <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>\n                            </summary>\n                            <ul class="intermediate-stops-list walk-steps">\n                                ${s.map(e=>`\n                                    <li>\n                                        ${Ee(e.maneuver)}\n                                        <div class="walk-step-info">\n                                            <span>${e.instruction}</span>\n                                            <span class="walk-step-meta">${e.distance} (${e.duration})</span>\n                                        </div>\n                                    </li>\n                                `).join("")}\n                            </ul>\n                        </details>\n                        `:`<span class="step-sub-instruction">${e.instruction}</span>`}\n                    </div>\n                </div>\n            `}if(_e(e))return"";if(bt(e))return"";{const t=e.intermediateStops&&e.intermediateStops.length>0,o=t?e.intermediateStops.length:e.numStops>1?e.numStops-1:0;let r="Direct";o>1?r=`${o} arr√™ts`:1===o&&(r="1 arr√™t");const s=e.routeColor||"var(--border)",n=le(e.routeShortName),a=e.routeColor||"var(--primary)",i=e.routeTextColor||"#ffffff",l=ae(e.departureStop),c=ae(e.arrivalStop),d=ie(e.departureTime),u=ie(e.arrivalTime),p=(null==c?void 0:c.toLowerCase().includes("terminus"))||(null==c?void 0:c.toLowerCase().includes("gare")),h=p?"Arriv√©e au terminus":"Descente √†";return`\n                <div class="step-detail bus" style="--line-color: ${s};">\n                    <div class="step-icon">\n                        <div class="route-line-badge" style="background-color: ${a}; color: ${i};">${n}</div>\n                    </div>\n                    <div class="step-info">\n                        <span class="step-instruction">${e.instruction} <span class="step-duration-inline">(${e.duration})</span></span>\n                        \n                        <div class="step-stop-point stop-context">\n                            <span class="stop-label">Mont√©e</span>\n                            <span class="step-time"><strong>${l}</strong></span>\n                            <span class="step-time-detail">(${d})</span>\n                        </div>\n                        \n                        ${o>0?`\n                        <details class="intermediate-stops">\n                            <summary>\n                                <span>${r}</span>\n                                <svg class="chevron" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>\n                            </summary>\n                            ${t?`\n                            <ul class="intermediate-stops-list" style="--line-color: ${s};">\n                                ${e.intermediateStops.map(e=>`<li>${"string"==typeof e?e:(null==e?void 0:e.name)||(null==e?void 0:e.stop_name)||"Arr√™t"}</li>`).join("")}\n                            </ul>\n                            `:`<ul class="intermediate-stops-list" style="--line-color: ${s};"><li>(La liste d√©taill√©e des arr√™ts n'est pas disponible)</li></ul>`}\n                        </details>\n                        `:""}\n                        \n                        <div class="step-stop-point stop-context ${p?"is-terminus":""}">\n                            <span class="stop-label">${h}</span>\n                            <span class="step-time"><strong>${c}</strong></span>\n                            ${p?"":`<span class="step-time-detail">(${u})</span>`}\n                        </div>\n                    </div>\n                </div>\n            `}}).join("");return t}(e)),r.classList.remove("hidden"),t.classList.add("is-active"),Je&&Je.map&&(Je.map.invalidateSize(),setTimeout(()=>ar(e),50)),setTimeout(()=>{o.scrollIntoView({behavior:"smooth",block:"nearest"})},100))}function It(){Array.from(document.querySelectorAll("[data-theme-toggle]")).forEach(e=>{e.addEventListener("click",()=>{var e,t;const o=localStorage.getItem("ui-theme");let r,s;var n;document.body.classList.contains("dark-theme"),r="light"===o?"dark":"dark"===o?"auto":"light",s="auto"===r?(null==(t=null==(e=window.matchMedia)?void 0:e.call(window,"(prefers-color-scheme: dark)"))?void 0:t.matches)??!1:"dark"===r,n=s,et&&et.applyThemeState(n,[We,Ve,Je]);try{localStorage.setItem("ui-theme",r);const e="auto"===r?"automatique üåì":"dark"===r?"sombre üåô":"clair ‚òÄÔ∏è";console.log(`üé® Th√®me: ${e}`)}catch(a){}},{passive:!0})})}let Et,Mt,At,Ct,$t,kt,Bt,xt,Dt,Rt,Pt,Nt,Ft,Ot,Gt,jt,Ht,Ut,zt,qt,Kt,Wt,Vt,Jt,Yt,Xt,Zt,Qt,eo,to,oo,ro,so,no,ao,io,lo,co,uo,po,ho,mo,go,fo,vo,yo,So,wo,_o,To,bo,Lo,Io,Eo;et=new Q({icons:Le,geolocationManager:null});let Mo=null,Ao=null;function Co(){Et=document.getElementById("dashboard-container"),Mt=document.getElementById("dashboard-hall"),At=document.getElementById("dashboard-content-view"),Ct=document.getElementById("btn-back-to-hall"),$t=document.getElementById("info-trafic-list"),document.getElementById("info-trafic-avenir"),kt=document.getElementById("info-trafic-count"),Bt=document.getElementById("alert-banner"),xt=document.getElementById("alert-banner-content"),Dt=document.getElementById("alert-banner-close"),Rt=document.getElementById("fiche-horaire-container"),Pt=document.getElementById("horaires-search-bar"),Nt=document.getElementById("horaires-search-results"),Ft=document.getElementById("map-container"),Ot=document.getElementById("btn-show-map"),Gt=document.getElementById("btn-back-to-dashboard-from-map"),jt=document.getElementById("itinerary-results-container"),Ht=document.getElementById("btn-back-to-dashboard-from-results"),Ut=document.querySelector("#itinerary-results-container .results-list"),document.getElementById("results-map"),zt=document.getElementById("results-mode-tabs"),qt=document.getElementById("results-planner-from"),Kt=document.getElementById("results-planner-to"),Wt=document.getElementById("results-from-suggestions"),Vt=document.getElementById("results-to-suggestions"),Jt=document.getElementById("results-btn-swap-direction"),Yt=document.getElementById("results-planner-when-btn"),Xt=document.getElementById("results-planner-options-popover"),Zt=document.getElementById("results-popover-date"),Qt=document.getElementById("results-popover-hour"),eo=document.getElementById("results-popover-minute"),to=document.getElementById("results-popover-submit-btn"),oo=document.getElementById("results-planner-submit-btn"),ro=document.getElementById("results-geolocate-btn"),so=document.getElementById("itinerary-detail-backdrop"),no=document.getElementById("itinerary-detail-container"),lo=document.getElementById("detail-bottom-sheet"),ao=document.getElementById("btn-back-to-results"),document.getElementById("detail-map-header"),io=document.getElementById("detail-map-summary"),co=document.getElementById("detail-panel-wrapper"),uo=document.getElementById("detail-panel-content"),po=document.getElementById("planner-submit-btn"),ho=document.getElementById("hall-planner-from"),mo=document.getElementById("hall-planner-to"),go=document.getElementById("from-suggestions"),fo=document.getElementById("to-suggestions"),bo=document.getElementById("hall-btn-swap-direction"),vo=document.getElementById("planner-when-btn"),yo=document.getElementById("planner-options-popover"),So=document.getElementById("popover-date"),wo=document.getElementById("popover-hour"),_o=document.getElementById("popover-minute"),To=document.getElementById("popover-submit-btn"),Lo=document.getElementById("hall-geolocate-btn"),Io=document.getElementById("install-tip"),Eo=document.getElementById("install-tip-close")}async function $o(){Co(),tt=He({resultsListContainer:Ut,resultsModeTabs:zt,getAllItineraries:()=>it,getArrivalState:()=>({lastSearchMode:lt,arrivalRankedAll:ct,arrivalRenderedCount:dt,pageSize:ut}),setArrivalRenderedCount:e=>{dt=e},onSelectItinerary:(e,t)=>Lt(e,t),onLoadMoreDepartures:()=>async function(){if(!pt||!Mo||!Ao)return void console.warn("loadMoreDepartures: pas de recherche pr√©c√©dente");const e=new Set,t=new Set;it.forEach(o=>{const r=Yo(o);e.add(r),o.departureTime&&"~"!==o.departureTime&&t.add(o.departureTime)});const o=it.filter(e=>"BUS"===e.type||"TRANSIT"===e.type);let r;r=pt.date&&"today"!==pt.date&&"Aujourd'hui"!==pt.date?new Date(pt.date):new Date;if(o.length>0){const e=o[o.length-1].departureTime,t=null==e?void 0:e.match(/(\d{1,2}):(\d{2})/);if(t){const e=parseInt(t[1],10),o=parseInt(t[2],10);r.setHours(e,o+1,0,0)}else r.setHours(parseInt(pt.hour),parseInt(pt.minute)+30,0,0)}else ht+=30,r.setHours(parseInt(pt.hour),parseInt(pt.minute)+ht,0,0);const s=r.getFullYear(),n=String(r.getMonth()+1).padStart(2,"0"),a=String(r.getDate()).padStart(2,"0"),i=`${s}-${n}-${a}`,l={...pt,date:i,hour:String(r.getHours()).padStart(2,"0"),minute:String(r.getMinutes()).padStart(2,"0")};console.log(`üîÑ Chargement + de d√©parts √† partir de ${l.date} ${l.hour}:${l.minute}`),console.log(`üì¶ Cache: ${e.size} signatures, ${t.size} heures de d√©part`);try{let o=er(await Ye.fetchItinerary(Mo,Ao,l),l);const r=o.length;if(o=o.filter(t=>{if("BIKE"===t.type||"WALK"===t.type||t._isBike||t._isWalk)return!1;const o=Yo(t);return!e.has(o)}),console.log(`üîç Filtrage: ${r} ‚Üí ${o.length} (${r-o.length} doublons/v√©lo/pi√©ton exclus)`),0===o.length){console.log("Aucun nouveau d√©part trouv√©");const e=document.querySelector(".load-more-departures button");return void(e&&(e.innerHTML="Plus de d√©parts disponibles",e.disabled=!0))}console.log(`‚úÖ ${o.length} nouveaux d√©parts bus ajout√©s`),o.forEach(o=>{const r=Yo(o);e.add(r),o.departureTime&&t.add(o.departureTime)}),it=Zo([...it,...o]),or(it),tt&&tt.render("ALL");const s=document.querySelector(".load-more-departures button");s&&(s.innerHTML='\n                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>\n                Charger + de d√©parts\n            ',s.disabled=!1)}catch(c){console.error("Erreur chargement + de d√©parts:",c);const e=document.querySelector(".load-more-departures button");e&&(e.innerHTML="Erreur - R√©essayer",e.disabled=!1)}}(),onLoadMoreArrivals:()=>async function(){if(!pt||!Mo||!Ao||"arriver"!==pt.type)return void console.warn("loadMoreArrivals: pas de recherche arriver pr√©c√©dente");const e=new Set,t=new Set;let o;it.forEach(o=>{const r=Yo(o);e.add(r),o.arrivalTime&&"~"!==o.arrivalTime&&t.add(o.arrivalTime)}),o=pt.date&&"today"!==pt.date&&"Aujourd'hui"!==pt.date?new Date(pt.date):new Date;const r=it.filter(e=>"BUS"===e.type||"TRANSIT"===e.type);if(r.length>0){let e=1/0;if(r.forEach(t=>{var o;const r=null==(o=t.arrivalTime)?void 0:o.match(/(\d{1,2}):(\d{2})/);if(r){const t=60*parseInt(r[1])+parseInt(r[2]);t<e&&(e=t)}}),e!==1/0){const t=Math.floor(e/60),r=e%60;o.setHours(t,r-30,0,0)}else o.setHours(parseInt(pt.hour)-1,parseInt(pt.minute),0,0)}else o.setHours(parseInt(pt.hour)-1,parseInt(pt.minute),0,0);const n=o.getFullYear(),a=String(o.getMonth()+1).padStart(2,"0"),i=String(o.getDate()).padStart(2,"0"),l=`${n}-${a}-${i}`,c={...pt,date:l,hour:String(o.getHours()).padStart(2,"0"),minute:String(o.getMinutes()).padStart(2,"0")};console.log(`üîÑ Chargement + d'arriv√©es (cible ${c.date} ${c.hour}:${c.minute})`),console.log(`üì¶ Cache: ${e.size} signatures, ${t.size} heures d'arriv√©e`);try{let o=er(await Ye.fetchItinerary(Mo,Ao,c),c);const r=o.length;if(o=o.filter(t=>{if("BIKE"===t.type||"WALK"===t.type||t._isBike||t._isWalk)return!1;const o=Yo(t);return!e.has(o)}),console.log(`üîç Filtrage: ${r} ‚Üí ${o.length} nouveaux trajets`),0===o.length){console.log("Aucun nouveau trajet arriv√©e trouv√©");const e=document.querySelector(".load-more-arrivals button");return void(e&&(e.innerHTML="Plus de trajets disponibles",e.disabled=!0))}console.log(`‚úÖ ${o.length} nouveaux trajets arriv√©e ajout√©s`),o.forEach(o=>{const r=Yo(o);e.add(r),o.arrivalTime&&t.add(o.arrivalTime)}),it=[...it,...o];const{rankArrivalItineraries:n}=await s(async()=>{const{rankArrivalItineraries:e}=await Promise.resolve().then(()=>je);return{rankArrivalItineraries:e}},void 0);ct=n([...it],pt),dt=ct.length,or(it),tt&&tt.render("ALL");const a=document.querySelector(".load-more-arrivals button");a&&(a.innerHTML='\n                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>\n                G√©n√©rer + de trajets\n            ',a.disabled=!1)}catch(d){console.error("Erreur chargement + d'arriv√©es:",d);const e=document.querySelector(".load-more-arrivals button");e&&(e.innerHTML="Erreur - R√©essayer",e.disabled=!1)}}(),getDataManager:()=>Ue,getSearchTime:()=>pt}),Ye=new q(vt),Ue=new m,Ze=V({dataManager:Ue,apiManager:Ye,icons:Le}),mt=te({apiManager:Ye,icons:Le,onUserLocationUpdate:e=>{We&&We.updateUserLocation(e),Je&&Je.updateUserLocation(e),Ve&&Ve.updateUserLocation(e)},onUserLocationError:()=>{We&&We.onLocateError(),Je&&Je.onLocateError(),Ve&&Ve.onLocateError()}}),et=new Q({icons:Le,geolocationManager:mt}),qo(),mt&&mt.startWatching({hallButton:Lo,resultsButton:ro}),yr("Chargement des donn√©es...","loading");try{await Ue.loadAllData(e=>yr(e,"loading")),ze=new g,x.init(Ue.stops),We=new P("map",Ue,ze),We.initializeMap();const t=(null==mt?void 0:mt.handleGeolocationSuccess)||(()=>{}),o=(null==mt?void 0:mt.handleGeolocationError)||(()=>{});We.addLocateControl(t,o),window.mapRenderer=We,window.dataManager=Ue,window.addDelayedBusMarker=e=>{We&&"function"==typeof We.addDelayedBusMarker&&We.addDelayedBusMarker(e)},Ve=new P("detail-map",Ue,ze),Ve.initializeMap(!1),nt=L.layerGroup().addTo(Ve.map),Ve.addLocateControl(t,o),Je=new P("results-map",Ue,ze),Je.initializeMap(!1),at=L.layerGroup().addTo(Je.map),Je.addLocateControl(t,o),It(),et&&et.initTheme([We,Ve,Je]),y.init(Ue,x),qe=new f(Ue,y),Ke=new v(Ue,x),window.delayManager=y,window.analyticsManager=A;const r=new S;r.init(),window.dataExporterUI=r,window.DataExporter=w,function(){const e=document.getElementById("route-checkboxes");if(!e||!Ue)return;e.innerHTML="",Xe.clear();const t={};Object.keys(C).forEach(e=>{t[e]=[]}),t.autres=[],Ue.routes.forEach(e=>{Xe.add(e.route_id);const o=B(e.route_short_name);t[o].push(e)}),Object.values(t).forEach(e=>{e.sort((e,t)=>e.route_short_name.localeCompare(t.route_short_name,void 0,{numeric:!0}))}),Object.entries(C).forEach(([o,r])=>{const s=t[o];if(0===s.length)return;const n=document.createElement("div");n.className="category-header",n.innerHTML=`\n            <div class="category-title">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="${r.color}"><circle cx="12" cy="12" r="10"/></svg>\n                <strong>${r.name}</strong>\n                <span class="category-count">(${s.length})</span>\n            </div>\n            <div class="category-actions">\n                <button class="btn-category-action" data-category="${o}" data-action="select">Tous</button>\n                <button class="btn-category-action" data-category="${o}" data-action="deselect">Aucun</button>\n            </div>`,e.appendChild(n);const a=document.createElement("div");a.className="category-routes",a.id=`category-${o}`,s.forEach(e=>{const t=document.createElement("div");t.className="route-checkbox-item";const r=e.route_color?e.route_color:"3388ff",s=e.route_text_color?e.route_text_color:"ffffff";t.innerHTML=`\n                <input type="checkbox" id="route-${e.route_id}" data-category="${o}" checked>\n                <div class="route-badge" style="background-color: #${r}; color: #${s};">\n                    ${e.route_short_name||e.route_id}\n                </div>\n                <span class="route-name">${e.route_long_name||e.route_short_name||e.route_id}</span>\n            `,t.querySelector('input[type="checkbox"]').addEventListener("change",gr),t.addEventListener("mouseenter",()=>We.highlightRoute(e.route_id,!0)),t.addEventListener("mouseleave",()=>We.highlightRoute(e.route_id,!1)),t.addEventListener("click",t=>{"checkbox"!==t.target.type&&We.zoomToRoute(e.route_id)}),a.appendChild(t)}),e.appendChild(a)}),document.querySelectorAll(".btn-category-action").forEach(e=>{e.addEventListener("click",e=>{!function(e,t){const o=document.querySelectorAll(`input[data-category="${e}"]`);o.forEach(e=>{e.checked="select"===t}),gr()}(e.target.dataset.category,e.target.dataset.action)})})}();try{const e="undefined"!=typeof window?`${window.location.origin}/api/geocode`:"/api/geocode";Qe=new Z({dataManager:Ue,icons:Le,googleApiKey:vt,geocodeProxyUrl:e}),console.log("üîß Router GTFS local activ√©")}catch(e){console.warn("Router worker indisponible, fallback main thread.",e),Qe=null}try{await Ue.optimizeStopTimesStorage()}catch(e){console.warn("Impossible d‚Äôoptimiser le stockage des stop_times:",e)}let s=Ue.geoJson;!s&&Ue.hasShapeData()&&(console.log("üîÑ map.geojson absent, g√©n√©ration √† partir des shapes GTFS..."),s=Ue.generateGeoJsonFromShapes(),Ue.geoJson=s),s?We.displayMultiColorRoutes(s,Ue,Xe):console.warn("‚ö†Ô∏è Aucun trac√© disponible (ni map.geojson ni shapes.txt)"),We.displayStops(),Ue.routes.forEach(e=>{ot[e.route_id]={status:"normal",message:""}}),async function(){try{const e=await fetch("/data/line-status.json?t="+Date.now());if(!e.ok)return void console.warn("[LineStatus] Fichier line-status.json non trouv√©, utilisation des statuts par d√©faut");const t=await e.json();if(console.log("[LineStatus] Chargement des statuts:",t.lastUpdate),t.lines)for(const[o,r]of Object.entries(t.lines)){const e=Ue.routes.find(e=>e.route_short_name===o);e&&"normal"!==r.status&&(ot[e.route_id]={status:r.status,message:r.message||""},console.log(`[LineStatus] Ligne ${o}: ${r.status} - ${r.message}`))}t.globalMessage&&console.log("[LineStatus] Message global:",t.globalMessage)}catch(e){console.warn("[LineStatus] Erreur chargement statuts:",e)}}().then(()=>{Ue&&$t&&Ce(Ue,ot,$t,kt),ir(),ke(Ue,ot)}),function(){if(!Ue||!Rt)return;Rt.innerHTML="";const e={"Lignes A, B, C et D":[],"Lignes e":[],"Lignes K":[],"Lignes N":[],"Lignes R":[]};Ue.routes.forEach(t=>{const o=t.route_short_name;["A","B","C","D"].includes(o)?e["Lignes A, B, C et D"].push(t):o.startsWith("e")?e["Lignes e"].push(t):o.startsWith("K")?e["Lignes K"].push(t):o.startsWith("N")?e["Lignes N"].push(t):o.startsWith("R")&&e["Lignes R"].push(t)});for(const[o,r]of Object.entries(e)){if(0===r.length)continue;const e=document.createElement("div");e.className="accordion-group";let t="";"Lignes R"===o?t='\n                <a href="/data/fichehoraire/grandperigueux_fiche_horaires_ligne_R1_R2_R3_sept_2025.pdf" target="_blank" rel="noopener noreferrer">Lignes R1, R2, R3 La Feuilleraie <> ESAT / Les Gourdoux <> Tr√©lissac Les Garennes / Les Pinots <> P+R Aquacap</a>\n                <a href="/data/fichehoraire/grandperigueux_fiche_horaires_ligne_R4_R5_sept_2025.pdf" target="_blank" rel="noopener noreferrer">Lignes R4, R5 Route de Payench√© <> Coll√®ge Jean Moulin / Les Mondines / Cl√©ment Laval <> Coll√®ge Jean Moulin</a>\n                <a href="/data/fichehoraire/grandperigueux_fiche_horaires_ligne_R6_R7_sept_2025.pdf" target="_blank" rel="noopener noreferrer">Lignes R6, R7 Maison des Compagnons <> Gour de l‚ÄôArche poste / Le Charpe <> Gour de l‚ÄôArche poste</a>\n                <a href="/data/fichehoraire/grandperigueux_fiche_horaires_ligne_R8_R9_sept_2025.pdf" target="_blank" rel="noopener noreferrer">Lignes R8, R9 Jaunour <> Boulazac centre commercial / St√®le de Lesparat <> Place du 8 mai</a>\n                <a href="/data/fichehoraire/grandperigueux_fiche_horaires_ligne_R10_R11_sept_2025.pdf" target="_blank" rel="noopener noreferrer">Lignes R10, R11 Notre Dame de Sanilhac poste <> Centre de la communication / H√©liodore <> Place du 8 mai</a>\n                <a href="/data/fichehoraire/grandperigueux_fiche_horaires_ligne_R12_sept_2025.pdf" target="_blank" rel="noopener noreferrer">Ligne R12 Le Change <> Boulazac centre commercial</a>\n                <a href="/data/fichehoraire/grandperigueux_fiche_horaires_ligne_R13_R14_sept_2025.pdf" target="_blank" rel="noopener noreferrer">Lignes R13, R14 Coursac <> Razac sur l‚ÄôIsle / La Chapelle Gonaguet <>Razac sur l‚ÄôIsle</a>\n                <a href="/data/fichehoraire/grandperigueux_fiche_horaires_ligne_R15_sept_2025.pdf" target="_blank" rel="noopener noreferrer">Ligne R15 Boulazac Isle Manoire <> Halte ferroviaire Niversac</a>\n            ':(r.sort((e,t)=>e.route_short_name.localeCompare(t.route_short_name,void 0,{numeric:!0})),r.forEach(e=>{let o=$[e.route_short_name],r=o?`/data/fichehoraire/${o}`:"#";o||console.warn(`PDF non mapp√© pour ${e.route_short_name}.`);const s=k[e.route_short_name]||(e.route_long_name?e.route_long_name.replace(/<->/g,"<=>"):""),n=`Ligne ${e.route_short_name} ${s}`.trim();t+=`<a href="${r}" target="_blank" rel="noopener noreferrer">${n}</a>`})),t&&(e.innerHTML=`\n                <details>\n                    <summary>${o}</summary>\n                    <div class="accordion-content">\n                        <div class="accordion-content-inner">\n                            ${t}\n                        </div>\n                    </div>\n                </details>\n            `,Rt.appendChild(e))}const t=document.querySelectorAll("#fiche-horaire-container details");t.forEach(e=>{e.addEventListener("toggle",e=>{e.target.open&&t.forEach(t=>{t!==e.target&&t.open&&(t.open=!1)})})})}(),function(){ze&&ze.addListener(vr);We&&We.map&&We.map.on("zoomend",()=>{Ue&&We.displayStops()})}(),"true"!==localStorage.getItem("gtfsInstructionsShown")&&document.getElementById("instructions").classList.add("hidden"),yr("Donn√©es charg√©es","loaded"),ze.setMode("real"),ze.play(),console.log("‚è∞ Mode TEMPS R√âEL activ√©."),vr()}catch(e){console.error("Erreur lors de l'initialisation GTFS:",e),yr("GTFS indisponible. Mode d√©grad√© (API seule).","warning")}try{ko()}catch(t){}}function ko(){["btn-back-to-hall","btn-back-to-dashboard-from-map","btn-back-to-dashboard-from-results"].forEach(e=>{const t=Array.from(document.querySelectorAll(`#${e}`));t.length>1&&(console.warn("attachRobustBackHandlers: duplicate id detected",e,t.length),t.forEach((t,o)=>{if(0===o)return;const r=`${e}-dup-${o}`;t.id=r,console.warn("attachRobustBackHandlers: renamed duplicate id",e,"->",r,t)}));const o=document.getElementById(e);if(o){try{o.removeEventListener("click",cr)}catch(r){}o.disabled=!1,o.style.pointerEvents="auto",o.style.zIndex=o.style.zIndex||2e3,o.addEventListener("click",e=>{e.preventDefault(),cr()})}}),document.querySelectorAll(".service-card[data-view]").forEach(e=>{e.style.pointerEvents="auto",e.addEventListener("click",t=>{t.preventDefault();const o=e.dataset.view;o&&mr(o)})});try{const e=25e3,t=Date.now(),o=r=>{try{if(Date.now()-t>e)return void document.removeEventListener("pointerdown",o,!0);const s=r.clientX,n=r.clientY,a=document.elementFromPoint(s,n);r.target&&r.target.id,a&&(a.id||a.className||a.tagName)}catch(s){}};document.addEventListener("pointerdown",o,!0),console.info("Back-button pointer diagnostics active for 25s. Click the problematic area and check console for `pointerdown-debug`.")}catch(e){}}const Bo=()=>Io&&!Io.classList.contains("hidden");function xo(){Io&&(Io.classList.add("hidden"),Io.setAttribute("aria-hidden","true"),Io.removeAttribute("aria-modal"))}function Do(e){"Escape"===e.key&&Bo()&&xo()}function Ro(){return window.innerWidth<=768}const Po=[80,50,10];function No(e,{immediate:t=!1}={}){if(!lo||!Ro())return;const o=Math.max(0,Math.min(gt.length-1,e));yt=o,lo.classList.remove("sheet-level-0","sheet-level-1","sheet-level-2"),t&&lo.classList.add("sheet-height-no-transition"),lo.classList.add(`sheet-level-${o}`),lo.style.removeProperty("transform"),o>=2?lo.classList.add("is-expanded"):(lo.classList.remove("is-expanded"),co&&(co.scrollTop=0)),t&&requestAnimationFrame(()=>null==lo?void 0:lo.classList.remove("sheet-height-no-transition"))}function Fo(){if(lo)return Ro()?void No(yt,{immediate:!0}):(lo.style.removeProperty("transform"),lo.classList.remove("sheet-level-0","sheet-level-1","sheet-level-2"),void Oo())}function Oo(){if(St){if(window.removeEventListener("pointermove",jo),window.removeEventListener("pointerup",Ho),window.removeEventListener("pointercancel",Ho),lo&&void 0!==St.pointerId)try{lo.releasePointerCapture(St.pointerId)}catch(e){}null==lo||lo.classList.remove("is-dragging"),St=null}}function Go(e){if(!Ro()||!lo||!(null==no?void 0:no.classList.contains("is-active")))return;if("mouse"===e.pointerType&&0!==e.button)return;const t=Boolean(e.target.closest(".panel-handle")),o=function(e){if(!lo)return!1;const t=lo.getBoundingClientRect(),o=t.top-20,r=t.top+110;return e.clientY>=o&&e.clientY<=r}(e),r=Boolean(e.target.closest("#detail-panel-wrapper")),s=yt>=2,n=co?co.scrollTop:0;if(s){if(!t&&!o&&!(r&&n<=4))return}else if(!t&&!o&&!r)return;e.preventDefault();const a=Math.max(window.innerHeight,(null==(i=document.documentElement)?void 0:i.clientHeight)||0);var i;const l=Po[yt];St={pointerId:e.pointerId,startY:e.clientY,lastClientY:e.clientY,startTranslateY:l,currentTranslateY:l,lastEventTime:performance.now(),velocity:0,startIndex:yt,hasMoved:!1,isDragging:!1,viewportHeight:a};try{lo.setPointerCapture(e.pointerId)}catch(c){}window.addEventListener("pointermove",jo,{passive:!1}),window.addEventListener("pointerup",Ho),window.addEventListener("pointercancel",Ho)}function jo(e){if(!St||!lo)return;e.preventDefault();const t=St.viewportHeight;if(!t)return;const o=St.startY-e.clientY,r=o/t*100;if(!St.hasMoved&&Math.abs(o)<5)return;St.hasMoved||(St.hasMoved=!0,St.isDragging=!0,lo.classList.add("is-dragging"),lo.classList.remove("sheet-level-0","sheet-level-1","sheet-level-2"),null==no||no.classList.add("sheet-is-dragging"));let s=St.startTranslateY-r;const n=Po[Po.length-1],a=Po[0];s=Math.max(n,Math.min(a,s));const i=performance.now(),l=i-(St.lastEventTime||i);if(l>0){const e=s-St.currentTranslateY;St.velocity=e/l}St.currentTranslateY=s,St.lastClientY=e.clientY,St.lastEventTime=i,lo.style.transform=`translate3d(0, ${s}%, 0)`}function Ho(){if(!St)return;const e=St.isDragging;let t=yt;if(e){const e=St.currentTranslateY,o=St.startIndex,r=St.velocity||0,s=St.startTranslateY-e;t=o;const n=15,a=.3;s>n||r<-a?o<Po.length-1&&(t=o+1):(s<-n||r>a)&&o>0&&(t=o-1)}if(window.removeEventListener("pointermove",jo),window.removeEventListener("pointerup",Ho),window.removeEventListener("pointercancel",Ho),lo&&void 0!==St.pointerId)try{lo.releasePointerCapture(St.pointerId)}catch(o){}e&&lo&&(lo.classList.remove("sheet-level-0","sheet-level-1","sheet-level-2"),lo.classList.add(`sheet-level-${t}`),yt=t,t>=2?lo.classList.add("is-expanded"):(lo.classList.remove("is-expanded"),co&&(co.scrollTop=0)),lo.classList.remove("is-dragging"),lo.style.removeProperty("transform"),null==no||no.classList.remove("sheet-is-dragging")),St=null}function Uo(e){if(!Ro()||!co||!lo)return;if(!(co.scrollTop<=4))return;const t=Math.sign(e.deltaY);t<0&&yt!==gt.length-1?(e.preventDefault(),No(yt+1)):t>0&&0!==yt&&(e.preventDefault(),No(yt-1))}function zo(){!wt&&lo&&no&&(lo.addEventListener("pointerdown",Go,{passive:!1}),window.addEventListener("resize",Fo),wt=!0,function(e=!1){if(lo)Ro()?No(yt,{immediate:e}):(lo.style.removeProperty("transform"),lo.classList.remove("sheet-level-0","sheet-level-1","sheet-level-2"))}(!0))}function qo(){try{Ye.loadGoogleMapsAPI()}catch(l){console.error("Impossible de charger l'API Google:",l)}function e(){const e=window.location.hash.replace("#","");if(e){switch(e){case"itineraire":dr();break;case"horaires":mr("horaires");break;case"trafic":case"info-trafic":mr("info-trafic");break;case"carte":lr();break;case"tarifs":case"tarifs-grille":Wo("tarifs-grille");break;case"tarifs-achat":Wo("tarifs-achat");break;case"tarifs-billettique":Wo("tarifs-billettique");break;case"tarifs-amendes":Wo("tarifs-amendes")}history.replaceState(null,"",window.location.pathname)}}if(et&&et.populateTimeSelects({hall:{dateEl:So,hourEl:wo,minEl:_o},results:{dateEl:Zt,hourEl:Qt,minEl:eo}}),window.addEventListener("hashchange",e),window.location.hash&&setTimeout(e,100),document.querySelectorAll(".service-card[data-view]").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();mr(e.dataset.view)})}),Ot&&Ot.addEventListener("click",lr),Gt&&Gt.addEventListener("click",cr),Ht&&Ht.addEventListener("click",cr),Ct&&Ct.addEventListener("click",cr),ao&&ao.addEventListener("click",ur),so&&so.addEventListener("click",ur),co&&no){let e=0;co.addEventListener("touchstart",t=>{e=t.touches[0].clientY},{passive:!0}),co.addEventListener("touchmove",t=>{if(yt<2)return void(t.cancelable&&t.preventDefault());const o=t.touches[0].clientY,r=co.scrollTop,s=o-e;0===r&&s>0&&no.classList.contains("is-scrolled")&&(t.cancelable&&t.preventDefault(),no.classList.remove("is-scrolled")),s<0&&!no.classList.contains("is-scrolled")&&no.classList.add("is-scrolled")},{passive:!1}),co.addEventListener("wheel",Uo,{passive:!1}),co.addEventListener("scroll",()=>{if(yt<2)return void(co.scrollTop=0);const e=co.scrollTop;e>10&&!no.classList.contains("is-scrolled")?no.classList.add("is-scrolled"):e<=10&&no.classList.contains("is-scrolled")&&no.classList.remove("is-scrolled")})}Dt&&Bt&&Dt.addEventListener("click",()=>Bt.classList.add("hidden")),document.querySelectorAll(".tabs .tab").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".tabs .tab").forEach(e=>e.classList.remove("active")),e.classList.add("active");const t=e.dataset.tab;document.querySelectorAll(".tab-content").forEach(e=>{e.classList.toggle("hidden",e.dataset.content!==t)})})});const t=document.getElementById("close-instructions");t&&t.addEventListener("click",()=>{const e=document.getElementById("instructions");e&&e.classList.add("hidden"),localStorage.setItem("gtfsInstructionsShown","true")});const o=document.getElementById("btn-toggle-filter"),r=document.getElementById("route-filter-panel");o&&r&&(o.addEventListener("click",()=>{r.classList.toggle("hidden")}),window.innerWidth<=768&&(setTimeout(()=>{o.classList.add("collapsed")},3e3),o.addEventListener("mouseenter",()=>{o.classList.remove("collapsed")}),o.addEventListener("mouseleave",()=>{o.classList.add("collapsed")})));const s=document.getElementById("close-filter");s&&r&&s.addEventListener("click",()=>{r.classList.add("hidden")});const n=document.querySelector("#route-filter-panel .panel-handle");n&&r&&n.addEventListener("click",()=>{r.classList.add("hidden")});const a=document.getElementById("select-all-routes");a&&a.addEventListener("click",()=>{Ue&&(Ue.routes.forEach(e=>{const t=document.getElementById(`route-${e.route_id}`);t&&(t.checked=!0)}),gr())});const i=document.getElementById("deselect-all-routes");i&&i.addEventListener("click",()=>{Ue&&(Ue.routes.forEach(e=>{const t=document.getElementById(`route-${e.route_id}`);t&&(t.checked=!1)}),gr())}),Eo&&Eo.addEventListener("click",xo),Io&&Io.addEventListener("click",e=>{e.target===Io&&xo()}),document.addEventListener("keydown",Do),document.getElementById("btn-horaires-search-focus").addEventListener("click",()=>{const e=document.getElementById("horaires");e&&window.scrollTo({top:e.offsetTop-80,behavior:"smooth"}),Pt.focus()}),Pt.addEventListener("input",fr),Pt.addEventListener("focus",fr),Jo("hall",{submitBtn:po,fromInput:ho,toInput:mo,fromSuggestions:go,toSuggestions:fo,swapBtn:bo,whenBtn:vo,popover:yo,dateSelect:So,hourSelect:wo,minuteSelect:_o,popoverSubmitBtn:To,geolocateBtn:Lo}),Jo("results",{submitBtn:oo,fromInput:qt,toInput:Kt,fromSuggestions:Wt,toSuggestions:Vt,swapBtn:Jt,whenBtn:Yt,popover:Xt,dateSelect:Zt,hourSelect:Qt,minuteSelect:eo,popoverSubmitBtn:to,geolocateBtn:ro}),document.addEventListener("click",e=>{Nt&&!e.target.closest("#horaires-search-container")&&Nt.classList.add("hidden"),!yo||e.target.closest("#hall-planner-from")||e.target.closest("#hall-planner-to")||e.target.closest(".form-group-when")||yo.classList.contains("hidden")||(yo.classList.add("hidden"),vo.classList.remove("popover-active")),!Xt||e.target.closest("#results-planner-from")||e.target.closest("#results-planner-to")||e.target.closest(".form-group-when")||Xt.classList.contains("hidden")||(Xt.classList.add("hidden"),Yt.classList.remove("popover-active")),e.target.closest(".form-group")||(go&&(go.style.display="none"),fo&&(fo.style.display="none"),Wt&&(Wt.style.display="none"),Vt&&(Vt.style.display="none"))}),function(){const e=document.getElementById("mobile-menu-toggle"),t=document.getElementById("mobile-menu");e&&t&&(e.addEventListener("click",()=>{const o=t.classList.contains("hidden");e.classList.toggle("is-active"),t.classList.toggle("hidden"),o?document.body.classList.add("mobile-menu-open"):document.body.classList.remove("mobile-menu-open")}),t.querySelectorAll(".mobile-menu-category").forEach(e=>{e.addEventListener("click",()=>{const o="true"===e.getAttribute("aria-expanded"),r=e.nextElementSibling;t.querySelectorAll(".mobile-menu-category").forEach(t=>{if(t!==e){t.setAttribute("aria-expanded","false");const e=t.nextElementSibling;e&&e.classList.remove("is-expanded")}}),e.setAttribute("aria-expanded",!o),r.classList.toggle("is-expanded",!o)})}));document.querySelectorAll(".nav-dropdown-item[data-action]").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();Ko(e.dataset.action)})}),document.querySelectorAll(".mobile-menu-item[data-action]").forEach(o=>{o.addEventListener("click",r=>{r.preventDefault();const s=o.dataset.action;e&&e.classList.remove("is-active"),t&&t.classList.add("hidden"),document.body.classList.remove("mobile-menu-open"),Ko(s)})}),document.addEventListener("click",o=>{t&&!t.classList.contains("hidden")&&(o.target.closest("#mobile-menu")||o.target.closest("#mobile-menu-toggle")||(e.classList.remove("is-active"),t.classList.add("hidden"),document.body.classList.remove("mobile-menu-open")))})}(),zo()}async function Ko(e){switch(["itineraire","horaires","info-trafic","carte"].includes(e)&&(await async function(){return!document.getElementById("dashboard-container")&&(console.log("[Navigation] Dashboard non charg√©, rechargement..."),await Vo(),!0)}(),Co()),e){case"itineraire":dr();break;case"horaires":mr("horaires");break;case"info-trafic":mr("info-trafic");break;case"carte":lr();break;case"tarifs":case"tarifs-grille":Wo("tarifs-grille");break;case"tarifs-achat":Wo("tarifs-achat");break;case"tarifs-billettique":Wo("tarifs-billettique");break;case"tarifs-amendes":Wo("tarifs-amendes");break;default:console.log("Action non g√©r√©e:",e)}}async function Wo(e="tarifs-grille"){try{const t=await fetch(`/views/${e}.html`),o=await t.text();document.getElementById("app-view-root").innerHTML=o;const r=document.getElementById("btn-back-to-hall-tarifs");r&&r.addEventListener("click",async()=>{await Vo()}),document.querySelectorAll(".tarifs-nav-card[data-action]").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();Ko(e.dataset.action)})}),window.scrollTo(0,0)}catch(t){console.error("Erreur chargement vue Tarifs:",t)}}async function Vo(){try{await o(),Co(),qo(),ko(),Ue&&Rt&&renderFicheHoraire(),Et&&Et.classList.remove("hidden"),Ft&&Ft.classList.add("hidden"),jt&&jt.classList.add("hidden"),Mt&&Mt.classList.add("view-is-active"),At&&At.classList.remove("view-is-active"),document.body.classList.remove("view-map-locked"),document.body.classList.remove("view-is-locked"),Ue&&(ir(),renderInfoTrafic()),window.scrollTo(0,0),console.log("[main] Dashboard recharg√© depuis tarifs")}catch(e){console.error("Erreur rechargement dashboard:",e),window.location.reload()}}function Jo(e,t){et&&et.setupPlannerListeners(e,t,{onExecuteSearch:(e,t)=>async function(e,t){var o,r,n,a,i;const{fromInput:l,toInput:c,dateSelect:d,hourSelect:u,minuteSelect:p,popover:h}=t;if(console.log("üîÑ === NOUVELLE RECHERCHE ==="),!Mo||!Ao)return void alert("Veuillez s√©lectionner un point de d√©part et d'arriv√©e depuis les suggestions.");const m={type:h.querySelector(".popover-tab.active").dataset.tab,date:d.value,hour:u.value,minute:p.value},g=new Date,f=`${g.getFullYear()}-${String(g.getMonth()+1).padStart(2,"0")}-${String(g.getDate()).padStart(2,"0")}`;if(!m.date||m.date<f){m.date=f;try{d.value=f}catch(v){}}console.log("üïê Heure s√©lectionn√©e:",{date:m.date,heure:`${m.hour}:${String(m.minute).padStart(2,"0")}`,mode:m.type,hourSelectValue:u.value,hourSelectIndex:u.selectedIndex,minuteSelectValue:p.value,minuteSelectIndex:p.selectedIndex,hourOptions:null==(o=u.options)?void 0:o.length,selectedHourText:null==(n=null==(r=u.options)?void 0:r[u.selectedIndex])?void 0:n.textContent}),lt=m.type,pt={...m},ht=0,ct=[],dt=0,it=[],function(e,t){let o;o="hall"===e?{fromInput:qt,toInput:Kt,dateSelect:Zt,hourSelect:Qt,minuteSelect:eo,whenBtn:Yt,popover:Xt,popoverSubmitBtn:to}:{fromInput:ho,toInput:mo,dateSelect:So,hourSelect:wo,minuteSelect:_o,whenBtn:vo,popover:yo,popoverSubmitBtn:To};o.fromInput.value=t.fromInput.value,o.toInput.value=t.toInput.value,o.dateSelect.value=t.dateSelect.value,o.hourSelect.value=t.hourSelect.value,o.minuteSelect.value=t.minuteSelect.value,et&&"function"==typeof et.syncEnhancedTimeSelect&&(et.syncEnhancedTimeSelect(o.hourSelect),et.syncEnhancedTimeSelect(o.minuteSelect));const r=t.popover.querySelector(".popover-tab.active").dataset.tab;o.popover.querySelectorAll(".popover-tab").forEach(e=>{e.classList.toggle("active",e.dataset.tab===r)}),o.whenBtn.querySelector("span").textContent=t.whenBtn.querySelector("span").textContent,o.popoverSubmitBtn.textContent="arriver"===r?"Valider l'arriv√©e":"Partir maintenant"}(e,t),console.log(`Recherche Google API (source: ${e}):`,{from:Mo,to:Ao,time:m}),"hall"===e&&dr();tt&&tt.showSkeleton(4);zt.classList.add("hidden");try{let e=null,o=null,r=null,n=null;const l=performance.now(),[c,d]=await Promise.all([Ye.getPlaceCoords(Mo).catch(e=>(console.warn("Coords d√©part:",e),null)),Ye.getPlaceCoords(Ao).catch(e=>(console.warn("Coords arriv√©e:",e),null))]);c&&(e={lat:c.lat,lng:c.lng},c.isMultiStop&&c.gtfsStops&&(r=c.gtfsStops.map(e=>e.stopId),console.log(`üéì P√¥le multimodal origine: ${r.length} arr√™ts`))),d&&(o={lat:d.lat,lng:d.lng},d.isMultiStop&&d.gtfsStops&&(n=d.gtfsStops.map(e=>e.stopId),console.log(`üéì P√¥le multimodal destination: ${n.length} arr√™ts`))),console.log(`‚ö° Coords r√©solues en ${Math.round(performance.now()-l)}ms`);const u=(null==(a=t.fromInput)?void 0:a.value)||"",p=(null==(i=t.toInput)?void 0:i.value)||"",h=performance.now();let g=[];if(Qe)try{g=await Qe.computeHybridItinerary({fromCoords:e,toCoords:o,searchTime:m,labels:{fromLabel:u,toLabel:p},forcedStops:{from:r,to:n}}),console.log("üîç GTFS local:",(null==g?void 0:g.length)||0,"itin√©raires")}catch(v){console.warn("GTFS router error:",v)}const f=await Ye.fetchItinerary(Mo,Ao,m).catch(e=>(console.error("API Google error:",e),null));if(console.log(`‚ö° Routage termin√© en ${Math.round(performance.now()-h)}ms`),f){if(it=er(f,m),console.log("‚úÖ API Google:",(null==it?void 0:it.length)||0,"itin√©raires"),null==g?void 0:g.length)for(const t of g){it.some(e=>e.departureTime===t.departureTime&&e.arrivalTime===t.arrivalTime)||it.push(t)}}else(null==g?void 0:g.length)?(console.log("üîÑ Fallback GTFS:",g.length,"itin√©raires"),it=g):it=[];parseInt(m.hour),parseInt(m.minute);console.log("üìä Heure demand√©e:",`${m.hour}:${String(m.minute).padStart(2,"0")}`);try{await tr(it)}catch(v){console.warn("Erreur lors de l'assurance des polylines:",v)}if(it=Pe(it,m),"arriver"===m.type){const e=parseInt(m.hour)||0,t=parseInt(m.minute)||0;it=Ne(it,e,t)}it=Oe(it),console.log("üìã Apr√®s filtrage:",{mode:m.type||"partir",restants:(null==it?void 0:it.length)||0}),console.log("üìä Itin√©raires disponibles:",(null==it?void 0:it.length)||0);const y=`${m.hour}:${String(m.minute).padStart(2,"0")}`;if("arriver"===m.type){console.log(`üéØ Mode ARRIVER: tri cible ${y} (arriv√©e d√©croissante)`);const{rankArrivalItineraries:e}=await s(async()=>{const{rankArrivalItineraries:e}=await Promise.resolve().then(()=>je);return{rankArrivalItineraries:e}},void 0);ct=e([...it],m),dt=ct.length}else console.log(`üéØ Mode PARTIR: tri chrono croissant appliqu√© (base ${y})`),it=Zo(it),ct=[],dt=0;console.log("üìä Itin√©raires (ordre Google conserv√©):",it.slice(0,5).map(e=>({dep:e.departureTime,arr:e.arrivalTime,dur:e.duration}))),or(it),tt&&tt.render("ALL"),it.length>0&&(Je&&Je.map?setTimeout(()=>{Je.map.invalidateSize(),ar(it[0])},100):ar(it[0]))}catch(y){console.error("√âchec de la recherche d'itin√©raire:",y),Ut&&(Ut.innerHTML=`<p class="results-message error">Impossible de calculer l'itin√©raire. ${y.message}</p>`),zt.classList.add("hidden")}}(e,t),handleAutocomplete:Qo,getFromPlaceId:()=>Mo,setFromPlaceId:e=>{Mo=e},getToPlaceId:()=>Ao,setToPlaceId:e=>{Ao=e}})}function Yo(e){if(!e)return"null";const t=e.type||"BUS";if("BIKE"===t||"WALK"===t)return`${t}_only`;return`${t}::${(e.summarySegments||[]).map(e=>e.name||e.routeShortName||"X").join(">")}::${(e.steps||[]).filter(e=>"BUS"===e.type).map(e=>{var t;return`${e.routeShortName||(null==(t=e.route)?void 0:t.route_short_name)||""}:${(e.departureStop||"").toLowerCase().slice(0,15)}-${(e.arrivalStop||"").toLowerCase().slice(0,15)}`}).join("|")}::${e.departureTime||""}`}function Xo(e){var t;const o=null==(t=null==e?void 0:e.match)?void 0:t.call(e,/(\d{1,2}):(\d{2})/);if(!o)return 1/0;const r=parseInt(o[1],10),s=parseInt(o[2],10);return Number.isNaN(r)||Number.isNaN(s)?1/0:60*r+s}function Zo(e){const t=e.filter(e=>"BIKE"!==e.type&&"WALK"!==e.type&&!e._isBike&&!e._isWalk),o=e.filter(e=>"BIKE"===e.type||e._isBike),r=e.filter(e=>"WALK"===e.type||e._isWalk);return t.sort((e,t)=>Xo(null==e?void 0:e.departureTime)-Xo(null==t?void 0:t.departureTime)),[...t,...o,...r]}async function Qo(e,t,o){if(e.length<3)return t.innerHTML="",t.style.display="none",void o(null);try{!function(e,t,o){if(t.innerHTML="",0===e.length)return void(t.style.display="none");const r=()=>{if(!t)return null;let e=t.previousElementSibling;for(;e;){if("INPUT"===e.tagName)return e;if("function"==typeof e.querySelector){const t=e.querySelector("input");if(t)return t}e=e.previousElementSibling}let o=t.parentElement;for(;o;){const e=o.querySelector("input");if(e)return e;o=o.parentElement}return null},s=r();e.forEach(e=>{const r=document.createElement("div");r.className="suggestion-item";const n=e.description.split(",")[0],a=e.description.substring(n.length);r.innerHTML=`<strong>${n}</strong>${a}`,r.addEventListener("click",()=>{s&&(s.value=e.description),o(e.placeId),t.innerHTML="",t.style.display="none"}),t.appendChild(r)}),t.style.display="block"}(await Ye.getPlaceAutocomplete(e),t,o)}catch(r){console.warn("Erreur d'autocompl√©tion:",r),t.style.display="none"}}function er(e,t){console.log("=== D√âBUT PROCESS INTELLIGENT RESULTS ==="),console.log("üì• Mode de recherche:",(null==t?void 0:t.type)||"partir"),console.log("üì• Heure demand√©e:",`${null==t?void 0:t.hour}:${String((null==t?void 0:t.minute)||0).padStart(2,"0")}`);const o=[];if([...e.recommendations].sort((e,t)=>t.score-e.score).forEach(r=>{let s=null,n=null;if("bus"===r.mode&&e.bus?(s=e.bus.data,n=e.bus):"bike"===r.mode&&e.bike?(s=e.bike.data,n=e.bike):"walk"===r.mode&&e.walk&&(s=e.walk.data,n=e.walk),s&&n)if("bus"===r.mode){const e=(a=s)&&a.routes&&0!==a.routes.length?a.routes.map(e=>{var t,o,r,s,n,a,i,l,c,d,u,p,h,m,g,f,v,y,S,w,_,T,b,L,I,E,M;const A=e.legs[0];let C=!1;const $={type:"BUS",priority:1,departureTime:"--:--",arrivalTime:"--:--",duration:fe(e.duration),durationRaw:ve(e.duration),polyline:e.polyline,summarySegments:[],steps:[]};let k=null;for(const N of A.steps){const e=fe(N.staticDuration),g=ve(N.staticDuration),f=N.distanceMeters||0,v=(null==(o=null==(t=N.localizedValues)?void 0:t.distance)?void 0:o.text)||"",y=(null==(r=N.navigationInstruction)?void 0:r.instructions)||(null==(s=N.localizedValues)?void 0:s.instruction)||"Marcher",S=(null==(n=N.navigationInstruction)?void 0:n.maneuver)||"DEFAULT";if("WALK"===N.travelMode)k||(k={type:"WALK",icon:Le.WALK,instruction:"Marche",subSteps:[],polylines:[],totalDuration:0,totalDistanceMeters:0,departureTime:"--:--",arrivalTime:"--:--"}),k.subSteps.push({instruction:y,distance:v,duration:e,maneuver:S}),k.polylines.push(N.polyline),k.totalDuration+=g,k.totalDistanceMeters+=f;else if("TRANSIT"===N.travelMode&&N.transitDetails){const e=N.transitDetails,t=e.stopDetails||{};if(k){k.duration=fe(k.totalDuration+"s"),k.totalDistanceMeters>1e3?k.distance=`${(k.totalDistanceMeters/1e3).toFixed(1)} km`:k.distance=`${k.totalDistanceMeters} m`;const o=(null==(l=null==(i=null==(a=e.localizedValues)?void 0:a.departureTime)?void 0:i.time)?void 0:l.text)||ge(t.departureTime);k.arrivalTime=o,k.durationRaw=k.totalDuration,$.steps.push(k),k=null}const o=e.transitLine;if(o){const r=o.nameShort||"BUS";"TER"===r||"322"===r?(console.warn(`[Filtre] Trajet rejet√©: Ligne interdite ("${r}") d√©tect√©e.`),C=!0):Ue&&Ue.isLoaded&&!Ue.routesByShortName[r]&&console.log(`‚ö†Ô∏è V199: Ligne inconnue du GTFS ("${r}") mais conserv√©e.`);const s=o.color||"#3388ff",n=o.textColor||"#ffffff",a=t.departureStop||{},i=t.arrivalStop||{};let l=(t.intermediateStops||[]).map(e=>e.name||"Arr√™t inconnu");if(0===l.length&&Ue&&Ue.isLoaded){const t=a.name,o=i.name,s=e.headsign;if(t&&o&&s){const e=Ue.getIntermediateStops(r,s,t,o);e&&e.length>0&&(l=e)}}const f=(null==(u=null==(d=null==(c=e.localizedValues)?void 0:c.departureTime)?void 0:d.time)?void 0:u.text)||ge(t.departureTime),v=(null==(m=null==(h=null==(p=e.localizedValues)?void 0:p.arrivalTime)?void 0:h.time)?void 0:m.text)||ge(t.arrivalTime);$.steps.push({type:"BUS",icon:Le.BUS,routeShortName:r,routeColor:s,routeTextColor:n,instruction:`Prendre le <b>${r}</b> direction <b>${e.headsign||"destination"}</b>`,departureStop:a.name||"Arr√™t de d√©part",departureTime:f,arrivalStop:i.name||"Arr√™t d'arriv√©e",arrivalTime:v,numStops:e.stopCount||0,intermediateStops:l,duration:fe(N.staticDuration),polyline:N.polyline,durationRaw:g})}}}if(C)return null;if(k){k.duration=fe(k.totalDuration+"s"),k.totalDistanceMeters>1e3?k.distance=`${(k.totalDistanceMeters/1e3).toFixed(1)} km`:k.distance=`${k.totalDistanceMeters} m`;const e=(null==(v=null==(f=null==(g=A.localizedValues)?void 0:g.arrivalTime)?void 0:f.time)?void 0:v.text)||"--:--";k.arrivalTime=e,k.durationRaw=k.totalDuration,$.steps.push(k)}if($.steps.length>0){const e=$.steps.find(e=>e.departureTime&&"--:--"!==e.departureTime);$.departureTime=e?e.departureTime:$.steps[0].departureTime||"--:--";const t=[...$.steps].reverse().find(e=>e.arrivalTime&&"--:--"!==e.arrivalTime);$.arrivalTime=t?t.arrivalTime:$.steps[$.steps.length-1].arrivalTime||"--:--"}const B=$.steps.map(e=>"WALK"===e.type?{type:"WALK",duration:e.duration}:{type:"BUS",name:le(e.routeShortName),color:e.routeColor,textColor:e.routeTextColor,duration:e.duration}),x=$.steps.some(e=>"BUS"===e.type),D=$.steps.reduce((e,t)=>{const o="number"==typeof(null==t?void 0:t.durationRaw)?t.durationRaw:0;return e+(Number.isFinite(o)?o:0)},0);D>0&&($.durationRaw=D,$.duration=fe(`${D}s`));const R=$.steps.findIndex(e=>se(null==e?void 0:e.departureTime));if(-1!==R){let e=$.steps[R].departureTime;for(let t=R-1;t>=0;t--){const o="number"==typeof(null==(y=$.steps[t])?void 0:y.durationRaw)?$.steps[t].durationRaw:0;if(o>0){const t=he(e,o);if(!t)break;e=t}}$.departureTime=e}else if(se($.arrivalTime)&&D>0){const e=he($.arrivalTime,D);e&&($.departureTime=e)}const P=(()=>{var e;for(let t=$.steps.length-1;t>=0;t--)if(se(null==(e=$.steps[t])?void 0:e.arrivalTime))return t;return-1})();if(-1!==P){let e=$.steps[P].arrivalTime;for(let t=P+1;t<$.steps.length;t++){const o="number"==typeof(null==(S=$.steps[t])?void 0:S.durationRaw)?$.steps[t].durationRaw:0;if(o>0){const t=pe(e,o);if(!t)break;e=t}}$.arrivalTime=e}else if(se($.departureTime)&&D>0){const e=pe($.departureTime,D);e&&($.arrivalTime=e)}if(x)$.summarySegments=B.filter(e=>"BUS"===e.type);else{const e=(null==(T=null==(_=null==(w=A.localizedValues)?void 0:w.departureTime)?void 0:_.time)?void 0:T.text)||(null==(b=A.startTime)?void 0:b.text)||"--:--",t=(null==(E=null==(I=null==(L=A.localizedValues)?void 0:L.arrivalTime)?void 0:I.time)?void 0:E.text)||(null==(M=A.endTime)?void 0:M.text)||"--:--";if($.type="WALK",$.summarySegments=[],$._isWalk=!0,"--:--"!==e&&($.departureTime=e,$.steps.length)){const t=$.steps[0];t.departureTime&&"--:--"!==t.departureTime||(t.departureTime=e)}if("--:--"!==t&&($.arrivalTime=t,$.steps.length)){const e=$.steps[$.steps.length-1];e.arrivalTime&&"--:--"!==e.arrivalTime||(e.arrivalTime=t)}}return $}).filter(e=>null!==e):(console.warn("R√©ponse de l'API Routes (BUS) vide ou invalide."),[]);e.length>0&&e.forEach((e,t)=>{e.score=r.score-t,e.type||(e.type="BUS")}),o.push(...e)}else{const e=function(e,t,o,r){var s;if(!e||!e.routes||0===e.routes.length||!o)return null;const n=e.routes[0],a=null==(s=n.legs)?void 0:s[0],i=o.duration,l=o.distance,c=60*i,d="bike"===t?Le.BICYCLE:Le.WALK,u="bike"===t?"V√©lo":"Marche",p="bike"===t?"BIKE":"WALK";let h="~",m="~";if("partir"===r.type)try{let e;e="today"!==r.date&&"Aujourd'hui"!==r.date&&r.date?new Date(r.date):new Date,e.setHours(r.hour,r.minute,0,0);const t=new Date(e.getTime()+1e3*c);h=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`,m=`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}catch(f){console.warn("Erreur calcul date pour v√©lo/marche",f)}else if("arriver"===r.type)try{let e;e="today"!==r.date&&"Aujourd'hui"!==r.date&&r.date?new Date(r.date):new Date,e.setHours(r.hour,r.minute,0,0);const t=new Date(e.getTime()-1e3*c);m=`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`,h=`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}catch(f){console.warn("Erreur calcul date (arriver) pour v√©lo/marche",f)}const g={type:p,icon:d,instruction:u,distance:`${l} km`,duration:`${i} min`,subSteps:[],polylines:[],departureTime:"~",arrivalTime:"~",durationRaw:c};(null==a?void 0:a.steps)&&a.steps.forEach(e=>{var o,r,s,n,a;const i=(null==(r=null==(o=e.localizedValues)?void 0:o.distance)?void 0:r.text)||"",l=(null==(s=e.navigationInstruction)?void 0:s.instructions)||(null==(n=e.localizedValues)?void 0:n.instruction)||("bike"===t?"Continuer √† v√©lo":"Marcher"),c=fe(e.staticDuration),d=(null==(a=e.navigationInstruction)?void 0:a.maneuver)||"DEFAULT";g.subSteps.push({instruction:l,distance:i,duration:c,maneuver:d}),g.polylines.push(e.polyline)});return{type:p,departureTime:h,arrivalTime:m,duration:`${i} min`,durationRaw:c,polyline:n.polyline,summarySegments:[],steps:[g],_isBike:"bike"===t,_isWalk:"walk"===t}}(s,r.mode,n,t);e&&(e.score=r.score,"bike"===r.mode&&"BIKE"!==e.type&&(e.type="BIKE"),"walk"===r.mode&&"WALK"!==e.type&&(e.type="WALK"),o.push(e))}var a}),console.log("üìã Itin√©raires Google bruts (avant filtrage):",o.map(e=>({type:e.type,dep:e.departureTime,arr:e.arrivalTime,dur:e.duration}))),Ue&&Ue.isLoaded){let e;e=(null==t?void 0:t.date)&&"today"!==t.date&&"Aujourd'hui"!==t.date?new Date(t.date):new Date,void 0!==(null==t?void 0:t.hour)&&e.setHours(parseInt(t.hour)||0,parseInt(t.minute)||0,0,0);const r=Ue.getServiceIds(e),s=["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"][e.getDay()];if(console.log(`üìÖ V194: V√©rification pour ${s} ${e.toLocaleDateString()} - ${r.size} services actifs`),console.log("üìÖ V194: Services actifs:",Array.from(r)),0===r.size)console.warn(`‚ö†Ô∏è V194: AUCUN SERVICE ACTIF pour ${s} - Les bus ne circulent peut-√™tre pas (GTFS local)`),console.log("‚ö†Ô∏è V199: Conservation des itin√©raires Google malgr√© l'absence de services locaux");else{const e=new Set;for(const o of Ue.trips){if(Array.from(r).some(e=>Ue.serviceIdsMatch(o.service_id,e))){const t=Ue.getRoute(o.route_id);(null==t?void 0:t.route_short_name)&&(e.add(t.route_short_name.toUpperCase()),e.add(t.route_short_name.toUpperCase().replace(/\s+/g,"")))}}console.log(`üöç V194: Lignes actives ${s}:`,Array.from(e).sort().join(", "));const t=o.filter(e=>"BUS"===e.type).length,n=o.filter(t=>{if("BUS"!==t.type)return!0;const o=new Set;t.summarySegments&&t.summarySegments.forEach(e=>{e.name&&(o.add(e.name.toUpperCase()),o.add(e.name.toUpperCase().replace(/\s+/g,"")))}),t.steps&&t.steps.forEach(e=>{"BUS"===e.type&&e.lineName&&(o.add(e.lineName.toUpperCase()),o.add(e.lineName.toUpperCase().replace(/\s+/g,""))),"BUS"===e.type&&e.routeShortName&&o.add(e.routeShortName.toUpperCase())});return!Array.from(o).some(t=>e.has(t))&&o.size>0&&console.log(`‚ö†Ô∏è V199: Lignes [${Array.from(o).join(", ")}] non trouv√©es dans GTFS local pour ${s}, mais conserv√©es (Google First)`),0===o.size&&console.warn("‚ö†Ô∏è V194: Itin√©raire sans nom de ligne, conserv√© par d√©faut"),!0}),a=n.filter(e=>"BUS"===e.type).length;t!==a&&console.log(`üìä V194: ${t-a} itin√©raire(s) bus rejet√©(s) (hors service ${s})`),o.length=0,o.push(...n)}}try{if(t&&"arriver"===t.type){let e=null;e=t.date&&"today"!==t.date&&"Aujourd'hui"!==t.date?new Date(t.date):new Date;const r=parseInt(t.hour)||0,n=parseInt(t.minute)||0;e.setHours(r,n,0,0);const a=e.getTime(),i=240,l=a-60*i*1e3,c=a;console.log(`üïí Cible: ${e.toLocaleTimeString()} | Fen√™tre: ${new Date(l).toLocaleTimeString()} ‚Üí ${new Date(c).toLocaleTimeString()} ( -${i}min / +0min )`);const d=o.filter(e=>"BUS"===e.type&&e.arrivalTime&&"~"!==e.arrivalTime&&"--:--"!==e.arrivalTime),u=o.filter(e=>"BUS"!==e.type),p=t=>{if(!t||"string"!=typeof t)return NaN;const o=t.match(/(\d{1,2}):(\d{2})/);if(!o)return NaN;const r=parseInt(o[1],10),s=parseInt(o[2],10),n=new Date(e);return n.setHours(r,s,0,0),n.getTime()},h=d.map(e=>({itin:e,arrivalMs:p(e.arrivalTime)})).filter(e=>!isNaN(e.arrivalMs));let m=h.filter(e=>e.arrivalMs>=l&&e.arrivalMs<=c).map(e=>e.itin);if(console.log(`üöå Bus Google trouv√©s dans la fen√™tre : ${m.length} sur ${d.length} total`),h.length>m.length){const e=h.filter(e=>e.arrivalMs<l||e.arrivalMs>c);console.log("üìÖ Bus exclus (hors fen√™tre):",e.map(e=>({arr:e.itin.arrivalTime,ms:e.arrivalMs})))}let g=[],f=new Set;if(Ue&&Ue.isLoaded){console.log("üìÇ Recherche dans les donn√©es GTFS locales...");const t=e=>e?e.toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").replace(/[^a-z0-9]/g,"").trim():"",o=new Set;d.forEach(e=>{if(!e.steps)return;const t=[...e.steps].reverse().find(e=>"BUS"===e.type);t&&t.arrivalStop&&o.add(t.arrivalStop)}),f=new Set,o.forEach(e=>{const o=t(e);Ue.stopsByName&&Ue.stopsByName[o]?Ue.stopsByName[o].forEach(e=>f.add(e.stop_id)):Ue.stops.forEach(e=>{t(e.stop_name||"").includes(o)&&f.add(e.stop_id)})}),0===f.size?console.warn("‚ö†Ô∏è Aucun arr√™t candidat trouv√© via Google, recherche GTFS impossible."):console.log("üìç Arr√™ts candidats GTFS (IDs):",Array.from(f));const r=Ue.getServiceIds(new Date(e)),n=new Set;m.forEach(e=>{var t;n.add(`${null==(t=e.summarySegments[0])?void 0:t.name}_${e.arrivalTime}`)});for(const a of f){const t=Ue.stopTimesByStop[a]||[];for(const a of t){const t=Ue.tripsByTripId[a.trip_id];if(!t)continue;if(!Array.from(r).some(e=>Ue.serviceIdsMatch(t.service_id,e)))continue;const i=a.arrival_time||a.departure_time,u=Ue.timeToSeconds(i),p=new Date(e),h=Math.floor(u/3600),m=Math.floor(u%3600/60);p.setHours(h,m,0,0);const f=p.getTime();if(f>=l&&f<=c){const e=Ue.getRoute(t.route_id)||{},r=e.route_short_name||t.route_id,i=`${r}_${Ue.formatTime(u)}`;if(!n.has(i)){n.add(i);const l=Ue.getStopTimes(a.trip_id)||[],c=l.findIndex(e=>e.stop_id===a.stop_id);let p=null,h=new Set;try{const e=new Set;if(d.forEach(t=>{if(!t.steps)return;const o=[...t.steps].find(e=>"BUS"===e.type);o&&o.departureStop&&e.add(o.departureStop)}),e.forEach(e=>{const t=(e||"").toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").replace(/[^a-z0-9]/g,"").trim();Ue.stopsByName&&Ue.stopsByName[t]?Ue.stopsByName[t].forEach(e=>h.add(e.stop_id)):Ue.stops.forEach(t=>{(t.stop_name||"").toLowerCase().includes((e||"").toLowerCase())&&h.add(t.stop_id)})}),Ue.groupedStopMap){const e=new Set;h.forEach(t=>{Ue.groupedStopMap[t]&&Ue.groupedStopMap[t].forEach(t=>e.add(t));const o=Ue.getStop(t);o&&o.parent_station&&Ue.groupedStopMap[o.parent_station]&&Ue.groupedStopMap[o.parent_station].forEach(t=>e.add(t))}),e.forEach(e=>h.add(e))}if(c>-1){for(let e=Math.min(c-1,l.length-1);e>=0;e--)if(h.size>0&&h.has(l[e].stop_id)){p=e;break}null===p&&(p=Math.max(0,c-2))}else p=0}catch(s){console.warn("Erreur d√©termination boardingIndex GTFS, fallback utilis√©",s),p=0}const m=l[p]||l[0]||a,f=l[c]||a,v=Ue.getStop(m.stop_id)||{stop_name:m.stop_id,stop_lat:0,stop_lon:0},y=Ue.getStop(f.stop_id)||{stop_name:f.stop_id,stop_lat:0,stop_lon:0},S=500;if(h&&h.size>0)if(h.has(m.stop_id))a.trip_id,m.stop_id;else{let e=1/0;if(h.forEach(t=>{const o=Ue.getStop(t);if(o&&o.stop_lat&&o.stop_lon&&v&&v.stop_lat){const t=Ue.calculateDistance(parseFloat(o.stop_lat),parseFloat(o.stop_lon),parseFloat(v.stop_lat),parseFloat(v.stop_lon));!Number.isNaN(t)&&t<e&&(e=t)}}),e===1/0){a.trip_id,m.stop_id;continue}if(e>S){a.trip_id,m.stop_id;continue}a.trip_id,m.stop_id}const w=Ue.timeToSeconds(m.departure_time||m.arrival_time||"00:00:00"),_=Ue.timeToSeconds(f.arrival_time||f.departure_time||"00:00:00");v&&v.stop_name&&v.stop_name!==m.stop_id||a.trip_id,y&&y.stop_name&&y.stop_name!==f.stop_id||a.trip_id;let T=Ue.getRouteGeometry(t.route_id);!T&&t.shape_id&&(T=Ue.getShapeGeoJSON(t.shape_id,t.route_id));const b=(e=>e?Array.isArray(e)?e:"LineString"===e.type?e.coordinates:"MultiLineString"===e.type?e.coordinates.flat():null:null)(T);let L=null,I=null;if(b&&b.length>0){const e=Ue.findNearestPointOnRoute(b,parseFloat(v.stop_lat),parseFloat(v.stop_lon)),t=Ue.findNearestPointOnRoute(b,parseFloat(y.stop_lat),parseFloat(y.stop_lon));let o=null;null!=e&&null!=t&&(o=e<=t?b.slice(e,t+1):[...b].slice(t,e+1).reverse()),(!o||o.length<2)&&(o=[[parseFloat(v.stop_lon),parseFloat(v.stop_lat)],[parseFloat(y.stop_lon),parseFloat(y.stop_lat)]]);const r=o.map(e=>[Number(e[1]),Number(e[0])]).filter(([e,t])=>Number.isFinite(e)&&Number.isFinite(t));r.length>=2&&(I=r,L=Y(r))}const E=[];if(l&&l.length>0&&c>p){const e=l.slice(p+1,c).map(e=>{var t;return(null==(t=Ue.getStop(e.stop_id))?void 0:t.stop_name)||e.stop_id});E.push(...e)}const M={type:"BUS",icon:Le.BUS,instruction:`Prendre ${r} vers ${t.trip_headsign}`,polyline:L?{encodedPolyline:L,latLngs:I}:null,routeColor:e.route_color?`#${e.route_color}`:"#3388ff",routeTextColor:e.route_text_color?`#${e.route_text_color}`:"#ffffff",routeShortName:r,departureStop:v.stop_name||m.stop_id,arrivalStop:y.stop_name||f.stop_id,departureTime:Ue.formatTime(w),arrivalTime:Ue.formatTime(_),duration:Ue.formatDuration(Math.max(0,_-w))||"Horaires th√©oriques",intermediateStops:E,numStops:Math.max(0,c-p),_durationSeconds:Math.max(0,_-w)},A={type:"BUS",tripId:a.trip_id,trip:t,route:e,departureTime:M.departureTime||"~",arrivalTime:M.arrivalTime||Ue.formatTime(u),summarySegments:[{type:"BUS",name:r,color:e.route_color?`#${e.route_color}`:"#3388ff",textColor:e.route_text_color?`#${e.route_text_color}`:"#ffffff"}],durationRaw:M._durationSeconds||0,duration:M.duration||"Horaires th√©oriques",steps:[M]};if(t.trip_headsign){const e=(t.trip_headsign||"").toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"");if(!Array.from(o).some(t=>{if(!t)return!1;const o=t.toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"");return e.includes(o)||o.includes(e)})){a.trip_id,t.trip_headsign,Array.from(o);continue}}g.push(A)}}}}console.log(`‚úÖ Bus GTFS ajout√©s : ${g.length}`)}let v=0;m.forEach(e=>{var t;const o=`${null==(t=e.summarySegments[0])?void 0:t.name}_${e.arrivalTime}`;g.find(e=>{var t;return`${null==(t=e.summarySegments[0])?void 0:t.name}_${e.arrivalTime}`===o})});const y=[];m.forEach(e=>{y.push({itin:e,arrivalMs:p(e.arrivalTime),source:"google"})}),g.forEach(e=>{const t=p(e.arrivalTime);!isNaN(t)&&t>=l&&t<=c&&y.push({itin:e,arrivalMs:t,source:"gtfs"})}),y.sort((e,t)=>e.arrivalMs-t.arrivalMs);const S=g.filter(e=>!m.some(t=>{var o,r;return`${null==(o=t.summarySegments[0])?void 0:o.name}_${t.arrivalTime}`==`${null==(r=e.summarySegments[0])?void 0:r.name}_${e.arrivalTime}`}));o._gtfsDiagnostics={candidateStopIds:Array.from(f||[]),gtfsFound:g.length,googleFound:m.length,matched:v,missing:S.map(e=>{var t;return{route:null==(t=e.summarySegments[0])?void 0:t.name,arrival:e.arrivalTime,tripId:e.tripId}})},S.length>0?(console.warn(`‚ö†Ô∏è GTFS: ${S.length} d√©part(s) trouv√©s dans GTFS mais non propos√©s par l'API Google.`),console.table(o._gtfsDiagnostics.missing)):console.log("‚úÖ GTFS et Google coh√©rents pour cette fen√™tre."),o.length=0,y.forEach(e=>o.push(e.itin));const w=u.filter(e=>{if(!e.arrivalTime||"~"===e.arrivalTime||"--:--"===e.arrivalTime)return!1;const t=p(e.arrivalTime);return!isNaN(t)&&t>=l&&t<=c});o.push(...w)}}catch(n){console.warn("Erreur lors du filtrage par heure d'arriv√©e:",n)}null==t||t.type;let r=[...o];if(t&&"arriver"===t.type){const e=(e,t)=>{if(!e||"string"!=typeof e)return 0;const o=e.match(/(\d{1,2}):(\d{2})/);if(!o)return 0;return 60*parseInt(o[1],10)+parseInt(o[2],10)},o=60*(parseInt(t.hour)||0)+(parseInt(t.minute)||0);r.sort((t,r)=>{const s=e(t.arrivalTime),n=e(r.arrivalTime),a=s<=o;return a!==n<=o?a?-1:1:n-s}),console.log("üéØ V134: Tri ARRIVER (arriv√©e d√©croissante):",r.slice(0,5).map(e=>({arr:e.arrivalTime,dep:e.departureTime}))),ct=[...r],dt=ut,r=ct.slice(0,ut)}return r}async function tr(e){var t,o,r,s,n;if(!Array.isArray(e)||!Ue)return;!1===await Ue.ensureShapesIndexLoaded()&&console.warn("ensureItineraryPolylines: les shapes GTFS n'ont pas pu √™tre charg√©es.");for(const i of e)if(i&&Array.isArray(i.steps))for(const e of i.steps)try{if(!e||"BUS"!==e.type||_e(e))continue;if(Array.isArray(null==(t=null==e?void 0:e.polyline)?void 0:t.latLngs)&&e.polyline.latLngs.length>=2)continue;const l=i.route&&(i.route.route_id||i.routeId)||null,c=i.trip&&i.trip.shape_id||i.shapeId||null,d=Boolean(l||c||i.tripId||i.trip),u=e.polyline&&(e.polyline.encodedPolyline||e.polyline.points);if(!d&&u)continue;let p=null,h=null,m=null,g=null;try{if(e.departureStop){const t=Ue.findStopsByName&&Ue.findStopsByName(e.departureStop,3)||[];t.length&&(p=t[0])}if(e.arrivalStop){const t=Ue.findStopsByName&&Ue.findStopsByName(e.arrivalStop,3)||[];t.length&&(h=t[0])}if((!p||!h)&&i.tripId){const t=Ue.getStopTimes(i.tripId)||[];if(t.length>=1){if(!p&&e.departureTime&&"~"!==e.departureTime){const o=t.find(t=>(t.departure_time||t.arrival_time)&&(t.departure_time&&t.departure_time.startsWith(e.departureTime)||t.arrival_time&&t.arrival_time.startsWith(e.departureTime)));o&&(p=Ue.getStop(o.stop_id))}if(!h&&e.arrivalTime&&"~"!==e.arrivalTime){const o=t.find(t=>(t.arrival_time||t.departure_time)&&(t.arrival_time&&t.arrival_time.startsWith(e.arrivalTime)||t.departure_time&&t.departure_time.startsWith(e.arrivalTime)));o&&(h=Ue.getStop(o.stop_id))}!p&&e.departureStop&&-1!==e.departureStop.indexOf(":")&&(p=Ue.getStop(e.departureStop)||p),!h&&e.arrivalStop&&-1!==e.arrivalStop.indexOf(":")&&(h=Ue.getStop(e.arrivalStop)||h),!p&&t.length&&(p=Ue.getStop(t[0].stop_id)),!h&&t.length&&(h=Ue.getStop(t[t.length-1].stop_id))}}}catch(a){console.warn("ensureItineraryPolylines: erreur r√©solution arr√™ts",a)}!p&&e.departureStop&&(m=we(e.departureStop,Ue)),!h&&e.arrivalStop&&(g=we(e.arrivalStop,Ue));let f=null,v=null,y=l?Ue.getRouteGeometry(l):null;!y&&c&&(y=Ue.getShapeGeoJSON(c,l));const S=(e=>{if(!e)return null;let t=null;if(Array.isArray(e)?t=e:"LineString"===e.type?t=e.coordinates:"MultiLineString"===e.type&&(t=e.coordinates.flat()),!t)return null;const o=t.map(e=>{if(!Array.isArray(e)||e.length<2)return null;const t=parseFloat(e[0]),o=parseFloat(e[1]);return Number.isNaN(o)||Number.isNaN(t)?null:[o,t]}).filter(Boolean);return o.length>=2?o:null})(y);if(S&&S.length>=2&&p&&h){const e=(e,t,o)=>{let r=0,s=1/0;for(let n=0;n<e.length;n++){const a=Ue.calculateDistance(t,o,e[n][0],e[n][1]);a<s&&(s=a,r=n)}return r},t=e(S,parseFloat(p.stop_lat),parseFloat(p.stop_lon)),r=e(S,parseFloat(h.stop_lat),parseFloat(h.stop_lon));let s=null;null!=t&&null!=r&&t!==r&&(s=t<r?S.slice(t,r+1):[...S].slice(r,t+1).reverse()),(!s||s.length<2)&&(s=[[parseFloat(p.stop_lat),parseFloat(p.stop_lon)],[parseFloat(h.stop_lat),parseFloat(h.stop_lon)]]),v=s.map(e=>[Number(e[0]),Number(e[1])]).filter(([e,t])=>Number.isFinite(e)&&Number.isFinite(t)),f=v.length>=2?Y(v):null,console.log("ensureItineraryPolylines: polyline reconstruite depuis la g√©om√©trie",{itinId:i.tripId||(null==(o=i.trip)?void 0:o.trip_id)||null,stepRoute:l,pointCount:(null==v?void 0:v.length)||0})}if(!f){const t=p?{lat:parseFloat(p.stop_lat),lon:parseFloat(p.stop_lon)}:m?{lat:m.lat,lon:m.lng}:null,o=h?{lat:parseFloat(h.stop_lat),lon:parseFloat(h.stop_lon)}:g?{lat:g.lat,lon:g.lng}:null;let s=t,n=o;if(!s&&i.origin){const e=i.origin;e.lat&&e.lng?s={lat:e.lat,lon:e.lng}:e.latitude&&e.longitude&&(s={lat:e.latitude,lon:e.longitude})}if(!n&&i.destination){const e=i.destination;e.lat&&e.lng?n={lat:e.lat,lon:e.lng}:e.latitude&&e.longitude&&(n={lat:e.latitude,lon:e.longitude})}if(!s&&e.departureLocation){const t=e.departureLocation;void 0!==t.lat?s={lat:t.lat,lon:t.lng||t.lon}:t.latLng&&(s={lat:t.latLng.latitude,lon:t.latLng.longitude})}if(!n&&e.arrivalLocation){const t=e.arrivalLocation;void 0!==t.lat?n={lat:t.lat,lon:t.lng||t.lon}:t.latLng&&(n={lat:t.latLng.latitude,lon:t.latLng.longitude})}s&&n&&!Number.isNaN(s.lat)&&!Number.isNaN(n.lat)&&(v=[[s.lat,s.lon],[n.lat,n.lon]],f=Y(v),console.log("ensureItineraryPolylines: fallback polyline directe utilis√©e",{itinId:i.tripId||(null==(r=i.trip)?void 0:r.trip_id)||null,stepRoute:l,source:"coords-fallback"}))}f&&v&&v.length>=2?(e.polyline={encodedPolyline:f,latLngs:v},i.tripId||null==(s=i.trip)||s.trip_id):console.warn("ensureItineraryPolylines: impossible de reconstruire la polyline pour une √©tape BUS (aucune coordonn√©e fiable)",{itinId:i.tripId||(null==(n=i.trip)?void 0:n.trip_id)||null,stepRoute:l,departureStop:e.departureStop,arrivalStop:e.arrivalStop})}catch(a){console.warn("ensureItineraryPolylines error for step",a)}}function or(e){if(!zt)return;if(!e||!e.length)return void zt.classList.add("hidden");const t={ALL:zt.querySelector('[data-mode="ALL"]'),BUS:zt.querySelector('[data-mode="BUS"]'),BIKE:zt.querySelector('[data-mode="BIKE"]'),WALK:zt.querySelector('[data-mode="WALK"]')},o=e[0],r=e.find(e=>"BUS"===e.type),s=e.find(e=>"BIKE"===e.type),n=e.find(e=>"WALK"===e.type),a=(e,o,r)=>{if(!e)return;let s='<span class="mode-tab-duration empty">--</span>',n=r;o?(s=`<span class="mode-tab-duration">${o.duration}</span>`,e===t.ALL&&(n=Le.ALL),e.classList.remove("hidden")):e.classList.add("hidden"),e.innerHTML=`${n}${s}`};a(t.ALL,o,Le.ALL),a(t.BUS,r,Le.BUS),a(t.BIKE,s,Le.BICYCLE),a(t.WALK,n,Le.WALK),zt.querySelectorAll(".mode-tab").forEach(e=>{const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",()=>{zt.querySelectorAll(".mode-tab").forEach(e=>e.classList.remove("active")),t.classList.add("active");const e=t.dataset.mode;tt&&tt.render(e)})});const i=zt.querySelector('[data-mode="ALL"]');i&&i.classList.add("active"),zt.classList.remove("hidden")}function rr(e){if("BIKE"===e.type)return{color:"var(--secondary)",weight:5,opacity:.8};if("WALK"===e.type)return{color:"var(--primary)",weight:5,opacity:.8,dashArray:"10, 10"};if("BUS"===e.type){return{color:e.routeColor||"var(--primary)",weight:5,opacity:.8}}return"BICYCLE"===e.travelMode?rr({type:"BIKE"}):"WALK"===e.travelMode?rr({type:"WALK"}):"TRANSIT"===e.travelMode?rr({type:"BUS",routeColor:e.routeColor}):{color:"var(--primary)",weight:5,opacity:.8}}function sr(e,t,o){if(!(e&&Array.isArray(e.steps)&&t&&o))return;o.clearLayers();const r=e.steps.filter(e=>"BUS"===e.type&&!_e(e));if(!r.length)return void nr(e,o);const s=[];r.forEach((e,t)=>{const o=0===t,n=t===r.length-1,a=[];e.departureStop&&a.push({name:e.departureStop,role:o?"boarding":"transfer"});let i=[];Array.isArray(e.intermediateStops)&&e.intermediateStops.length>0&&(i=e.intermediateStops.map(e=>({name:"string"==typeof e?e:(null==e?void 0:e.name)||(null==e?void 0:e.stop_name)||"",lat:(null==e?void 0:e.lat)||(null==e?void 0:e.stop_lat)||null,lng:(null==e?void 0:e.lng)||(null==e?void 0:e.stop_lon)||null}))),0===i.length&&Array.isArray(e.stopTimes)&&(i=e.stopTimes.slice(1,-1).map(e=>{var t;const o=null==(t=null==Ue?void 0:Ue.getStop)?void 0:t.call(Ue,e.stop_id);return{name:(null==o?void 0:o.stop_name)||e.stop_id,lat:parseFloat(null==o?void 0:o.stop_lat)||null,lng:parseFloat(null==o?void 0:o.stop_lon)||null}})),i.forEach(e=>{e.name&&a.push({name:e.name,role:"intermediate",directLat:e.lat,directLng:e.lng})}),e.arrivalStop&&a.push({name:e.arrivalStop,role:n?"alighting":"transfer"}),a.forEach(e=>{let t=null;if(t=e.directLat&&e.directLng?{lat:e.directLat,lng:e.directLng}:we(e.name,Ue),!t)return void console.log(`‚ö†Ô∏è Coordonn√©es non trouv√©es pour: ${e.name}`);const o=`${t.lat.toFixed(5)}-${t.lng.toFixed(5)}`,r=s.find(e=>e.key===o);if(r)return _t[e.role]>_t[r.role]&&(r.role=e.role),void(r.names.includes(e.name)||r.names.push(e.name));s.push({key:o,lat:t.lat,lng:t.lng,role:e.role,names:[e.name]})})}),s.length?(s.forEach(e=>{const t=Tt(e.role);if(!t)return;let r=800;"boarding"===e.role||"alighting"===e.role?r=1200:"transfer"===e.role&&(r=1e3);const s=L.marker([e.lat,e.lng],{icon:t,zIndexOffset:r});o.addLayer(s)}),console.log(`üìç ${s.length} marqueurs ajout√©s (${s.filter(e=>"intermediate"===e.role).length} arr√™ts interm√©diaires)`)):nr(e,o)}function nr(e,t){var o;if(!e||!Array.isArray(e.steps)||!e.steps.length)return;const r=[],s=e.steps[0],n=Te("BUS"===s.type?s.polyline:null==(o=s.polylines)?void 0:o[0]);if(n&&n.length){const[e,t]=n[0];r.push({lat:e,lng:t,role:"boarding"})}e.steps.forEach((t,o)=>{if(o===e.steps.length-1)return;const s=Te("BUS"===t.type?t.polyline:Array.isArray(t.polylines)?t.polylines[t.polylines.length-1]:null);if(s&&s.length){const[e,t]=s[s.length-1];r.push({lat:e,lng:t,role:"transfer"})}});const a=e.steps[e.steps.length-1],i=Te("BUS"===a.type?a.polyline:Array.isArray(a.polylines)?a.polylines[a.polylines.length-1]:null);if(i&&i.length){const[e,t]=i[i.length-1];r.push({lat:e,lng:t,role:"alighting"})}r.forEach(e=>{const o=Tt(e.role);o&&t.addLayer(L.marker([e.lat,e.lng],{icon:o,zIndexOffset:"boarding"===e.role||"alighting"===e.role?1200:900}))})}function ar(e){if(Array.isArray(e)&&(e=e[0]),!(Je&&Je.map&&e&&e.steps))return;st&&(Je.map.removeLayer(st),st=null),at&&at.clearLayers();const t=[];if(e.steps.forEach(e=>{const o=rr(e),r=be(e);r.length&&r.forEach(e=>{const r=Te(e);if(!r||!r.length)return;const s=L.polyline(r,o);t.push(s)})}),t.length>0){st=L.featureGroup(t).addTo(Je.map),sr(e,Je.map,at);const o=st.getBounds();o&&o.isValid()&&Je.map.fitBounds(o,{padding:[20,20]})}}function ir(){let e=[],t="normal";if(0===Object.keys(ot).length)return void Bt.classList.add("hidden");for(const n in ot){const t=ot[n];if("normal"!==t.status){const o=Ue.getRoute(n);o&&e.push({name:o.route_short_name,status:t.status,message:t.message})}}if(0===e.length)return void Bt.classList.add("hidden");t=e.some(e=>"annulation"===e.status)?"annulation":e.some(e=>"perturbation"===e.status)?"perturbation":"retard",Bt.className=`type-${t}`;const o=(r=t)&&Ie[r]||Ie.default;var r;const s=e.map(e=>`<strong>Ligne ${e.name}</strong>`).join(", ");xt.innerHTML=`${o} <strong>Infos Trafic:</strong> ${s}`,Bt.classList.remove("hidden")}function lr(){Et.classList.add("hidden"),jt.classList.add("hidden"),pr(),Ft.classList.remove("hidden"),document.body.classList.add("view-map-locked"),We&&We.map&&(We.map.invalidateSize(),requestAnimationFrame(()=>{We.map.invalidateSize(),setTimeout(()=>{We.map.invalidateSize()},100)}))}function cr(){requestAnimationFrame(()=>{Ft&&Ft.classList.add("hidden"),jt&&jt.classList.add("hidden"),Et&&Et.classList.remove("hidden"),document.body.classList.remove("view-map-locked","view-is-locked","itinerary-view-active"),At&&At.classList.remove("view-is-active"),Mt&&Mt.classList.add("view-is-active"),document.querySelectorAll("#dashboard-content-view .card").forEach(e=>e.classList.remove("view-active"))}),setTimeout(()=>{pr(),Ue&&ir()},50)}function dr(){Et.classList.add("hidden"),jt.classList.remove("hidden"),pr(),Ft.classList.add("hidden"),document.body.classList.add("itinerary-view-active"),Ut&&(Ut.innerHTML='<p class="results-message">Recherche d\'itin√©raire en cours...</p>'),Je&&Je.map&&(setTimeout(()=>{Je.map.invalidateSize()},50),setTimeout(()=>{Je.map.invalidateSize(),console.log("üó∫Ô∏è Carte PC invalid√©e (300ms)")},300))}function ur(){no&&(so&&so.classList.remove("is-active"),no.classList.remove("is-active"),no.classList.remove("is-scrolled"),Oo(),document.body.classList.remove("detail-view-open"),setTimeout(()=>{pr()},380))}function pr(){no&&(no.classList.add("hidden"),no.classList.remove("is-active","is-scrolled"),lo&&(lo.classList.remove("is-dragging","sheet-height-no-transition"),null==no||no.classList.remove("sheet-is-dragging"),lo.style.removeProperty("--sheet-height")),hr(),uo&&uo.hasChildNodes()&&uo.replaceChildren(),rt&&(null==Ve?void 0:Ve.map)&&(Ve.map.removeLayer(rt),rt=null),nt&&nt.clearLayers(),so&&(so.classList.remove("is-active"),so.classList.add("hidden")))}function hr(){co&&(co.scrollTop=0,co.scrollLeft=0,requestAnimationFrame(()=>{co&&(0!==co.scrollTop&&(co.scrollTop=0),0!==co.scrollLeft&&(co.scrollLeft=0))}))}function mr(e){Mt.classList.remove("view-is-active"),At.classList.add("view-is-active"),window.scrollTo({top:0,behavior:"auto"}),document.body.classList.remove("view-map-locked"),document.body.classList.remove("view-is-locked"),Bt&&Bt.classList.add("hidden"),document.querySelectorAll("#dashboard-content-view .card").forEach(e=>{e.classList.remove("view-active")});const t=document.getElementById(e);t&&setTimeout(()=>{t.classList.add("view-active")},50)}function gr(){if(!Ue)return;Xe.clear(),Ue.routes.forEach(e=>{const t=document.getElementById(`route-${e.route_id}`);t&&t.checked&&(Xe.add(e.route_id),A.trackRouteClick(e.route_id,e.route_short_name))});const e=Ue.geoJson;e&&We.displayMultiColorRoutes(e,Ue,Xe),vr()}function fr(e){const t=e.target.value.toLowerCase();if(t.length<2)return Nt.classList.add("hidden"),void(Nt.innerHTML="");if(!Ue)return;!function(e,t){if(Nt.innerHTML="",0===e.length)return Nt.innerHTML='<div class="search-result-item">Aucun arr√™t trouv√©.</div>',void Nt.classList.remove("hidden");e.forEach(e=>{const o=document.createElement("div");o.className="search-result-item";const r=new RegExp(`(${t})`,"gi");o.innerHTML=e.stop_name.replace(r,"<strong>$1</strong>"),o.addEventListener("click",()=>function(e){lr(),We&&(We.zoomToStop(e),We.onStopClick(e));Pt.value=e.stop_name,Nt.classList.add("hidden")}(e)),Nt.appendChild(o)}),Nt.classList.remove("hidden")}(Ue.masterStops.filter(e=>e.stop_name.toLowerCase().includes(t)).slice(0,10),t)}function vr(){if(!(ze&&qe&&Ke&&We))return;const e=ze.getCurrentSeconds(),t=ze.getCurrentDate();!function(e){const t=Math.floor(e/3600)%24,o=Math.floor(e%3600/60),r=Math.floor(e%60),s=`${String(t).padStart(2,"0")}:${String(o).padStart(2,"0")}:${String(r).padStart(2,"0")}`,n=document.getElementById("current-time");n&&(n.textContent=s);const a=(new Date).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"}),i=document.getElementById("date-indicator");i&&(i.textContent=a)}(e);const o=qe.getActiveTrips(e,t),r=Ke.calculateAllPositions(o);r.forEach(e=>{var t,o,r;if(e&&e.route){const s=e.route.route_id;if(e.currentStatus=ot[s]&&ot[s].status?ot[s].status:"normal",(null==(o=null==(t=e.segment)?void 0:t.toStopInfo)?void 0:o.stop_id)&&x){const t=e.segment.toStopInfo.stop_id,o=e.segment.toStopInfo.stop_code;e.isRealtime=(null==(r=x.hasRealtimeDataForStop)?void 0:r.call(x,t,o))??!1}else e.isRealtime=!1}});const s=r.filter(e=>null!==e).filter(e=>e.route&&Xe.has(e.route.route_id));We.updateBusMarkers(s,qe,e),function(e){const t=document.getElementById("bus-count");t&&(t.innerHTML=`\n            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">\n                <circle cx="12" cy="12" r="10"/>\n            </svg>\n            ${e} bus\n        `)}(s.length,s.length)}function yr(e,t=""){const o=document.getElementById("data-status");o&&(o.className=t,o.textContent=e)}"undefined"!=typeof window&&(window.__DEBUG=Object.assign({},window.__DEBUG||{},{rankArrivalItineraries:Fe,rankDepartureItineraries:Ge,deduplicateItineraries:xe,filterExpiredDepartures:Pe,filterLateArrivals:Ne,processIntelligentResults:er,ensureItineraryPolylines:tr,computeTimeDifferenceMinutes:me,getWaitStepPresentation:function(e,t){const o=(null==e?void 0:e[t])||{},r=t>0?e[t-1]:null,s=t<e.length-1?e[t+1]:null,n=(null==r?void 0:r.arrivalTime)||o.time||o.arrivalTime||o.departureTime||(null==s?void 0:s.departureTime);let a=me(null==r?void 0:r.arrivalTime,null==s?void 0:s.departureTime);if(null===a&&"number"==typeof o._durationSeconds&&(a=Math.max(0,Math.round(o._durationSeconds/60))),null===a&&"string"==typeof o.duration){const e=o.duration.match(/(\d+)/);e&&(a=parseInt(e[1],10))}null!==a&&a<=0&&"number"==typeof o._durationSeconds&&o._durationSeconds>0&&(a=1);const i=null!==a?`${a} min`:o.duration||"Attente en cours";return{timeLabel:ie(n),durationLabel:i}},getAllFetched:()=>it,getArrivalState:()=>({lastSearchMode:lt,arrivalRankedAll:ct,arrivalRenderedCount:dt,ARRIVAL_PAGE_SIZE:ut}),_debugRender:(e="ALL")=>tt&&tt.render(e),simulateItinerarySorting:async function(){console.log("--- DEBUG PARTIR (tri croissant d√©part) ---"),console.table(Zo([{departureTime:"13:22",arrivalTime:"14:43",type:"BUS"},{departureTime:"13:25",arrivalTime:"14:49",type:"BUS"},{departureTime:"13:50",arrivalTime:"15:13",type:"BUS"},{departureTime:"14:14",arrivalTime:"15:21",type:"BUS"}]).map(e=>({dep:e.departureTime,arr:e.arrivalTime}))),console.log("--- DEBUG ARRIVER (cible 15:00, tri arriv√©e d√©croissante) ---");const e=Fe([{departureTime:"12:39",arrivalTime:"13:51",type:"BUS"},{departureTime:"13:25",arrivalTime:"14:49",type:"BUS"},{departureTime:"14:06",arrivalTime:"15:00",type:"BUS"},{departureTime:"13:50",arrivalTime:"15:13",type:"BUS"},{departureTime:"13:22",arrivalTime:"14:43",type:"BUS"}],{type:"arriver",hour:"15",minute:"00"});console.table(e.map(e=>({dep:e.departureTime,arr:e.arrivalTime})))}}));const Sr="offline-banner",wr="offline-toast";const _r=new class{constructor(){this.isOnline=navigator.onLine,this.listeners=new Set,this._banner=null,this._initialized=!1}init(){this._initialized||(this._initialized=!0,this.isOnline=navigator.onLine,this._updateUI(),window.addEventListener("online",()=>this._handleOnline()),window.addEventListener("offline",()=>this._handleOffline()),this._startConnectivityCheck(),console.log("üì∂ OfflineManager initialis√© - "+(this.isOnline?"En ligne":"Hors ligne")))}onStatusChange(e){return"function"==typeof e&&this.listeners.add(e),()=>this.listeners.delete(e)}checkOnline(){return this.isOnline}_startConnectivityCheck(){setInterval(async()=>{if(navigator.onLine)try{const e=new AbortController,t=setTimeout(()=>e.abort(),5e3),o=await fetch("/manifest.json",{method:"HEAD",cache:"no-store",signal:e.signal});clearTimeout(t),!this.isOnline&&o.ok&&this._handleOnline()}catch(e){this.isOnline&&this._handleOffline()}},3e4)}_handleOnline(){this.isOnline||(this.isOnline=!0,console.log("üåê Connexion r√©tablie"),this._updateUI(),this._showToast("Connexion r√©tablie","success"),this._notifyListeners())}_handleOffline(){this.isOnline&&(this.isOnline=!1,console.log("üì¥ Mode hors ligne"),this._updateUI(),this._notifyListeners())}_notifyListeners(){this.listeners.forEach(e=>{try{e(this.isOnline)}catch(t){console.warn("OfflineManager listener error:",t)}})}_updateUI(){this.isOnline?this._hideBanner():this._showBanner()}_showBanner(){if(document.getElementById(Sr))return;const e=document.createElement("div");e.id=Sr,e.className="offline-banner",e.innerHTML='\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <line x1="1" y1="1" x2="23" y2="23"></line>\n                <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path>\n                <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path>\n                <path d="M10.71 5.05A16 16 0 0 1 22.58 9"></path>\n                <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"></path>\n                <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>\n                <line x1="12" y1="20" x2="12.01" y2="20"></line>\n            </svg>\n            <span>Mode hors ligne - Les donn√©es GTFS restent disponibles</span>\n        ';const t=document.getElementById("main-header");t&&t.parentNode?t.parentNode.insertBefore(e,t.nextSibling):document.body.insertBefore(e,document.body.firstChild),this._banner=e}_hideBanner(){const e=document.getElementById(Sr);e&&(e.classList.add("hiding"),setTimeout(()=>e.remove(),300)),this._banner=null}_showToast(e,t="info"){const o=document.getElementById(wr);o&&o.remove();const r=document.createElement("div");r.id=wr,r.className=`offline-toast offline-toast-${t}`,r.innerHTML=`\n            <span>${"success"===t?"‚úÖ":"‚ÑπÔ∏è"}</span>\n            <span>${e}</span>\n        `,document.body.appendChild(r),setTimeout(()=>{r.classList.add("hiding"),setTimeout(()=>r.remove(),300)},3e3)}};function Tr(e,t){if(!t)return;const o=document.querySelector(e);if(o)return void o.setAttribute("content",t);const r=document.createElement("meta");if(e.startsWith('meta[name="')){const t=e.slice(11,-2);r.setAttribute("name",t)}else{if(!e.startsWith('meta[property="'))return;{const t=e.slice(15,-2);r.setAttribute("property",t)}}r.setAttribute("content",t),document.head.appendChild(r)}function br({title:e,description:t}){e&&(document.title=e),t&&Tr('meta[name="description"]',t),e&&(Tr('meta[property="og:title"]',e),Tr('meta[name="twitter:title"]',e)),t&&(Tr('meta[property="og:description"]',t),Tr('meta[name="twitter:description"]',t))}function Lr(){const e="P√©riMap",t=()=>{const{route:t,params:o}=function(){const e=(window.location.hash||"").replace(/^#/,"").trim();if(!e)return{route:"",params:new URLSearchParams};const t=e.indexOf("?");if(-1===t)return{route:e,params:new URLSearchParams};const o=e.slice(0,t),r=e.slice(t+1);return{route:o,params:new URLSearchParams(r)}}(),r=(t||"").toLowerCase(),s=(o.get("ligne")||o.get("line")||o.get("route")||"").trim(),n=s?s.toUpperCase():"";r?"horaires"!==r?"itineraire"!==r?"trafic"!==r&&"info-trafic"!==r?"carte"!==r?"tarifs"!==r&&"tarifs-grille"!==r&&"tarifs-achat"!==r&&"tarifs-billettique"!==r&&"tarifs-amendes"!==r||br({title:`${e} ‚Äî Tarifs P√©ribus`,description:`Tarifs et billetterie P√©ribus : grille, achat, billettique et amendes. Retrouvez les infos utiles sur ${e}.`}):br({title:`${e} ‚Äî Carte du r√©seau P√©ribus`,description:`Explorez la carte du r√©seau P√©ribus : lignes, arr√™ts et d√©placements autour de P√©rigueux. ${e} sur mobile et desktop.`}):br({title:`${e} ‚Äî Informations voyageurs P√©ribus`,description:`Suivez les informations voyageurs P√©ribus : perturbations, √©tat des lignes et messages trafic. Mis √† jour r√©guli√®rement sur ${e}.`}):br({title:`${e} ‚Äî Itin√©raires P√©ribus (trajets)`,description:`Calculez votre trajet P√©ribus √† P√©rigueux : itin√©raires, correspondances, marche et temps estim√©s. ${e} simplifie vos d√©placements.`}):br({title:n?`${e} ‚Äî Horaires ligne ${n} P√©ribus`:`${e} ‚Äî Liste des lignes P√©ribus`,description:n?`Consultez les horaires de la ligne ${n} P√©ribus (Grand P√©rigueux) avec ${e}. Prochains passages, arr√™ts et d√©tails de la ligne.`:`Retrouvez la liste des lignes P√©ribus et acc√©dez aux horaires par ligne avec ${e} (Grand P√©rigueux).`}):br({title:`P√©ribus - Horaires & Itin√©raires Bus P√©rigueux | ${e}`,description:`Horaires P√©ribus en temps r√©el, itin√©raires (trajets), carte du r√©seau et infos voyageurs √† P√©rigueux. ${e} : application gratuite.`})};t(),window.addEventListener("hashchange",t)}function Ir(e){if(document.getElementById("update-banner"))return;const t=document.createElement("div");t.id="update-banner",t.innerHTML='\n        <div class="update-banner-content">\n            <span>üîÑ Une nouvelle version est disponible</span>\n            <button id="update-btn" class="btn btn-primary btn-sm">Mettre √† jour</button>\n            <button id="update-dismiss" class="btn-icon-round" aria-label="Fermer">√ó</button>\n        </div>\n    ',t.style.cssText="\n        position: fixed;\n        bottom: 20px;\n        left: 50%;\n        transform: translateX(-50%);\n        background: var(--bg-main, #fff);\n        border: 2px solid var(--primary, #22c55e);\n        border-radius: 12px;\n        padding: 12px 16px;\n        box-shadow: 0 4px 20px rgba(0,0,0,0.15);\n        z-index: 10000;\n        animation: slideUp 0.3s ease;\n    ",document.body.appendChild(t),document.getElementById("update-btn").addEventListener("click",async()=>{try{const t=e||await navigator.serviceWorker.getRegistration();if(null==t?void 0:t.waiting)return void t.waiting.postMessage("skipWaiting");if(null==t?void 0:t.installing)return void t.installing.postMessage("skipWaiting");navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage("skipWaiting")}catch(t){window.location.reload()}}),document.getElementById("update-dismiss").addEventListener("click",()=>{t.remove()})}!async function(){try{!async function(){if("serviceWorker"in navigator)try{const t=await navigator.serviceWorker.register("/service-worker.js");if(console.log("[App] Service Worker enregistr√©"),t.update(),t.addEventListener("updatefound",()=>{const e=t.installing;console.log("[App] Nouvelle version du Service Worker d√©tect√©e"),e.addEventListener("statechange",()=>{if("installed"===e.state&&navigator.serviceWorker.controller){try{e.postMessage("skipWaiting")}catch(o){}Ir(t)}})}),t.waiting){try{t.waiting.postMessage("skipWaiting")}catch(e){}Ir(t)}let o=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{o||(o=!0,console.log("[App] Nouveau Service Worker actif, rechargement..."),window.location.reload())}),window.addEventListener("focus",()=>{try{t.update()}catch(e){}})}catch(t){console.warn("[App] Erreur enregistrement Service Worker:",t)}else console.log("[App] Service Worker non support√©")}(),_r.init(),Lr(),await o(),await async function(){await $o()}()}catch(e){console.error("[app] Echec du demarrage de l'interface",e)}}();
